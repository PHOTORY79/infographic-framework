<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Film Production Manager v5 (Selective Update)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-title {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .project-info {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-primary:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.2);
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 0.8rem;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        /* Navigation Panel */
        .navigation {
            width: 350px;
            background: white;
            border-right: 1px solid #e0e0e0;
            margin-top: 60px;
            overflow-y: auto;
            height: calc(100vh - 60px);
        }

        .nav-header {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .project-header h3 {
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 5px;
        }

        .project-header small {
            color: #666;
            font-size: 0.85rem;
        }

        .nav-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 15px;
        }

        .nav-controls .btn {
            font-size: 0.8rem;
            padding: 6px 12px;
        }

        .search-box {
            margin-top: 10px;
        }

        .search-box input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .nav-content {
            padding: 0;
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .sequence-item {
            border-bottom: 1px solid #f0f0f0;
        }

        .sequence-header {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.2s;
            font-weight: 500;
        }

        .sequence-header:hover {
            background-color: #f8f9fa;
        }

        .sequence-header.active {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .toggle-icon {
            font-size: 0.8rem;
            transition: transform 0.2s;
            color: #666;
        }

        .toggle-icon.expanded {
            transform: rotate(90deg);
        }

        /* Ïî¨ Ïä§ÌÉÄÏùº */
        .scenes-container {
            background-color: #fafafa;
            border-top: 1px solid #e0e0e0;
        }

        .scenes-container.collapsed {
            display: none;
        }

        .scene-item {
            border-bottom: 1px solid #e0e0e0;
        }

        .scene-header {
            padding: 12px 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.2s;
            font-size: 0.95rem;
        }

        .scene-header:hover {
            background-color: #f0f0f0;
        }

        .scene-header.active {
            background-color: #e8f5e8;
            color: #2e7d32;
        }

        /* ÏÉ∑ Ïä§ÌÉÄÏùº */
        .shots-container {
            background-color: #f5f5f5;
        }

        .shots-container.collapsed {
            display: none;
        }

        .shot-item {
            padding: 8px 60px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.9rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shot-item:hover {
            background-color: #eeeeee;
        }

        .shot-item.active {
            background-color: #fff3e0;
            color: #f57c00;
            font-weight: 500;
        }

        .shot-actions {
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .shot-item:hover .shot-actions {
            opacity: 1;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-top: 60px;
            padding: 30px;
            overflow-y: auto;
            height: calc(100vh - 60px);
        }

        .content-header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .content-subtitle {
            color: #666;
            font-size: 1rem;
        }

        .content-actions {
            display: flex;
            gap: 10px;
        }

        /* Info Section */
        .info-section {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .info-section h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
         .info-section h4 { 
            font-size: 1.05rem;
            font-weight: 600;
            color: #444;
            margin-top: 15px;
            margin-bottom: 10px;
        }


        .info-table {
            width: 100%;
            border-collapse: collapse;
        }

        .info-table th {
            text-align: left;
            padding: 10px 15px;
            background-color: #f8f9fa;
            border: 1px solid #e0e0e0;
            font-weight: 600;
            color: #555;
            width: 150px;
        }

        .info-table td {
            padding: 10px 15px;
            border: 1px solid #e0e0e0;
            color: #333;
        }

        /* ÌÉ≠ Ïä§ÌÉÄÏùº */
        .tabs {
            margin-bottom: 30px;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .tab-button {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            color: #1976d2;
            border-bottom-color: #1976d2;
            font-weight: 500;
        }

        .tab-button:hover {
            color: #1976d2;
            background-color: #f5f5f5;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ÌîÑÎ°¨ÌîÑÌä∏ Í¥ÄÎ†® Ïä§ÌÉÄÏùº (ÏùºÎ∞ò) */
        .prompt-container { 
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .prompt-title { 
            font-weight: 600;
            color: #495057;
        }

        .copy-btn { 
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.2s;
        }

        .copy-btn:hover {
            background: #218838;
        }

        .copy-btn:active {
            background: #1e7e34;
        }

        .prompt-text { 
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            white-space: pre-wrap;
            color: #495057;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.95rem;
        }

        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.95rem;
            background: white;
        }

        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.95rem;
            min-height: 80px;
            resize: vertical;
        }


        /* Ïò§ÎîîÏò§ ÏÑπÏÖò Ïä§ÌÉÄÏùº */
        .audio-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
        }

        .audio-section h4 {
            color: #495057;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9ecef;
        }

        .audio-player-area {
            min-height: 80px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed #ddd;
            margin-bottom: 15px;
        }

        .audio-content-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 10px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 0.9rem;
            line-height: 1.4;
            white-space: pre-wrap;
            color: #495057;
            min-height: 60px;
        }

        /* ÏùåÏïÖ ÌÉ≠ Ï†ÑÏö© Ïä§ÌÉÄÏùº */
        .music-ost-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .music-ost-section h4 {
            color: #495057;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #dee2e6;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .ost-prompt-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .ost-prompt-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
        }

        .ost-prompt-item .prompt-title { 
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .ost-prompt-item .prompt-text { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            white-space: pre-wrap;
            color: #495057;
            max-height: 120px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        /* Messages */
        .message-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1001;
            max-width: 400px;
        }

        .message {
            background: white;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 4px solid #2196f3;
            position: relative;
        }

        .message.success-message {
            border-left-color: #4caf50;
        }

        .message.error-message {
            border-left-color: #f44336;
        }

        .message.warning-message {
            border-left-color: #ff9800;
        }

        .close-button {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #999;
        }

        .hidden-file-input {
            display: none;
        }

        /* ÏòÅÏÉÅ ÌÉ≠ AI Ïπ¥Îìú Í∑∏Î¶¨Îìú Ïä§ÌÉÄÏùº ÏãúÏûë */
        .video-ai-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px;
            margin-top: 20px;
        }

        .ai-video-card { 
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            transition: box-shadow 0.3s ease;
        }

        .ai-video-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .ai-video-card .ai-card-header { 
            font-size: 1.2rem;
            font-weight: 600;
            padding-bottom: 10px;
            margin-bottom: 15px;
            border-bottom-width: 2px; 
            border-bottom-style: solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-video-card.luma .ai-card-header { border-color: #FF8C00; color: #FF8C00; } 
        .ai-video-card.kling .ai-card-header { border-color: #1E90FF; color: #1E90FF; } 
        .ai-video-card.veo2 .ai-card-header { border-color: #9370DB; color: #9370DB; } 
        .ai-video-card.runway .ai-card-header { border-color: #3CB371; color: #3CB371; } 

        .ai-video-card .ai-card-content {
            flex-grow: 1;
        }

        .ai-video-card .ai-prompt-area {
            margin-bottom: 15px;
        }

        .ai-video-card .prompt-text { 
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            font-size: 0.85rem; 
            max-height: 150px;
            margin-bottom: 10px;
        }

        .ai-video-card .copy-prompt-btn { 
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.2s;
            margin-bottom: 15px;
        }

        .ai-video-card .copy-prompt-btn:hover {
            background: #5a6268;
        }

        .ai-video-card .form-input { 
            padding: 8px 10px;
            font-size: 0.9rem;
        }

        .ai-video-preview {
            min-height: 150px;
            background: #f0f0f0;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
        }

        .ai-video-preview video {
            max-width: 100%;
            max-height: 250px;
            border-radius: 4px;
        }

        .ai-select-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
            width: 100%;
            margin-top: auto;
        }

        .ai-select-button:hover {
            background-color: #0056b3;
        }

        .ai-select-button.selected {
            background-color: #28a745;
            cursor: default;
        }
        
        .ai-video-card.selected-ai-card {
            border-left: 5px solid #28a745;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);
        }
        
        .ai-video-card .ai-settings-info { 
            font-size: 0.8rem;
            color: #666;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #eee;
        }
        /* ÏòÅÏÉÅ ÌÉ≠ AI Ïπ¥Îìú Í∑∏Î¶¨Îìú Ïä§ÌÉÄÏùº ÎÅù */

        /* Ïù¥ÎØ∏ÏßÄ ÌÉ≠ AI Ïπ¥Îìú Î∞è Ïù¥ÎØ∏ÏßÄ Ïä¨Î°Ø Ïä§ÌÉÄÏùº ÏãúÏûë */
        .image-ai-grid { 
            display: grid;
            grid-template-columns: 1fr; 
            gap: 30px; 
            margin-top: 20px;
        }

        .ai-image-section { 
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        }

        .ai-image-section .ai-card-header { 
            font-size: 1.3rem; 
            border-bottom-width: 2px;
            border-bottom-style: solid; 
            margin-bottom: 20px;
             display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }

        .ai-image-section.midjourney .ai-card-header { border-color: #0099FF; color: #0099FF; } 
        .ai-image-section.ideogram .ai-card-header { border-color: #FF6600; color: #FF6600; } 
        .ai-image-section.leonardo .ai-card-header { border-color: #9933CC; color: #9933CC; } 
        .ai-image-section.imagefx .ai-card-header { border-color: #00CC66; color: #00CC66; } 

        .ai-image-prompt-details {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .ai-image-prompt-details .prompt-text-label {
            font-weight: 500;
            color: #333;
            font-size: 0.95rem;
            margin-bottom: 8px;
            display: block;
        }

        .ai-image-prompt-full-text { 
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            white-space: pre-wrap;
            color: #495057;
            max-height: 180px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .ai-image-section .copy-btn { 
            margin-bottom: 0; 
            padding: 8px 15px;
        }

        .generated-images-grid { 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px dashed #e0e0e0;
        }

        .image-slot-card { 
            background: #fdfdfd;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .image-slot-preview {
            width: 100%;
            height: 180px; 
            border: 2px dashed #ccc;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            margin-bottom: 10px;
            overflow: hidden; 
        }

        .image-slot-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; 
            border-radius: 2px;
        }

        .image-slot-card .form-group {
            margin-bottom: 10px;
        }
        .image-slot-card .form-label {
            font-size: 0.85rem;
            margin-bottom: 3px;
        }
        .image-slot-card .form-input,
        .image-slot-card .form-textarea {
            font-size: 0.9rem;
            padding: 6px 8px;
        }
        .image-slot-card .form-textarea {
            min-height: 60px;
            resize: vertical;
        }

        .image-slot-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
        }
        .image-slot-actions .btn-small { 
            flex-grow: 1; 
        }

        /* Ï∞∏Ï°∞ Ïù¥ÎØ∏ÏßÄ ÏÑπÏÖò Ïä§ÌÉÄÏùº */
        .reference-image-slots-container {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ced4da;
        }
        .reference-image-slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .reference-image-slot { 
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .reference-image-slot .reference-preview { 
            width: 100%;
            height: 160px;
            margin-bottom: 12px;
            border: 2px dashed #ddd; 
            border-radius: 6px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: #f8f9fa; 
            overflow: hidden; 
        }
         .reference-image-slot .reference-preview img { 
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 4px;
        }

        .reference-image-slot .form-group {
            margin-bottom: 10px;
        }
        .reference-image-slot .form-label {
            font-size: 0.85rem;
        }
        .reference-image-slot .form-input,
        .reference-image-slot .form-select,
        .reference-image-slot .form-textarea {
            font-size: 0.9rem;
            padding: 7px 10px;
        }
        .reference-image-slot .btn-danger { 
            width: 100%;
            margin-top: 10px;
        }

        /* Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í≤å Î≥¥Í∏∞ Î™®Îã¨ */
        .image-modal {
            display: none; 
            position: fixed;
            z-index: 2000; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.85); 
            justify-content: center; 
            align-items: center; 
        }
        .image-modal-content {
            margin: auto;
            display: block;
            max-width: 85%;
            max-height: 85%;
            border-radius: 5px;
        }
        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }
        .image-modal-close:hover,
        .image-modal-close:focus {
            color: #bbb;
            text-decoration: none;
        }
        /* Ïù¥ÎØ∏ÏßÄ ÌÉ≠ AI Ïπ¥Îìú Î∞è Ïù¥ÎØ∏ÏßÄ Ïä¨Î°Ø Ïä§ÌÉÄÏùº ÎÅù */


        /* Î∞òÏùëÌòï ÎîîÏûêÏù∏ */
        @media (max-width: 768px) {
            .navigation {
                width: 100%;
                height: auto;
                position: relative;
                margin-top: 0;
            }
            
            .main-content {
                width: 100%;
                margin-top: 0;
                padding: 15px;
            }
            
            .container {
                flex-direction: column;
            }
            
            .header {
                position: relative;
            }

            .ost-prompt-grid {
                grid-template-columns: 1fr;
            }

            .video-ai-grid { 
                grid-template-columns: 1fr; 
            }
            .generated-images-grid, .reference-image-slots-grid { 
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <div class="header-title">Film Production Manager</div>
            <div class="project-info">
                <div id="project-title">ÏÉà ÌîÑÎ°úÏ†ùÌä∏</div>
                <div id="project-file" style="font-size: 0.8rem; opacity: 0.8;">ÌååÏùº: ÏóÜÏùå</div>
            </div>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" id="concept-art-btn">Ïª®ÏÖâÏïÑÌä∏ Î≥¥Í∏∞</button>
            <button class="btn btn-primary" id="import-btn">JSON Í∞ÄÏ†∏Ïò§Í∏∞</button>
            <button class="btn btn-primary" id="export-btn">JSON ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>
        </div>
    </header>

    <div class="container">
        <nav class="navigation">
            <div class="nav-header">
                <div class="project-header">
                    <h3 id="nav-project-title">ÌîÑÎ°úÏ†ùÌä∏ Î°úÎî© Ï§ë...</h3>
                    <small id="nav-project-file">ÌååÏùº: Î°úÎî© Ï§ë...</small>
                </div>
                <div class="nav-controls">
                    <button class="btn btn-secondary" id="expand-all-btn">Ï†ÑÏ≤¥ ÌéºÏπòÍ∏∞</button>
                    <button class="btn btn-secondary" id="collapse-all-btn">Ï†ÑÏ≤¥ Ï†ëÍ∏∞</button>
                </div>
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="ÏãúÌÄÄÏä§, Ïî¨, ÏÉ∑ Í≤ÄÏÉâ..." />
                </div>
            </div>
            <div class="nav-content" id="navigation-content">
                <div class="empty-state" id="nav-empty">
                    <div class="empty-state-icon">üìÅ</div>
                    <div>Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</div>
                    <div style="font-size: 0.9rem; margin-top: 10px;">JSON Í∞ÄÏ†∏Ïò§Í∏∞Î•º ÏÇ¨Ïö©Ìï¥ Îç∞Ïù¥ÌÑ∞Î•º Î°úÎìúÌï¥Ï£ºÏÑ∏Ïöî</div>
                </div>
            </div>
        </nav>

        <main class="main-content">
            <div class="content-header">
                <div>
                    <h1 class="content-title" id="content-title">ÌîÑÎ°úÏ†ùÌä∏ ÏÑ†ÌÉù</h1>
                    <p class="content-subtitle" id="content-subtitle">Ï¢åÏ∏°ÏóêÏÑú ÏãúÌÄÄÏä§, Ïî¨, ÎòêÎäî ÏÉ∑ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</p>
                </div>
                <div class="content-actions" id="content-actions" style="display: none;">
                    </div>
            </div>

            <div id="content-area">
                <div class="empty-state">
                    <div class="empty-state-icon">üé¨</div>
                    <div>ÏãúÌÄÄÏä§, Ïî¨, ÎòêÎäî ÏÉ∑ÏùÑ ÏÑ†ÌÉùÌïòÏó¨ ÏÉÅÏÑ∏ Ï†ïÎ≥¥Î•º ÌôïÏù∏ÌïòÏÑ∏Ïöî</div>
                </div>
            </div>
        </main>
    </div>

    <div id="message-container" class="message-container"></div>

    <input type="file" id="file-input" class="hidden-file-input" accept=".json">

    <script>
        console.log('üé¨ JavaScript Î°úÎî© ÏãúÏûë...');
        
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let currentData = null;
        let selectedType = null;
        let selectedId = null;
        let selectedSceneId = null;

        // ÎèôÏ†Å ÌååÏùºÎ™Ö Í¥ÄÎ¶¨
        function getProjectFileName() {
            try {
                const htmlFileName = window.location.pathname.split('/').pop();
                const baseName = htmlFileName.replace('.html', '');
                return baseName + '.json';
            } catch (error) {
                console.error('ÌååÏùºÎ™Ö ÏÉùÏÑ± Ïò§Î•ò:', error);
                return 'Film_Production_Manager.json';
            }
        }

        function getProjectName() {
            try {
                return getProjectFileName()
                    .replace('_Manager.json', '')
                    .replace('Film_Production_Manager.json', 'Film Production Manager');
            } catch (error) {
                console.error('ÌîÑÎ°úÏ†ùÌä∏Î™Ö ÏÉùÏÑ± Ïò§Î•ò:', error);
                return 'Film Production Manager';
            }
        }

        // Î©îÏãúÏßÄ ÌëúÏãú
        function showMessage(message, type) {
            console.log('Î©îÏãúÏßÄ:', message, 'ÌÉÄÏûÖ:', type);
            
            try {
                const messageContainer = document.getElementById('message-container');
                if (!messageContainer) {
                    console.error('Î©îÏãúÏßÄ Ïª®ÌÖåÏù¥ÎÑàÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                    return;
                }
                
                const messageElement = document.createElement('div');
                messageElement.className = `message ${type}-message`;
                messageElement.innerHTML = `
                    ${message}
                    <button class="close-button" onclick="this.parentElement.remove()">√ó</button>
                `;
                
                messageContainer.appendChild(messageElement);
                
                if (type !== 'error') {
                    setTimeout(() => {
                        if (messageContainer.contains(messageElement)) {
                            messageContainer.removeChild(messageElement);
                        }
                    }, 5000);
                }
            } catch (error) {
                console.error('Î©îÏãúÏßÄ ÌëúÏãú Ïò§Î•ò:', error);
                alert(message);
            }
        }

        // ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨ Ìï®Ïàò
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                return true;
            } catch (error) {
                console.error('ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨ Ïã§Ìå®:', error);
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    return true;
                } catch (fallbackError) {
                    showMessage('ÌÅ¥Î¶ΩÎ≥¥Îìú Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
                    return false;
                }
            }
        }

        // Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞
        function getDefaultData() {
            try {
                return {
                    film_id: 'FILM_NEW',
                    current_stage_name: 'scenario_breakdown',
                    timestamp: new Date().toISOString(),
                    schema_version: '1.1.0', 
                    film_metadata: {
                        title_working: getProjectName(),
                        confirmed_genre: ''
                    },
                    breakdown_data: {
                        sequences: [],
                        scenes: [],
                        shots: []
                    }
                };
            } catch (error) {
                console.error('Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± Ïò§Î•ò:', error);
                return null;
            }
        }

        // ÌÖåÏä§Ìä∏Ïö© JSON Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± Ìï®Ïàò (ÌîÑÎ°¨ÌîÑÌä∏ Ìè¨Ìï®)
        function createTestData() {
            console.log('üß™ ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± Ï§ë...');
            
            return {
                "film_id": "FILM_TEST001",
                // ... (Í∏∞Ï°¥ film_id, current_stage_name Îì±ÏùÄ Í∑∏ÎåÄÎ°ú) ...
                "film_metadata": {
                    "title_working": "ÌÖåÏä§Ìä∏ ÏòÅÌôî",
                    "confirmed_genre": "SF",
                    // ‚ñº‚ñº‚ñº ÌîÑÎ°úÏ†ùÌä∏ Ï†ÑÏ≤¥ ÏùåÏïÖ Ï†ïÎ≥¥ Ï∂îÍ∞Ä ‚ñº‚ñº‚ñº
                    "project_music_prompts": {
                        "main_ost": {
                            "style_prompt": "ÏõÖÏû•ÌïòÍ≥† ÎØ∏ÎûòÏ†ÅÏù∏ Î©îÏù∏ ÌÖåÎßà (ÌîÑÎ°úÏ†ùÌä∏ Ï†ÑÏ≤¥)",
                            "lyrics_structure_prompt": "A-B-A Íµ¨Ï°∞Ïùò Í∏∞ÏïÖÍ≥°, Î∞òÎ≥µÏ†ÅÏù∏ Î™®Ìã∞ÌîÑ ÏÇ¨Ïö©"
                        },
                        "sub_ost_1": {
                            "style_prompt": "Í∏¥Ïû•Í∞ê ÎÑòÏπòÎäî Ï∂îÍ≤©Ïî¨Ïö© ÏùåÏïÖ Ïä§ÌÉÄÏùº (ÌîÑÎ°úÏ†ùÌä∏ Ï†ÑÏ≤¥)",
                            "lyrics_structure_prompt": "Îπ†Î•∏ ÌÖúÌè¨, Ï†ÑÏûêÏùåÏïÖÍ≥º Ïò§ÏºÄÏä§Ìä∏Îùº ÌòºÌï©"
                        },
                        "sub_ost_2": {
                            "style_prompt": "Í∞êÏÑ±Ï†ÅÏù∏ Ïû•Î©¥ÏùÑ ÏúÑÌïú ÏÑúÏ†ïÏ†ÅÏù∏ ÌîºÏïÑÎÖ∏ ÏÑ†Ïú® (ÌîÑÎ°úÏ†ùÌä∏ Ï†ÑÏ≤¥)",
                            "lyrics_structure_prompt": "ÎäêÎ¶∞ ÌÖúÌè¨, ÎØ∏ÎãàÎ©ÄÌïú Íµ¨ÏÑ±"
                        }
                    },
                    "project_music_urls": { // ÌîÑÎ°úÏ†ùÌä∏ ÎåÄÌëú ÏùåÏïÖ URL (ÏòàÏãú)
                        "main_ost": "https://example.com/project_main_theme.mp3",
                        "sub_ost_1": "https://example.com/project_tension_theme.mp3",
                        "sub_ost_2": "" // ÎπÑÏõåÎëò ÏàòÎèÑ ÏûàÏùå
                    }
                    // ‚ñ≤‚ñ≤‚ñ≤ ÌîÑÎ°úÏ†ùÌä∏ Ï†ÑÏ≤¥ ÏùåÏïÖ Ï†ïÎ≥¥ Ï∂îÍ∞Ä ÎÅù ‚ñ≤‚ñ≤‚ñ≤
                },
                "breakdown_data": {
                    // ... (Í∏∞Ï°¥ source_data_references, sequences, scenes Îì±ÏùÄ Í∑∏ÎåÄÎ°ú) ...
                    "shots": [
                        {
                            "id": "S01.01",
                            // ... (Í∏∞Ï°¥ S01.01Ïùò Îã§Î•∏ ÌïÑÎìúÎì§ÏùÄ ÏµúÎåÄÌïú Ïú†ÏßÄ) ...
                            "content": {
                                "action": "Î†àÏù¥Î∏êÏù¥ Ïª¥Ìì®ÌÑ∞ ÏïûÏóê ÏïâÏïÑ ÏßëÏ§ëÌïòÎ©∞ ÌÇ§Î≥¥ÎìúÎ•º ÌÉÄÏù¥Ìïë",
                                "dialogue": {
                                    "character-1": { "text": "Ïù¥Î≤à ÏùºÏùÄ Ï¢Ä Îã§Î•¥Íµ∞...", "emotion": "ÏßëÏ§ë", "voice_style": "Ï∞®Î∂ÑÌïòÍ≥† Ïã†Ï§ëÌïú" }
                                },
                                "narration": "Í∑∏ÎÖÄÎäî Ïñ¥Îë† ÏÜçÏóêÏÑú ÎπõÏùÑ Ï∞æÍ≥† ÏûàÏóàÎã§.",
                                "sound_effects": "ÌÇ§Î≥¥Îìú ÌÉÄÏù¥Ìïë ÏÜåÎ¶¨, Ïª¥Ìì®ÌÑ∞ Ìå¨ ÏÜåÎ¶¨, ÎπóÏÜåÎ¶¨",
                                "music": "", // Ïù¥ ÌïÑÎìúÎäî Ïù¥Ï†ú shot.music_memoÎ°ú ÎåÄÏ≤¥Îê† Ïàò ÏûàÏúºÎÇò, Ìò∏ÌôòÏÑ±ÏùÑ ÏúÑÌï¥ ÎÇ®Í≤®ÎëêÍ±∞ÎÇò ÎπÑÏõåÎëò Ïàò ÏûàÏùå
                                "audio_urls": {
                                    "dialogue": "https://example.com/audio/S01.01_dialogue.mp3",
                                    "narration": "https://example.com/audio/S01.01_narration.mp3",
                                    "sound_effects": "https://example.com/audio/S01.01_sfx.mp3"
                                    // ÏÉ∑Î≥Ñ OST URLÏùÄ Ïó¨Í∏∞ÏÑú Ï†úÍ±∞ÌïòÍ≥† ÌîÑÎ°úÏ†ùÌä∏ Î†àÎ≤®ÏóêÏÑú Í¥ÄÎ¶¨
                                }
                            },
                            // ‚ñº‚ñº‚ñº ÏÉ∑Î≥Ñ ÏùåÏïÖ Î©îÎ™® Ï∂îÍ∞Ä ‚ñº‚ñº‚ñº
                            "music_memo": "Ïù¥ ÏÉ∑Ïùò Ïò§ÌîÑÎãù ÏãúÌÄÄÏä§ÏóêÎäî ÌîÑÎ°úÏ†ùÌä∏ Î©îÏù∏ ÌÖåÎßàÎ•º ÏÇ¨Ïö©ÌïúÎã§. Í∏¥Ïû•Í∞êÏùÑ ÏÑúÏÑúÌûà Í≥†Ï°∞ÏãúÌÇ§Îäî Ìé∏Í≥°.",
                            // ‚ñ≤‚ñ≤‚ñ≤ ÏÉ∑Î≥Ñ ÏùåÏïÖ Î©îÎ™® Ï∂îÍ∞Ä ÎÅù ‚ñ≤‚ñ≤‚ñ≤
                            "audio_prompts": { // Í∏∞Ï°¥ audio_prompts ÎÇ¥ music_promptsÎäî Ïù¥Ï†ú ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÏùå (ÌîÑÎ°úÏ†ùÌä∏ Î†àÎ≤®Î°ú Ïù¥Îèô)
                                "dialogue": { "prompt": "S01.01 Dialogue: ...", "settings": {} },
                                "narration": { "prompt": "S01.01 Narration: ...", "settings": {} },
                                "sound_effects": { "prompt": "S01.01 SFX: ...", "settings": {} }
                            }
                            // music_prompts ÌïÑÎìúÎäî shot Í∞ùÏ≤¥ÏóêÏÑú Ï†úÍ±∞ÌïòÍ±∞ÎÇò ÎπÑÏõåÎë† (ÌîÑÎ°úÏ†ùÌä∏ Î†àÎ≤®Î°ú Ïù¥ÎèôÌñàÏúºÎØÄÎ°ú)
                        },
                        {
                            "id": "S01.02",
                            // ... (Í∏∞Ï°¥ S01.02Ïùò Îã§Î•∏ ÌïÑÎìúÎì§ÏùÄ ÏµúÎåÄÌïú Ïú†ÏßÄ) ...
                            "content": {
                                "action": "Î†àÏù¥Î∏êÏùò ÌëúÏ†ï Î≥ÄÌôîÎ•º ÌÅ¥Î°úÏ¶àÏóÖÏúºÎ°ú Ìè¨Ï∞©",
                                "narration": "Í∑∏ÎÖÄÏùò ÎààÏóêÎäî Í≤∞ÏùòÍ∞Ä Îã¥Í≤® ÏûàÏóàÎã§.",
                                "music": "", // Ïù¥ ÌïÑÎìúÎäî Ïù¥Ï†ú shot.music_memoÎ°ú ÎåÄÏ≤¥Îê† Ïàò ÏûàÏùå
                                "audio_urls": {}
                            },
                            // ‚ñº‚ñº‚ñº ÏÉ∑Î≥Ñ ÏùåÏïÖ Î©îÎ™® Ï∂îÍ∞Ä ‚ñº‚ñº‚ñº
                            "music_memo": "Ïù¥ ÏÉ∑ÏùÄ Í∞êÏ†ïÏî¨Ïù¥ÎØÄÎ°ú ÌîÑÎ°úÏ†ùÌä∏ ÏÑúÎ∏å OST 2 (ÏÑúÏ†ïÏ†Å ÌîºÏïÑÎÖ∏)Î•º ÏÇ¨Ïö©. ÎåÄÏÇ¨ ÏóÜÏù¥ ÏùåÏïÖÍ≥º ÌëúÏ†ïÏúºÎ°ú Ï†ÑÎã¨.",
                            // ‚ñ≤‚ñ≤‚ñ≤ ÏÉ∑Î≥Ñ ÏùåÏïÖ Î©îÎ™® Ï∂îÍ∞Ä ÎÅù ‚ñ≤‚ñ≤‚ñ≤
                            "audio_prompts": {}
                        }
                    ]
                }
            };
        }
        // JSON Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        async function loadData() {
            console.log('üîÑ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÏûë...');
            try {
                const jsonFileName = getProjectFileName();
                console.log('üìÅ Ï∞æÏùÑ JSON ÌååÏùº:', jsonFileName);
                try {
                    console.log('üíæ Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄ ÌôïÏù∏...');
                    const storedData = localStorage.getItem(`breakdownData_${jsonFileName}`);
                    if (storedData) {
                        currentData = JSON.parse(storedData);
                        showMessage('Ïù¥Ï†Ñ ÏûëÏóÖ Îç∞Ïù¥ÌÑ∞Î•º Î≥µÍµ¨ÌñàÏäµÎãàÎã§.', 'info');
                        return true;
                    }
                } catch (storageError) { console.warn('‚ö†Ô∏è Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄ ÏùΩÍ∏∞ Ïã§Ìå®:', storageError.message); }
                
                if (window.location.protocol === 'http:' || window.location.protocol === 'https:') {
                    try {
                        const response = await fetch(jsonFileName);
                        if (response.ok) {
                            const data = await response.json();
                            if (data && typeof data === 'object') {
                                currentData = data;
                                saveDataToLocalStorage();
                                showMessage(`${jsonFileName} ÌååÏùºÏùÑ ÏûêÎèôÏúºÎ°ú Î°úÎìúÌñàÏäµÎãàÎã§.`, 'success');
                                return true;
                            }
                        } else { console.log(`ü§∑ ${jsonFileName} ÌååÏùº ÏóÜÏùå (${response.status})`); }
                    } catch (fetchError) { console.log('‚ùå JSON ÌååÏùº ÏûêÎèô Î°úÎìú Ïã§Ìå®:', fetchError.message); }
                } else { console.log('üìÑ file:// ÌîÑÎ°úÌÜ†ÏΩú Í∞êÏßÄÎê® - ÏûêÎèô Î°úÎìú ÏÉùÎûµ'); }
                
                currentData = createTestData();
                saveDataToLocalStorage();
                showMessage( (window.location.protocol === 'file:' ? `ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞Î°ú ÏãúÏûëÌï©ÎãàÎã§. 'JSON Í∞ÄÏ†∏Ïò§Í∏∞'Î°ú Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞Î•º Î°úÎìúÌï† Ïàò ÏûàÏäµÎãàÎã§.` : `${jsonFileName} ÌååÏùºÏù¥ ÏóÜÏñ¥ ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞Î°ú ÏãúÏûëÌï©ÎãàÎã§.`), 'info');
                return true;
            } catch (error) {
                console.error('‚ùå Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï†ÑÏ≤¥ Ïò§Î•ò:', error);
                showMessage(`Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò: ${error.message}`, 'error');
                currentData = getDefaultData();
                saveDataToLocalStorage();
                return false;
            }
        }

        // Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        function saveDataToLocalStorage() {
            try {
                if (currentData) {
                    const jsonFileName = getProjectFileName();
                    localStorage.setItem(`breakdownData_${jsonFileName}`, JSON.stringify(currentData));
                    localStorage.setItem(`lastSaved_${jsonFileName}`, new Date().toISOString());
                    console.log('Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄ Ï†ÄÏû• ÏôÑÎ£å:', JSON.parse(JSON.stringify(currentData))); // ÍπäÏùÄ Î≥µÏÇ¨Î°ú Î°úÍ∑∏ ÏàúÌôò Ï∞∏Ï°∞ Î∞©ÏßÄ
                }
            } catch (error) { console.error('Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄ Ï†ÄÏû• Ïò§Î•ò:', error); showMessage('Î°úÏª¨ Ï†ÄÏû• Ïã§Ìå®: ' + error.message, 'error'); }
        }

        // JSON ÎÇ¥Î≥¥ÎÇ¥Í∏∞
        function exportData() {
            console.log('JSON ÎÇ¥Î≥¥ÎÇ¥Í∏∞ ÏãúÏûë...');
            try {
                if (!currentData) return showMessage('Ï†ÄÏû•Ìï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.', 'error');
                const jsonFileName = getProjectFileName();
                currentData.timestamp = new Date().toISOString();
                const blob = new Blob([JSON.stringify(currentData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = jsonFileName;
                document.body.appendChild(a); a.click();
                document.body.removeChild(a); URL.revokeObjectURL(url);
                localStorage.setItem(`lastSaved_${jsonFileName}`, new Date().toISOString());
                showMessage(`${jsonFileName} ÌååÏùºÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.`, 'success');
            } catch (error) { console.error('ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Ïò§Î•ò:', error); showMessage(`ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Ïò§Î•ò: ${error.message}`, 'error'); }
        }

        // JSON Í∞ÄÏ†∏Ïò§Í∏∞
        function importData() {
            console.log('JSON Í∞ÄÏ†∏Ïò§Í∏∞ ÏãúÏûë...');
            document.getElementById('file-input')?.click();
        }
        
        // ÌååÏùº ÏÑ†ÌÉù Î∞è Î≥ëÌï©/ÎçÆÏñ¥Ïì∞Í∏∞ Ï≤òÎ¶¨
        function handleFileSelect(event) {
            console.log('ÌååÏùº ÏÑ†ÌÉù Ïù¥Î≤§Ìä∏');
            const file = event.target.files[0];
            if (!file) { console.log('ÌååÏùº ÏÑ†ÌÉù Ï∑®ÏÜåÎê®'); return; }

            console.log('ÏÑ†ÌÉùÎêú ÌååÏùº:', file.name);
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const newData = JSON.parse(e.target.result);
                    let updated = false;

                    // ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÍ±∞ÎÇò, Í∞ÄÏ†∏Ïò® Îç∞Ïù¥ÌÑ∞Í∞Ä Ï†ÑÏ≤¥ Íµ¨Ï°∞Î•º Í∞ÄÏßÄÍ≥† ÏûàÎã§Î©¥ (sequences ÌïÑÎìú Í∏∞Ï§Ä) Ï†ÑÏ≤¥ ÎçÆÏñ¥Ïì∞Í∏∞
                    if (!currentData || (newData.breakdown_data && newData.breakdown_data.sequences)) {
                        console.log('Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞Î°ú ÎçÆÏñ¥ÏîÅÎãàÎã§.');
                        currentData = newData;
                        updated = true;
                        showMessage('JSON Îç∞Ïù¥ÌÑ∞Î•º Ï†ÑÏ≤¥ Î°úÎìúÌñàÏäµÎãàÎã§.', 'success');
                    } 
                    // Ïä§ÌÖåÏù¥ÏßÄ 8 Ïò§ÎîîÏò§ Îç∞Ïù¥ÌÑ∞ ÎòêÎäî Í∏∞ÌÉÄ Ï†ÑÏ≤¥ Íµ¨Ï°∞ÏóêÏÑú Ïò§ÎîîÏò§Îßå Î≥ëÌï©Ìï† Í≤ΩÏö∞
                    else if (newData.current_stage_name === "audio_prompt_generation" || (newData.film_metadata && newData.breakdown_data && newData.breakdown_data.shots && newData.breakdown_data.shots[0] && newData.breakdown_data.shots[0].audio_prompts)) {
                        console.log('üéß Ïä§ÌÖåÏù¥ÏßÄ 8 ÌòïÏãù ÎòêÎäî Ïò§ÎîîÏò§ ÌîÑÎ°¨ÌîÑÌä∏ Ìè¨Ìï® Îç∞Ïù¥ÌÑ∞ Î≥ëÌï©ÏùÑ ÏãúÎèÑÌï©ÎãàÎã§.');
                        if (!currentData || !currentData.breakdown_data || !currentData.breakdown_data.shots) {
                            showMessage('Ïò§ÎîîÏò§ Îç∞Ïù¥ÌÑ∞Î•º Î≥ëÌï©ÌïòÎ†§Î©¥ Î®ºÏ†Ä Í∏∞Î≥∏ ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞(Ïòà: Ïä§ÌÖåÏù¥ÏßÄ5)Î•º Î°úÎìúÌï¥Ïïº Ìï©ÎãàÎã§.', 'warning');
                            event.target.value = ''; // ÌååÏùº ÏûÖÎ†• Ï¥àÍ∏∞Ìôî
                            return; // Ìï®Ïàò Ï¢ÖÎ£å ÎòêÎäî Îã§Î•∏ Ï≤òÎ¶¨ ÌïÑÏöî
                        }

                        // Ïó¨Í∏∞Ïóê Í∏∞Ï°¥ currentDataÏóê newDataÏùò Ïò§ÎîîÏò§ Í¥ÄÎ†® Ï†ïÎ≥¥Îßå Î≥ëÌï©ÌïòÎäî ÏÉÅÏÑ∏ Î°úÏßÅÏù¥ Îì§Ïñ¥Í∞à Í±∞Ïïº.
                        // ÏßÄÍ∏àÏùÄ Íµ¨Ï°∞Îßå Ïû°ÏïÑÎëêÍ≥†, Îã§Ïùå Îã®Í≥ÑÏóêÏÑú Ìï®Íªò Ï±ÑÏõåÎÇòÍ∞à Í±∞ÎãàÍπå Í±±Ï†ï Îßà!
                        console.log('üöß Ïò§ÎîîÏò§ Îç∞Ïù¥ÌÑ∞ ÏÉÅÏÑ∏ Î≥ëÌï© Î°úÏßÅÏùÄ Îã§Ïùå Îã®Í≥ÑÏóêÏÑú Íµ¨ÌòÑ ÏòàÏ†ïÏûÖÎãàÎã§.');

                        // ÏòàÏãú: ÏòÅÌôî Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ Ï§ë ÏùåÏïÖ Í¥ÄÎ†® Ï†ïÎ≥¥ Î≥ëÌï© (ÎßåÏïΩ newDataÏóê ÏûàÎã§Î©¥)
                        if (newData.film_metadata && newData.film_metadata.project_music_prompts) {
                            if (!currentData.film_metadata) currentData.film_metadata = {};
                            currentData.film_metadata.project_music_prompts = { ...currentData.film_metadata.project_music_prompts, ...newData.film_metadata.project_music_prompts };
                            updated = true;
                        }
                        if (newData.film_metadata && newData.film_metadata.project_music_urls) {
                            if (!currentData.film_metadata) currentData.film_metadata = {};
                            currentData.film_metadata.project_music_urls = { ...currentData.film_metadata.project_music_urls, ...newData.film_metadata.project_music_urls };
                            updated = true;
                        }

                        // ÏòàÏãú: Í∞Å ÏÉ∑Ïùò Ïò§ÎîîÏò§ Í¥ÄÎ†® Ï†ïÎ≥¥ Î≥ëÌï©
                        if (newData.breakdown_data && newData.breakdown_data.shots) {
                            newData.breakdown_data.shots.forEach(newShotData => {
                                const shotIdToFind = newShotData.id;
                                const existingShot = currentData.breakdown_data.shots.find(shot => shot.id === shotIdToFind);

                                if (existingShot) {
                                    // audio_prompts Î≥ëÌï©
                                    if (newShotData.audio_prompts) {
                                        if (!existingShot.audio_prompts) existingShot.audio_prompts = {};
                                        for (const key in newShotData.audio_prompts) {
                                            existingShot.audio_prompts[key] = { ...(existingShot.audio_prompts[key] || {}), ...newShotData.audio_prompts[key] };
                                        }
                                        updated = true;
                                    }
                                    // content ÎÇ¥ Ïò§ÎîîÏò§ Í¥ÄÎ†® ÌïÑÎìú Î≥ëÌï© (dialogue, narration, sound_effects, audio_urls)
                                    if (newShotData.content) {
                                        if (!existingShot.content) existingShot.content = {};
                                        if (newShotData.content.dialogue) { // dialogueÎäî Í∞ùÏ≤¥Ïù¥ÎØÄÎ°ú ÎçÆÏñ¥Ïì∞Í∏∞ ÎòêÎäî ÏÑ∏Î∂Ä Î≥ëÌï© ÌïÑÏöî
                                            existingShot.content.dialogue = { ...existingShot.content.dialogue, ...newShotData.content.dialogue };
                                            updated = true;
                                        }
                                        if (newShotData.content.narration !== undefined) {
                                            existingShot.content.narration = newShotData.content.narration;
                                            updated = true;
                                        }
                                        if (newShotData.content.sound_effects !== undefined) { // ÏùåÌñ• Ìö®Í≥º ÏÑ§Î™Ö
                                            existingShot.content.sound_effects = newShotData.content.sound_effects;
                                            updated = true;
                                        }
                                        if (newShotData.content.audio_urls) { // audio_urls Í∞ùÏ≤¥ Î≥ëÌï©
                                            if (!existingShot.content.audio_urls) existingShot.content.audio_urls = {};
                                            existingShot.content.audio_urls = { ...existingShot.content.audio_urls, ...newShotData.content.audio_urls };
                                            updated = true;
                                        }
                                    }
                                    // music_memo Î≥ëÌï©
                                    if (newShotData.music_memo !== undefined) {
                                        existingShot.music_memo = newShotData.music_memo;
                                        updated = true;
                                    }
                                }
                            });
                        }

                        if (updated) {
                             currentData.timestamp = new Date().toISOString(); // Î≥ÄÍ≤ΩÏÇ¨Ìï≠Ïù¥ ÏûàÏùÑ ÎïåÎßå ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ ÏóÖÎç∞Ïù¥Ìä∏
                            showMessage('Ïò§ÎîîÏò§ Í¥ÄÎ†® Ï†ïÎ≥¥Î•º ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞Ïóê ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î≥ëÌï©ÌñàÏäµÎãàÎã§.', 'success');
                        } else {
                            showMessage('Ïò§ÎîîÏò§ Î≥ëÌï©ÏùÑ ÏãúÎèÑÌñàÏúºÎÇò, Î≥ÄÍ≤ΩÎêú ÎÇ¥Ïö©Ïù¥ ÏóÜÍ±∞ÎÇò ÎåÄÏÉÅ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏßÄ Î™ªÌñàÏäµÎãàÎã§.', 'info');
                        }
                    }

                    // Í∞ÄÏ†∏Ïò® Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÉ∑ Ï§ëÏã¨Ïùò ÏóÖÎç∞Ïù¥Ìä∏ Îç∞Ïù¥ÌÑ∞Ïùº Í≤ΩÏö∞ (shot_prompts ÎòêÎäî breakdown_data.shots Ï°¥Ïû¨ Í∏∞Ï§Ä)
                    // (Ïä§ÌÖåÏù¥ÏßÄ 6 Ïä§ÌÇ§ÎßàÎäî shot_prompts, Ïä§ÌÖåÏù¥ÏßÄ 7 Ïä§ÌÇ§ÎßàÎäî breakdown_data.shots ÏïàÏóê video_prompts Îì±ÏùÑ Ìè¨Ìï®)
                    else if ((newData.shot_prompts || (newData.breakdown_data && newData.breakdown_data.shots)) && 
                               currentData && currentData.breakdown_data && currentData.breakdown_data.shots) {
                        console.log('ÏÉ∑ Í∏∞Î∞ò Îç∞Ïù¥ÌÑ∞ Î≥ëÌï©ÏùÑ ÏãúÎèÑÌï©ÎãàÎã§.');
                        const shotsToUpdate = newData.shot_prompts || newData.breakdown_data.shots;

                        shotsToUpdate.forEach(newShotData => {
                            // Ïä§ÌÖåÏù¥ÏßÄ 6ÏùÄ shot_id, Ïä§ÌÖåÏù¥ÏßÄ 7ÏùÄ id Î•º ÏÇ¨Ïö©ÌïòÎØÄÎ°ú Îëò Îã§ ÌôïÏù∏
                            const shotIdToFind = newShotData.shot_id || newShotData.id; 
                            const existingShot = currentData.breakdown_data.shots.find(shot => shot.id === shotIdToFind);

                            if (existingShot) {
                                console.log(`ÏÉ∑ ID ${shotIdToFind}Ïóê ÎåÄÌïú Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë...`);
                                // Ïä§ÌÖåÏù¥ÏßÄ 6Ïùò ai_promptsÎ•º existingShot.image_promptsÎ°ú Î≥ëÌï©
                                if (newShotData.ai_prompts) {
                                    if (!existingShot.image_prompts) existingShot.image_prompts = {};
                                    Object.keys(newShotData.ai_prompts).forEach(aiKey => {
                                        existingShot.image_prompts[aiKey] = { ...existingShot.image_prompts[aiKey], ...newShotData.ai_prompts[aiKey] };
                                    });
                                    console.log(`  - image_prompts ÏóÖÎç∞Ïù¥Ìä∏Îê®.`);
                                    updated = true;
                                }
                                // Ïä§ÌÖåÏù¥ÏßÄ 7Ïùò video_prompts, video_urls, final_video_selection, video_design Î≥ëÌï©
                                ['video_prompts', 'video_urls', 'final_video_selection', 'video_design'].forEach(videoKey => {
                                    if (newShotData[videoKey]) {
                                        existingShot[videoKey] = { ...existingShot[videoKey], ...newShotData[videoKey] };
                                        console.log(`  - ${videoKey} ÏóÖÎç∞Ïù¥Ìä∏Îê®.`);
                                        updated = true;
                                    }
                                });
                                // Ïä§ÌÖåÏù¥ÏßÄ 7Ïùò image_design (Ïä§ÌÖåÏù¥ÏßÄ 5 Íµ¨Ï°∞) Ï≤òÎ¶¨ - HTMLÏùò ai_generated_imagesÏôÄÎäî Î≥ÑÍ∞úÎ°ú, ÏûàÎã§Î©¥ ÏóÖÎç∞Ïù¥Ìä∏
                                if (newShotData.image_design && newShotData.image_design.images) { // Ïä§ÌÖåÏù¥ÏßÄ 5/7Ïùò images[]
                                    if (!existingShot.image_design) existingShot.image_design = {};
                                    existingShot.image_design.images = newShotData.image_design.images;
                                    // ÎßåÏïΩ HTMLÏùò ai_generated_imagesÎèÑ Ïù¥ Îç∞Ïù¥ÌÑ∞ Í∏∞Ï§ÄÏúºÎ°ú Ï±ÑÏõåÏïº ÌïúÎã§Î©¥ Ï∂îÍ∞Ä Î°úÏßÅ ÌïÑÏöî
                                    console.log(`  - image_design.images ÏóÖÎç∞Ïù¥Ìä∏Îê®.`);
                                    updated = true;
                                }
                                // Ï∞∏Ï°∞ Ïù¥ÎØ∏ÏßÄ Î≥ëÌï©
                                if (newShotData.reference_images) {
                                    existingShot.reference_images = newShotData.reference_images;
                                    console.log(`  - reference_images ÏóÖÎç∞Ïù¥Ìä∏Îê®.`);
                                    updated = true;
                                }
                                 // Í∏∞ÌÉÄ content, camera_ Îì±Îì±Ïùò ÌïÑÎìúÎèÑ ÌïÑÏöîÏãú Î≥ëÌï©
                                ['content', 'camera_movement', 'camera_framing', 'camera_effects', 'other_info'].forEach(key => {
                                    if (newShotData[key]) {
                                        existingShot[key] = { ...existingShot[key], ...newShotData[key] };
                                        updated = true;
                                    }
                                });
                            } else {
                                console.warn(`Í∞ÄÏ†∏Ïò® Îç∞Ïù¥ÌÑ∞Ïùò ÏÉ∑ ID ${shotIdToFind}Î•º ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞ÏóêÏÑú Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.`);
                            }
                        });
                        if(updated) showMessage('Í∞ÄÏ†∏Ïò® JSONÏùò ÏÉ∑ Ï†ïÎ≥¥Î•º ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞Ïóê Î≥ëÌï©/ÏóÖÎç∞Ïù¥Ìä∏ÌñàÏäµÎãàÎã§.', 'success');
                        else showMessage('Í∞ÄÏ†∏Ïò® JSONÏóêÏÑú ÏóÖÎç∞Ïù¥Ìä∏Ìï† ÏÉ∑ Ï†ïÎ≥¥Î•º Ï∞æÏßÄ Î™ªÌñàÍ±∞ÎÇò, Î≥ÄÍ≤ΩÏÇ¨Ìï≠Ïù¥ ÏóÜÏäµÎãàÎã§.', 'info');

                    } else {
                        showMessage('Í∞ÄÏ†∏Ïò® JSON ÌååÏùºÏùò Íµ¨Ï°∞Î•º Ïù∏ÏãùÌï† Ïàò ÏóÜÍ±∞ÎÇò, ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞ÏôÄ Î≥ëÌï©Ìï† Ïàò ÏóÜÏäµÎãàÎã§.', 'warning');
                        event.target.value = ''; // ÌååÏùº ÏûÖÎ†• Ï¥àÍ∏∞Ìôî
                        return; 
                    }

                    saveDataToLocalStorage();
                    updateUI(); 
                    // Î≥ëÌï© ÌõÑ ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÏÉ∑Ïù¥ ÏûàÎã§Î©¥ Ìï¥Îãπ ÌÉ≠ Îã§Ïãú Î°úÎìú
                    if (selectedType === 'shot' && selectedId) {
                        showShotContent(selectedId);
                        const lastActiveTab = localStorage.getItem(`shot_${selectedId}_activeTab`) || 'info';
                        setTimeout(() => switchTab(lastActiveTab, selectedId), 0);
                    }

                } catch (parseError) {
                    console.error('JSON ÌååÏã± Ïò§Î•ò:', parseError);
                    showMessage(`JSON ÌååÏã± Ïò§Î•ò: ${parseError.message}`, 'error');
                }
            };
            reader.onerror = function() {
                console.error('ÌååÏùº ÏùΩÍ∏∞ Ïò§Î•ò');
                showMessage('ÌååÏùº ÏùΩÍ∏∞ Ïò§Î•ò', 'error');
            };
            reader.readAsText(file);
            event.target.value = ''; 
        }


        // Í≤ÄÏÉâ Í∏∞Îä•
        function searchNavigation() {
            const searchInput = document.getElementById('search-input');
            const searchTerm = searchInput.value.toLowerCase();
            if (!currentData || !currentData.breakdown_data) return;
            const sequenceItems = document.querySelectorAll('.sequence-item');
            sequenceItems.forEach(item => {
                const sequenceText = item.textContent.toLowerCase();
                const isVisible = searchTerm === '' || sequenceText.includes(searchTerm);
                item.style.display = isVisible ? 'block' : 'none';
                if (isVisible && searchTerm !== '') {
                    const scenesContainer = item.querySelector('.scenes-container');
                    if (scenesContainer && scenesContainer.classList.contains('collapsed')) {
                        item.querySelector('.sequence-header').click(); 
                    }
                }
            });
        }

        // Ï†ÑÏ≤¥ ÌéºÏπòÍ∏∞/Ï†ëÍ∏∞
        function expandAll() {
            document.querySelectorAll('.sequence-header').forEach(header => {
                const sequenceId = header.dataset.sequenceId;
                const scenesContainer = document.getElementById(`scenes-${sequenceId}`);
                if (scenesContainer && scenesContainer.classList.contains('collapsed')) {
                    header.click(); // selectSequenceÍ∞Ä Ìò∏Ï∂úÎêòÎ©¥ÏÑú ÌÜ†Í∏Ä Î∞è Î°úÎìú
                }
            });
            setTimeout(() => {
                 document.querySelectorAll('.scene-header').forEach(header => {
                    const sceneId = header.dataset.sceneId;
                    const shotsContainer = document.getElementById(`shots-${sceneId}`);
                    if (shotsContainer && shotsContainer.classList.contains('collapsed')) {
                       header.click(); // selectSceneÏù¥ Ìò∏Ï∂úÎêòÎ©¥ÏÑú ÌÜ†Í∏Ä Î∞è Î°úÎìú
                    }
                });
            }, 400); 
        }

        function collapseAll() {
            // ÏÉ∑ Î®ºÏ†Ä Ï†ëÍ∏∞ (Ïî¨ÏùÑ Ï†ëÏúºÎ©¥ ÏÉ∑ÎèÑ Í∞ôÏù¥ Ï†ëÌûò)
            document.querySelectorAll('.scene-header').forEach(header => {
                const sceneId = header.dataset.sceneId;
                const shotsContainer = document.getElementById(`shots-${sceneId}`);
                if (shotsContainer && !shotsContainer.classList.contains('collapsed')) {
                    header.click();
                }
            });
            // ÏãúÌÄÄÏä§ Ï†ëÍ∏∞
            setTimeout(() => { // Ïî¨Ïù¥ ÏôÑÏ†ÑÌûà Ï†ëÌûå ÌõÑ ÏãúÌÄÄÏä§ Ï†ëÍ∏∞
                document.querySelectorAll('.sequence-header').forEach(header => {
                    const sequenceId = header.dataset.sequenceId;
                    const scenesContainer = document.getElementById(`scenes-${sequenceId}`);
                    if (scenesContainer && !scenesContainer.classList.contains('collapsed')) {
                       header.click();
                    }
                });
            }, 400);
        }

        // UI ÏóÖÎç∞Ïù¥Ìä∏
        function updateUI() {
            console.log('UI ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë...');
            try {
                updateHeaderInfo();
                updateNavigation();
                if (selectedId && selectedType) {
                    if (selectedType === 'shot') showShotContent(selectedId);
                    else if (selectedType === 'scene') showSceneContent(selectedId);
                    else if (selectedType === 'sequence') showSequenceContent(selectedId);
                } else {
                     document.getElementById('content-area').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üé¨</div>
                            <div>ÏãúÌÄÄÏä§, Ïî¨, ÎòêÎäî ÏÉ∑ÏùÑ ÏÑ†ÌÉùÌïòÏó¨ ÏÉÅÏÑ∏ Ï†ïÎ≥¥Î•º ÌôïÏù∏ÌïòÏÑ∏Ïöî</div>
                        </div>`;
                }
                console.log('UI ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
            } catch (error) { console.error('UI ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', error); showMessage('ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò: ' + error.message, 'error'); }
        }

        // Ìó§Îçî Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
        function updateHeaderInfo() {
            try {
                const projectName = getProjectName();
                const jsonFileName = getProjectFileName();
                const projectTitleEl = document.getElementById('project-title');
                const projectFileEl = document.getElementById('project-file');
                const navProjectTitleEl = document.getElementById('nav-project-title');
                const navProjectFileEl = document.getElementById('nav-project-file');
                if (projectTitleEl) projectTitleEl.textContent = currentData?.film_metadata?.title_working || projectName;
                if (projectFileEl) projectFileEl.textContent = `ÌååÏùº: ${jsonFileName}`;
                if (navProjectTitleEl) navProjectTitleEl.textContent = currentData?.film_metadata?.title_working || projectName;
                if (navProjectFileEl) navProjectFileEl.textContent = `ÌååÏùº: ${jsonFileName}`;
            } catch (error) { console.error('Ìó§Îçî ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', error); }
        }

        // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÏóÖÎç∞Ïù¥Ìä∏
        function updateNavigation() {
            try {
                const navContent = document.getElementById('navigation-content');
                if (!navContent) return console.error('ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Ïª®ÌÖêÏ∏† ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                if (!currentData || !currentData.breakdown_data || !currentData.breakdown_data.sequences || currentData.breakdown_data.sequences.length === 0) {
                    navContent.innerHTML = `<div class="empty-state" id="nav-empty"><div class="empty-state-icon">üìÅ</div><div>Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</div><div style="font-size: 0.9rem; margin-top: 10px;">JSON Í∞ÄÏ†∏Ïò§Í∏∞Î•º ÏÇ¨Ïö©Ìï¥ Îç∞Ïù¥ÌÑ∞Î•º Î°úÎìúÌï¥Ï£ºÏÑ∏Ïöî</div></div>`;
                    return;
                }
                let html = '';
                currentData.breakdown_data.sequences.forEach(sequence => {
                    html += `<div class="sequence-item"><div class="sequence-header" data-sequence-id="${sequence.id}"><span class="toggle-icon">‚ñ∂</span><span>${sequence.id}: ${sequence.title}</span></div><div class="scenes-container collapsed" id="scenes-${sequence.id}"></div></div>`;
                });
                navContent.innerHTML = html;
                setupSequenceEventListeners();
            } catch (error) { console.error('ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:', error); showMessage('ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò: ' + error.message, 'error'); }
        }

        // ÏãúÌÄÄÏä§ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        function setupSequenceEventListeners() {
            try {
                document.querySelectorAll('.sequence-header[data-sequence-id]').forEach(header => {
                    const newHeader = header.cloneNode(true); header.parentNode.replaceChild(newHeader, header);
                    newHeader.addEventListener('click', function(e) { e.preventDefault(); selectSequence(this.getAttribute('data-sequence-id'), this); });
                });
            } catch (error) { console.error('ÏãúÌÄÄÏä§ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï Ïò§Î•ò:', error); }
        }

        // ÏãúÌÄÄÏä§ ÏÑ†ÌÉù Î∞è ÌÜ†Í∏Ä
        function selectSequence(sequenceId, headerElement = null) {
            try {
                const newlySelected = selectedId !== sequenceId || selectedType !== 'sequence';
                selectedType = 'sequence'; selectedId = sequenceId;
                document.querySelectorAll('.sequence-header.active, .scene-header.active, .shot-item.active').forEach(el => el.classList.remove('active'));
                const currentHeader = headerElement || document.querySelector(`.sequence-header[data-sequence-id="${sequenceId}"]`);
                if (currentHeader) currentHeader.classList.add('active');
                showSequenceContent(sequenceId);
                toggleSequenceScenes(sequenceId, newlySelected);
            } catch (error) { console.error('ÏãúÌÄÄÏä§ ÏÑ†ÌÉù Ïò§Î•ò:', error); showMessage('ÏãúÌÄÄÏä§ ÏÑ†ÌÉù Ïò§Î•ò: ' + error.message, 'error'); }
        }

        // ÏãúÌÄÄÏä§Ïùò Ïî¨Îì§ ÌÜ†Í∏Ä
        function toggleSequenceScenes(sequenceId, forceOpen = false) {
            try {
                const scenesContainer = document.getElementById(`scenes-${sequenceId}`); if (!scenesContainer) return;
                const toggleIcon = scenesContainer.previousElementSibling.querySelector('.toggle-icon'); if (!toggleIcon) return;
                if (forceOpen || scenesContainer.classList.contains('collapsed')) {
                    scenesContainer.classList.remove('collapsed'); toggleIcon.classList.add('expanded'); toggleIcon.textContent = '‚ñº';
                    loadScenesForSequence(sequenceId, scenesContainer);
                } else {
                    scenesContainer.classList.add('collapsed'); toggleIcon.classList.remove('expanded'); toggleIcon.textContent = '‚ñ∂';
                }
            } catch (error) { console.error('Ïî¨ ÌÜ†Í∏Ä Ïò§Î•ò:', error); }
        }

        // ÏãúÌÄÄÏä§Ïùò Ïî¨Îì§ Î°úÎìú
        function loadScenesForSequence(sequenceId, container) {
            try {
                if (!currentData || !currentData.breakdown_data) return;
                const scenes = currentData.breakdown_data.scenes.filter(scene => scene.sequence_id === sequenceId);
                if (scenes.length === 0) { container.innerHTML = '<div style="padding: 15px 40px; color: #999; font-size: 0.9rem;">Ïî¨Ïù¥ ÏóÜÏäµÎãàÎã§</div>'; return; }
                let html = '';
                scenes.forEach(scene => { html += `<div class="scene-item"><div class="scene-header" data-scene-id="${scene.id}"><span class="toggle-icon">‚ñ∑</span><span>${scene.id}: ${scene.title}</span></div><div class="shots-container collapsed" id="shots-${scene.id}"></div></div>`; });
                container.innerHTML = html;
                container.querySelectorAll('.scene-header').forEach(header => {
                    const newHeader = header.cloneNode(true); header.parentNode.replaceChild(newHeader, header);
                    newHeader.addEventListener('click', function(e){ e.stopPropagation(); selectScene(this.dataset.sceneId, this); });
                });
            } catch (error) { console.error('Ïî¨ Î°úÎìú Ïò§Î•ò:', error); }
        }

        // Ïî¨ ÏÑ†ÌÉù
        function selectScene(sceneId, headerElement = null) {
            try {
                const newlySelected = selectedId !== sceneId || selectedType !== 'scene';
                selectedType = 'scene'; selectedId = sceneId; selectedSceneId = sceneId;
                document.querySelectorAll('.scene-header.active, .shot-item.active').forEach(el => el.classList.remove('active'));
                const scene = currentData.breakdown_data.scenes.find(s => s.id === sceneId);
                if (scene) document.querySelector(`.sequence-header[data-sequence-id="${scene.sequence_id}"]`)?.classList.add('active');
                const currentHeader = headerElement || document.querySelector(`.scene-header[data-scene-id="${sceneId}"]`);
                if(currentHeader) currentHeader.classList.add('active');
                showSceneContent(sceneId);
                toggleSceneShots(sceneId, newlySelected);
            } catch (error) { console.error('Ïî¨ ÏÑ†ÌÉù Ïò§Î•ò:', error); showMessage('Ïî¨ ÏÑ†ÌÉù Ïò§Î•ò: ' + error.message, 'error'); }
        }

        // Ïî¨Ïùò ÏÉ∑Îì§ ÌÜ†Í∏Ä
        function toggleSceneShots(sceneId, forceOpen = false) {
            try {
                const shotsContainer = document.getElementById(`shots-${sceneId}`); if(!shotsContainer) return;
                const toggleIcon = shotsContainer.previousElementSibling.querySelector('.toggle-icon'); if(!toggleIcon) return;
                if (forceOpen || shotsContainer.classList.contains('collapsed')) {
                    shotsContainer.classList.remove('collapsed'); toggleIcon.classList.add('expanded'); toggleIcon.textContent = '‚ñΩ';
                    loadShotsForScene(sceneId, shotsContainer);
                } else {
                    shotsContainer.classList.add('collapsed'); toggleIcon.classList.remove('expanded'); toggleIcon.textContent = '‚ñ∑';
                }
            } catch (error) { console.error('ÏÉ∑ ÌÜ†Í∏Ä Ïò§Î•ò:', error); }
        }

        // Ïî¨Ïùò ÏÉ∑Îì§ Î°úÎìú
        function loadShotsForScene(sceneId, container) {
            try {
                if (!currentData || !currentData.breakdown_data) return;
                const shots = currentData.breakdown_data.shots.filter(shot => shot.scene_id === sceneId);
                if (shots.length === 0) { container.innerHTML = '<div style="padding: 15px 60px; color: #999; font-size: 0.9rem;">ÏÉ∑Ïù¥ ÏóÜÏäµÎãàÎã§</div>'; return; }
                let html = '';
                shots.forEach(shot => { html += `<div class="shot-item" data-shot-id="${shot.id}"><span>${shot.id}: ${shot.title}</span></div>`; });
                container.innerHTML = html;
                 container.querySelectorAll('.shot-item').forEach(item => {
                    const newItem = item.cloneNode(true); item.parentNode.replaceChild(newItem, item);
                    newItem.addEventListener('click', function(e){ e.stopPropagation(); selectShot(this.dataset.shotId, this); });
                });
            } catch (error) { console.error('ÏÉ∑ Î°úÎìú Ïò§Î•ò:', error); }
        }

        // ÏÉ∑ ÏÑ†ÌÉù
        function selectShot(shotId, element = null) {
            try {
                selectedType = 'shot'; selectedId = shotId;
                document.querySelectorAll('.shot-item.active').forEach(el => el.classList.remove('active'));
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
                if (shot) {
                    const scene = currentData.breakdown_data.scenes.find(sc => sc.id === shot.scene_id);
                    if (scene) {
                        document.querySelector(`.scene-header[data-scene-id="${scene.id}"]`)?.classList.add('active');
                        document.querySelector(`.sequence-header[data-sequence-id="${scene.sequence_id}"]`)?.classList.add('active');
                    }
                }
                const currentElement = element || document.querySelector(`.shot-item[data-shot-id="${shotId}"]`);
                if(currentElement) currentElement.classList.add('active');
                showShotContent(shotId);
            } catch (error) { console.error('ÏÉ∑ ÏÑ†ÌÉù Ïò§Î•ò:', error); showMessage('ÏÉ∑ ÏÑ†ÌÉù Ïò§Î•ò: ' + error.message, 'error'); }
        }

        // ÏãúÌÄÄÏä§ ÎÇ¥Ïö© ÌëúÏãú
        function showSequenceContent(sequenceId) {
            try {
                const sequence = currentData.breakdown_data.sequences.find(s => s.id === sequenceId);
                if (!sequence) return console.error('ÏãúÌÄÄÏä§Î•º Ï∞æÏùÑ Ïàò ÏóÜÏùå:', sequenceId);
                document.getElementById('content-title').textContent = `ÏãúÌÄÄÏä§: ${sequence.title}`;
                document.getElementById('content-subtitle').textContent = `ID: ${sequence.id}`;
                document.getElementById('content-actions').style.display = 'none';
                document.getElementById('content-area').innerHTML = `<div class="info-section"><h3>ÏãúÌÄÄÏä§ Ï†ïÎ≥¥</h3><table class="info-table"><tr><th>ID</th><td>${sequence.id}</td></tr><tr><th>Ï†úÎ™©</th><td>${sequence.title}</td></tr><tr><th>Í∏∞Îä•</th><td>${sequence.function || '-'}</td></tr><tr><th>ÏÑ§Î™Ö</th><td>${sequence.description || '-'}</td></tr><tr><th>ÏòàÏÉÅ Í∏∏Ïù¥</th><td>${sequence.duration_estimate || '-'}</td></tr></table></div>`;
            } catch (error) { console.error('ÏãúÌÄÄÏä§ ÎÇ¥Ïö© ÌëúÏãú Ïò§Î•ò:', error); showMessage('ÏãúÌÄÄÏä§ ÎÇ¥Ïö© ÌëúÏãú Ïò§Î•ò: ' + error.message, 'error'); }
        }

        // Ïî¨ ÎÇ¥Ïö© ÌëúÏãú
        function showSceneContent(sceneId) {
            try {
                const scene = currentData.breakdown_data.scenes.find(s => s.id === sceneId);
                if (!scene) return console.error('Ïî¨ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå:', sceneId);
                document.getElementById('content-title').textContent = `Ïî¨: ${scene.title}`;
                document.getElementById('content-subtitle').textContent = `ID: ${scene.id}`;
                document.getElementById('content-actions').style.display = 'none';
                document.getElementById('content-area').innerHTML = `<div class="info-section"><h3>Ïî¨ Ï†ïÎ≥¥</h3><table class="info-table"><tr><th>ID</th><td>${scene.id}</td></tr><tr><th>Ï†úÎ™©</th><td>${scene.title}</td></tr><tr><th>ÏÜåÏÜç ÏãúÌÄÄÏä§</th><td>${scene.sequence_id || '-'}</td></tr><tr><th>ÏÑ§Î™Ö</th><td>${scene.description || '-'}</td></tr></table></div>
                    ${scene.visual_consistency_info ? `<div class="info-section"><h3>ÎπÑÏ£ºÏñº Ï†ïÎ≥¥</h3><table class="info-table"><tr><th>Ïû•ÏÜå ID</th><td>${scene.visual_consistency_info.location_id || '-'}</td></tr><tr><th>Ï∫êÎ¶≠ÌÑ∞ ID</th><td>${(scene.visual_consistency_info.character_ids || []).join(', ') || '-'}</td></tr><tr><th>ÏÜåÌíà ID</th><td>${(scene.visual_consistency_info.prop_ids || []).join(', ') || '-'}</td></tr></table></div>` : ''}`;
            } catch (error) { console.error('Ïî¨ ÎÇ¥Ïö© ÌëúÏãú Ïò§Î•ò:', error); showMessage('Ïî¨ ÎÇ¥Ïö© ÌëúÏãú Ïò§Î•ò: ' + error.message, 'error'); }
        }

        // ÏÉ∑ ÎÇ¥Ïö© ÌëúÏãú (ÌÉ≠ Ìè¨Ìï®)
        function showShotContent(shotId) {
            try {
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
                if (!shot) return console.error('ÏÉ∑ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå:', shotId);
                document.getElementById('content-title').textContent = `ÏÉ∑: ${shot.title}`;
                document.getElementById('content-subtitle').textContent = `ID: ${shot.id}`;
                document.getElementById('content-actions').style.display = 'none';
                const lastActiveTab = localStorage.getItem(`shot_${shotId}_activeTab`) || 'info';
                document.getElementById('content-area').innerHTML = `
                    <div class="tabs">
                        <div class="tab-buttons">
                            <button class="tab-button ${lastActiveTab === 'info' ? 'active' : ''}" onclick="switchTab('info', '${shotId}')">Ï†ïÎ≥¥</button>
                            <button class="tab-button ${lastActiveTab === 'image' ? 'active' : ''}" onclick="switchTab('image', '${shotId}')">Ïù¥ÎØ∏ÏßÄ</button>
                            <button class="tab-button ${lastActiveTab === 'video' ? 'active' : ''}" onclick="switchTab('video', '${shotId}')">ÏòÅÏÉÅ</button>
                            <button class="tab-button ${lastActiveTab === 'audio' ? 'active' : ''}" onclick="switchTab('audio', '${shotId}')">Ïò§ÎîîÏò§</button>
                            <button class="tab-button ${lastActiveTab === 'music' ? 'active' : ''}" onclick="switchTab('music', '${shotId}')">ÏùåÏïÖ</button>
                        </div>
                        <div id="tab-info" class="tab-content ${lastActiveTab === 'info' ? 'active' : ''}" style="display: ${lastActiveTab === 'info' ? 'block' : 'none'};">${createShotInfoTab(shot)}</div>
                        <div id="tab-image" class="tab-content ${lastActiveTab === 'image' ? 'active' : ''}" style="display: ${lastActiveTab === 'image' ? 'block' : 'none'};">${createShotImageTab(shot)}</div>
                        <div id="tab-video" class="tab-content ${lastActiveTab === 'video' ? 'active' : ''}" style="display: ${lastActiveTab === 'video' ? 'block' : 'none'};">${createShotVideoTab(shot)}</div>
                        <div id="tab-audio" class="tab-content ${lastActiveTab === 'audio' ? 'active' : ''}" style="display: ${lastActiveTab === 'audio' ? 'block' : 'none'};">${createShotAudioTab(shot)}</div>
                        <div id="tab-music" class="tab-content ${lastActiveTab === 'music' ? 'active' : ''}" style="display: ${lastActiveTab === 'music' ? 'block' : 'none'};">${createShotMusicTab(shot)}</div>
                    </div>`;
            } catch (error) { console.error('ÏÉ∑ ÎÇ¥Ïö© ÌëúÏãú Ïò§Î•ò:', error); showMessage('ÏÉ∑ ÎÇ¥Ïö© ÌëúÏãú Ïò§Î•ò: ' + error.message, 'error'); }
        }

        // ÌÉ≠ Ï†ÑÌôò
        function switchTab(tabName, shotId = null) { 
            try {
                const tabContainer = document.querySelector('.tabs'); if (!tabContainer) return;
                tabContainer.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                tabContainer.querySelectorAll('.tab-content').forEach(content => { content.style.display = 'none'; content.classList.remove('active'); });
                const activeButton = tabContainer.querySelector(`[onclick*="switchTab('${tabName}'"]`);
                const activeContent = document.getElementById(`tab-${tabName}`);
                if (activeButton) activeButton.classList.add('active');
                if (activeContent) { activeContent.style.display = 'block'; activeContent.classList.add('active');}
                if (shotId) localStorage.setItem(`shot_${shotId}_activeTab`, tabName);
            } catch (error) { console.error('ÌÉ≠ Ï†ÑÌôò Ïò§Î•ò:', error); showMessage('ÌÉ≠ Ï†ÑÌôò Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error'); }
        }

        // ÏÉ∑ Ï†ïÎ≥¥ ÌÉ≠ ÏÉùÏÑ±
        function createShotInfoTab(shot) {
            return `
                <div class="info-section"><h3>Í∏∞Î≥∏ Ï†ïÎ≥¥</h3><table class="info-table"><tr><th>ID</th><td>${shot.id}</td></tr><tr><th>Ï†úÎ™©</th><td>${shot.title}</td></tr><tr><th>ÏÜåÏÜç Ïî¨</th><td>${shot.scene_id || '-'}</td></tr><tr><th>ÏÉ∑ Ïú†Ìòï</th><td>${shot.shot_type || '-'}</td></tr><tr><th>ÏÑ§Î™Ö</th><td>${shot.description || '-'}</td></tr><tr><th>ÏòàÏÉÅ Í∏∏Ïù¥</th><td>${shot.other_info?.estimated_duration || '-'}Ï¥à</td></tr></table></div>
                <div class="info-section"><h3>Î©îÎ™®</h3><textarea class="form-textarea" placeholder="Ïù¥ ÏÉ∑Ïóê ÎåÄÌïú Î©îÎ™®..." onchange="updateShotMemo('${shot.id}', this.value)">${getShotMemo(shot.id)}</textarea><small style="color:#666;font-size:0.85rem;">Î©îÎ™®Îäî ÏûêÎèôÏúºÎ°ú Ï†ÄÏû•Îê©ÎãàÎã§.</small></div>
                ${shot.visual_consistency_info ? `<div class="info-section"><h3>ÎπÑÏ£ºÏñº ÏùºÍ¥ÄÏÑ± Ï†ïÎ≥¥</h3><table class="info-table"><tr><th>Ïû•ÏÜå ID</th><td>${shot.visual_consistency_info.location_id || '-'}</td></tr><tr><th>Ï∫êÎ¶≠ÌÑ∞ ID</th><td>${(shot.visual_consistency_info.character_ids || []).join(', ') || '-'}</td></tr><tr><th>ÏÜåÌíà ID</th><td>${(shot.visual_consistency_info.prop_ids || []).join(', ') || '-'}</td></tr></table></div>` : ''}
                ${shot.camera_framing ? `<div class="info-section"><h3>Ïπ¥Î©îÎùº Ï†ïÎ≥¥</h3><table class="info-table"><tr><th>ÌîÑÎ†àÏù¥Î∞ç</th><td>${shot.camera_framing.framing || '-'}</td></tr><tr><th>ÏïµÍ∏Ä</th><td>${shot.camera_framing.angle || '-'}</td></tr><tr><th>ÏãúÏ†ê Î∞©Ìñ•</th><td>${shot.camera_framing.view_direction || '-'}</td></tr><tr><th>Íµ¨ÎèÑ</th><td>${shot.camera_framing.composition || '-'}</td></tr></table></div>` : ''}
                ${shot.content ? `<div class="info-section"><h3>ÏΩòÌÖêÏ∏†</h3><table class="info-table"><tr><th>Ïï°ÏÖò</th><td>${shot.content.action || '-'}</td></tr><tr><th>ÏùåÌñ• Ìö®Í≥º</th><td>${shot.content.sound_effects || '-'}</td></tr><tr><th>ÎÇòÎ†àÏù¥ÏÖò</th><td>${shot.content.narration || '-'}</td></tr></table></div>` : ''}`;
        }

        // ÏÉ∑ Ïù¥ÎØ∏ÏßÄ ÌÉ≠ ÏÉùÏÑ± (4Í∞ú AI ÏÑπÏÖò Î∞è AIÎ≥Ñ Ïù¥ÎØ∏ÏßÄ 3Í∞ú Ïä¨Î°Ø Î∞©Ïãù)
        function createShotImageTab(shot) {
            console.log('üñºÔ∏è createShotImageTab ÏãúÏûë (4 AI ÏÑπÏÖò Î∞©Ïãù)');
            try {
                const imagePrompts = shot.image_prompts || {};
                const aiGeneratedImages = shot.image_design?.ai_generated_images || {};
                const referenceImagesData = shot.reference_images || [];

                const imageAIs = [ { id: 'midjourney', name: 'Midjourney' }, { id: 'ideogram', name: 'Ideogram' }, { id: 'leonardo', name: 'Leonardo' }, { id: 'imagefx', name: 'ImageFX' } ];
                let aiSectionsHtml = imageAIs.map(ai => {
                    const currentAiPrompts = imagePrompts[ai.id] || {};
                    const mainPrompt = currentAiPrompts.main_prompt || 'ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.';
                    const parameters = currentAiPrompts.parameters || '';
                    const fullPromptForCopy = `${mainPrompt}${parameters ? ` ${parameters}` : ''}`.replace(/'/g, "&#39;").replace(/"/g, "&quot;").replace(/\n/g, "\\n");
                    let imageSlotsHtml = '';
                    for (let i = 0; i < 3; i++) { 
                        const imageSlotData = aiGeneratedImages[ai.id]?.[i] || { url: '', description: '' };
                        const uniqueSlotId = `${shot.id}-${ai.id}-img${i}`;
                        imageSlotsHtml += `
                            <div class="image-slot-card" id="slot-card-${uniqueSlotId}">
                                <div class="image-slot-preview" id="slot-preview-${uniqueSlotId}">${imageSlotData.url ? `<img src="${imageSlotData.url}" alt="${ai.name} Ïù¥ÎØ∏ÏßÄ ${i+1}" onerror="this.style.display='none'; this.parentElement.innerHTML = '<div style=&quot;color: #999; font-size: 0.8rem;&quot;>Î°úÎìú Ïã§Ìå®</div>';">` : `<div style="color: #999; font-size: 0.8rem;">URL ÏûÖÎ†•</div>`}</div>
                                <div class="form-group"><label class="form-label" for="slot-url-${uniqueSlotId}">URL:</label><input type="text" class="form-input" id="slot-url-${uniqueSlotId}" value="${imageSlotData.url || ''}" placeholder="${ai.name} ${i+1} URL" onchange="updateAIGeneratedImageUrl('${shot.id}', '${ai.id}', ${i}, this.value)"></div>
                                <div class="form-group"><label class="form-label" for="slot-desc-${uniqueSlotId}">ÏÑ§Î™Ö:</label><textarea class="form-textarea" id="slot-desc-${uniqueSlotId}" placeholder="${ai.name} ${i+1} ÏÑ§Î™Ö" onchange="updateAIGeneratedImageDescription('${shot.id}', '${ai.id}', ${i}, this.value)">${imageSlotData.description || ''}</textarea></div>
                                <div class="image-slot-actions"><button class="btn btn-small btn-secondary" onclick="openImageModal('${imageSlotData.url || ''}')" ${!imageSlotData.url ? 'disabled' : ''}>ÌÅ¨Í≤å Î≥¥Í∏∞</button></div>
                            </div>`;
                    }
                    return `
                        <div class="ai-image-section ${ai.id}" id="ai-section-${shot.id}-${ai.id}">
                            <div class="ai-card-header">${ai.name}</div>
                            <div class="ai-image-prompt-details">
                                <label class="prompt-text-label">AI ÏÉùÏÑ± ÌîÑÎ°¨ÌîÑÌä∏ (ÌîÑÎ°¨ÌîÑÌä∏ + ÌååÎùºÎØ∏ÌÑ∞):</label>
                                <div class="ai-image-prompt-full-text">${mainPrompt}${parameters ? ` <br><strong style='font-family: inherit; font-size:0.9em; color:#555'>Parameters:</strong> ${parameters}` : ''}</div>
                                <button class="copy-btn" onclick="copyImageAIPrompt('${fullPromptForCopy}', '${ai.name}')">Ï†ÑÏ≤¥ ÌîÑÎ°¨ÌîÑÌä∏ Î≥µÏÇ¨</button>
                            </div>
                            <h4>ÏÉùÏÑ±Îêú Ïù¥ÎØ∏ÏßÄ (ÏµúÎåÄ 3Í∞ú)</h4><div class="generated-images-grid">${imageSlotsHtml}</div>
                        </div>`;
                }).join('');
                let referenceSlotsHtml = '';
                for (let i = 0; i < 3; i++) {
                    const refData = referenceImagesData[i] || { url: '', description: '', type: 'composition' };
                    const uniqueRefId = `${shot.id}-ref${i}`;
                    referenceSlotsHtml += `
                        <div class="reference-image-slot" id="ref-slot-card-${uniqueRefId}">
                             <div class="reference-preview" id="ref-preview-${uniqueRefId}">${refData.url ? `<img src="${refData.url}" alt="Ï∞∏Ï°∞ ${i+1}" onerror="this.style.display='none'; this.parentElement.innerHTML = '<div style=&quot;color:#999;font-size:0.8rem;&quot;>Î°úÎìú Ïã§Ìå®</div>';">` : `<div style="color:#999;font-size:0.8rem;">Ï∞∏Ï°∞ ${i+1} URL</div>`}</div>
                            <div class="form-group"><label class="form-label" for="ref-url-${uniqueRefId}">URL:</label><input type="text" class="form-input" id="ref-url-${uniqueRefId}" value="${refData.url || ''}" placeholder="Ï∞∏Ï°∞ ${i+1} URL" onchange="updateReferenceImage('${shot.id}', ${i}, 'url', this.value)"></div>
                            <div class="form-group"><label class="form-label" for="ref-desc-${uniqueRefId}">ÏÑ§Î™Ö:</label><textarea class="form-textarea" id="ref-desc-${uniqueRefId}" onchange="updateReferenceImage('${shot.id}', ${i}, 'description', this.value)" placeholder="Ï∞∏Ï°∞ ${i+1} ÏÑ§Î™Ö">${refData.description || ''}</textarea></div>
                            <div class="form-group"><label class="form-label" for="ref-type-${uniqueRefId}">Ïú†Ìòï:</label><select class="form-select" id="ref-type-${uniqueRefId}" onchange="updateReferenceImage('${shot.id}', ${i}, 'type', this.value)">
                                <option value="composition" ${refData.type === 'composition' ? 'selected' : ''}>Íµ¨ÎèÑ</option><option value="style" ${refData.type === 'style' ? 'selected' : ''}>Ïä§ÌÉÄÏùº</option><option value="appearance" ${refData.type === 'appearance' ? 'selected' : ''}>Ïô∏Ìòï</option><option value="lighting" ${refData.type === 'lighting' ? 'selected' : ''}>Ï°∞Î™Ö</option><option value="mood" ${refData.type === 'mood' ? 'selected' : ''}>Î∂ÑÏúÑÍ∏∞</option></select></div>
                            <button class="btn btn-small btn-danger" onclick="clearReferenceImageSlot('${shot.id}', ${i})">Ïù¥ Ïä¨Î°Ø ÎπÑÏö∞Í∏∞</button>
                        </div>`;
                }
                return `
                    <div class="info-section"><h3>üé® AI Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Î∞è Í¥ÄÎ¶¨</h3><p style="font-size:0.9em;color:#555;margin-bottom:20px;">Í∞Å AI ÎèÑÍµ¨Î≥Ñ ÌîÑÎ°¨ÌîÑÌä∏Î•º ÌôïÏù∏ÌïòÍ≥†, ÏÉùÏÑ±Îêú Ïù¥ÎØ∏ÏßÄÎ•º ÏµúÎåÄ 3Í∞úÍπåÏßÄ Îì±Î°ù Î∞è Í¥ÄÎ¶¨ÌïòÏÑ∏Ïöî.</p><div class="image-ai-grid">${aiSectionsHtml}</div></div>
                    <div class="info-section reference-image-slots-container"><h3>üñºÔ∏è Ï∞∏Ï°∞ Ïù¥ÎØ∏ÏßÄ (3Í∞ú Ïä¨Î°Ø)</h3><p style="font-size:0.9em;color:#555;margin-bottom:20px;">Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± Ïãú Ï∞∏Í≥†Ìï† Ïù¥ÎØ∏ÏßÄÎ•º Îì±Î°ùÌïòÏÑ∏Ïöî.</p><div class="reference-image-slots-grid">${referenceSlotsHtml}</div></div>
                    <div id="imageDisplayModal" class="image-modal" onclick="closeImageModal(event)"><span class="image-modal-close" onclick="closeImageModal(event)">&times;</span><img class="image-modal-content" id="modalImageContent"></div>`;
            } catch (error) { console.error('‚ùå createShotImageTab Ïò§Î•ò:', error); return `<div class="info-section"><h3>Ïù¥ÎØ∏ÏßÄ ÌÉ≠ Î°úÎìú Ïò§Î•ò</h3><p>${error.message}</p></div>`; }
        }

        // AI Ïù¥ÎØ∏ÏßÄ ÌîÑÎ°¨ÌîÑÌä∏ (ÌîÑÎ°¨ÌîÑÌä∏+ÌååÎùºÎØ∏ÌÑ∞) Î≥µÏÇ¨ Ìï®Ïàò
        function copyImageAIPrompt(fullPrompt, aiName) {
            const actualFullPrompt = fullPrompt.replace(/\\n/g, "\n");
            if (!actualFullPrompt || actualFullPrompt.trim() === 'ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.') return showMessage(`${aiName} ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä ÎπÑÏñ¥ Î≥µÏÇ¨ Î∂àÍ∞Ä.`, 'warning');
            copyToClipboard(actualFullPrompt).then(ok => ok && showMessage(`${aiName} Ï†ÑÏ≤¥ ÌîÑÎ°¨ÌîÑÌä∏ Î≥µÏÇ¨Îê®.`, 'success'));
        }

        // AIÎ≥Ñ ÏÉùÏÑ± Ïù¥ÎØ∏ÏßÄ URL ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateAIGeneratedImageUrl(shotId, aiType, imageIndex, newUrl) {
            try {
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId); if (!shot) return showMessage('ÏÉ∑ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå.', 'error');
                if (!shot.image_design) shot.image_design = { aspect_ratio: "16:9" };
                if (!shot.image_design.ai_generated_images) shot.image_design.ai_generated_images = {};
                if (!shot.image_design.ai_generated_images[aiType]) shot.image_design.ai_generated_images[aiType] = [null,null,null].map(()=>({url:'', description:''}));
                if (imageIndex < 3) {
                    if (!shot.image_design.ai_generated_images[aiType][imageIndex]) shot.image_design.ai_generated_images[aiType][imageIndex] = { url: newUrl, description: '' };
                    else shot.image_design.ai_generated_images[aiType][imageIndex].url = newUrl;
                }
                saveDataToLocalStorage();
                const uid = `${shotId}-${aiType}-img${imageIndex}`;
                const preview = document.getElementById(`slot-preview-${uid}`);
                const viewBtn = document.querySelector(`#slot-card-${uid} .image-slot-actions button`);
                if (preview) {
                    if (newUrl) { preview.innerHTML = `<img src="${newUrl}" alt="${aiType} ${imageIndex+1}" onerror="this.style.display='none';this.parentElement.innerHTML='<div style=&quot;color:#999;font-size:0.8rem;&quot;>Î°úÎìú Ïã§Ìå®</div>';">`; if(viewBtn) viewBtn.disabled = false; }
                    else { preview.innerHTML = `<div style="color:#999;font-size:0.8rem;">URL ÏûÖÎ†•</div>`; if(viewBtn) viewBtn.disabled = true; }
                }
            } catch (e) { console.error("URL ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:", e); showMessage('URL ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò', 'error');}
        }

        // AIÎ≥Ñ ÏÉùÏÑ± Ïù¥ÎØ∏ÏßÄ ÏÑ§Î™Ö ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateAIGeneratedImageDescription(shotId, aiType, imageIndex, newDescription) {
            try {
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId); if (!shot) return showMessage('ÏÉ∑ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå.', 'error');
                if (!shot.image_design) shot.image_design = { aspect_ratio: "16:9" };
                if (!shot.image_design.ai_generated_images) shot.image_design.ai_generated_images = {};
                if (!shot.image_design.ai_generated_images[aiType]) shot.image_design.ai_generated_images[aiType] = [null,null,null].map(()=>({url:'', description:''}));
                if (imageIndex < 3) {
                    if (!shot.image_design.ai_generated_images[aiType][imageIndex]) shot.image_design.ai_generated_images[aiType][imageIndex] = { url: '', description: newDescription };
                    else shot.image_design.ai_generated_images[aiType][imageIndex].description = newDescription;
                    saveDataToLocalStorage();
                }
            } catch (e) { console.error("ÏÑ§Î™Ö ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:", e); showMessage('ÏÑ§Î™Ö ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò', 'error');}
        }
        
        // Ï∞∏Ï°∞ Ïù¥ÎØ∏ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateReferenceImage(shotId, refIndex, field, value) {
            try {
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId); if (!shot) return showMessage('ÏÉ∑ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå.', 'error');
                if (!shot.reference_images) shot.reference_images = [];
                while (shot.reference_images.length <= refIndex) { shot.reference_images.push({ id: `ref_img_${shot.reference_images.length + 1}_${shotId}`, url: '', description: '', type: 'composition' }); }
                shot.reference_images[refIndex][field] = value;
                if (!shot.reference_images[refIndex].id) shot.reference_images[refIndex].id = `ref_img_${refIndex + 1}_${shotId}`;
                saveDataToLocalStorage();
                if (field === 'url') { 
                    const uid = `${shotId}-ref${refIndex}`;
                    const preview = document.getElementById(`ref-preview-${uid}`);
                    if (preview) {
                        if (value) preview.innerHTML = `<img src="${value}" alt="Ï∞∏Ï°∞ ${refIndex+1}" onerror="this.style.display='none';this.parentElement.innerHTML='<div style=&quot;color:#999;font-size:0.8rem;&quot;>Î°úÎìú Ïã§Ìå®</div>';">`;
                        else preview.innerHTML = `<div style="color:#999;font-size:0.8rem;">Ï∞∏Ï°∞ ${refIndex+1} URL</div>`;
                    }
                }
            } catch (e) { console.error("Ï∞∏Ï°∞ Ïù¥ÎØ∏ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:", e); showMessage('Ï∞∏Ï°∞ Ïù¥ÎØ∏ÏßÄ ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò', 'error');}
        }

        // Ï∞∏Ï°∞ Ïù¥ÎØ∏ÏßÄ Ïä¨Î°Ø ÎπÑÏö∞Í∏∞ Ìï®Ïàò
        function clearReferenceImageSlot(shotId, refIndex) {
            try {
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
                if (shot && shot.reference_images && shot.reference_images[refIndex]) {
                    shot.reference_images[refIndex] = { id: `ref_img_${refIndex + 1}_${shotId}`, url: '', description: '', type: 'composition' };
                    saveDataToLocalStorage();
                }
                const uid = `${shotId}-ref${refIndex}`;
                const urlIn = document.getElementById(`ref-url-${uid}`); if(urlIn) urlIn.value='';
                const descIn = document.getElementById(`ref-desc-${uid}`); if(descIn) descIn.value='';
                const typeSel = document.getElementById(`ref-type-${uid}`); if(typeSel) typeSel.value='composition';
                const preview = document.getElementById(`ref-preview-${uid}`); if(preview) preview.innerHTML = `<div style="color:#999;font-size:0.8rem;">Ï∞∏Ï°∞ ${refIndex+1} URL</div>`;
                showMessage(`Ï∞∏Ï°∞ Ïù¥ÎØ∏ÏßÄ Ïä¨Î°Ø ${refIndex+1} ÎπÑÏõåÏßê.`, 'success');
            } catch (e) { console.error("Ï∞∏Ï°∞ Ïä¨Î°Ø ÎπÑÏö∞Í∏∞ Ïò§Î•ò:", e); showMessage('Ï∞∏Ï°∞ Ïä¨Î°Ø ÎπÑÏö∞Í∏∞ Ïò§Î•ò', 'error');}
        }

        // Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í≤å Î≥¥Í∏∞ Î™®Îã¨ Ïó¥Í∏∞/Îã´Í∏∞
        function openImageModal(imageUrl) {
            const modal = document.getElementById('imageDisplayModal'); const modalImg = document.getElementById('modalImageContent');
            if (modal && modalImg && imageUrl && imageUrl.trim() !== '') { modalImg.src = imageUrl; modal.style.display = "flex"; } 
            else if (!imageUrl || imageUrl.trim() === '') { showMessage('Ïù¥ÎØ∏ÏßÄ URLÏù¥ ÏóÜÏñ¥ ÌÅ¨Í≤å Î≥º Ïàò ÏóÜÏäµÎãàÎã§.', 'warning'); }
        }
        function closeImageModal(event) { 
            const modal = document.getElementById('imageDisplayModal');
            if (modal && ( (event && event.target === modal) || (event && event.target.classList.contains('image-modal-close')) || !event ) ) { // XÎ≤ÑÌäº ÎòêÎäî Î∞∞Í≤Ω ÌÅ¥Î¶≠
                modal.style.display = "none"; document.getElementById('modalImageContent').src = ""; 
            }
        }

        // Deprecated image functions (for reference or future migration, not active use)
        function updateImageUrl(s,i,n){console.warn("updateImageUrl deprecated")} function updateImageDescription(s,i,n){console.warn("updateImageDescription deprecated")} function addNewImage(s){console.warn("addNewImage deprecated");showMessage('AIÏÑπÏÖò Ïä¨Î°Ø Ïù¥Ïö©','info')} function removeReference(s,i){console.warn("removeReference deprecated");clearReferenceImageSlot(s,i)} function updateReferenceType(s,i,n){console.warn("updateReferenceType deprecated");updateReferenceImage(s,i,'type',n)} function updateReferenceUrl(s,i,n){console.warn("updateReferenceUrl deprecated");updateReferenceImage(s,i,'url',n)} function updateReferenceDescription(s,i,n){console.warn("updateReferenceDescription deprecated");updateReferenceImage(s,i,'description',n)} function addNewReference(s){console.warn("addNewReference deprecated");showMessage('Ï∞∏Ï°∞ Ïä¨Î°ØÏùÄ Ìï≠ÏÉÅ 3Í∞ú ÌëúÏãú','info')}

        // ÏÉ∑ ÏòÅÏÉÅ ÌÉ≠ ÏÉùÏÑ± (4Í∞ú AI Ïπ¥Îìú Î∞©Ïãù)
        function createShotVideoTab(shot) {
            console.log('üé• createShotVideoTab ÏãúÏûë (4 AI Ïπ¥Îìú Î∞©Ïãù)');
            try {
                const videoPrompts = shot.video_prompts || {}; const videoUrls = shot.video_urls || {}; const selectedAi = shot.video_design?.selected_ai || null; 
                const aiTools = [ { id: 'luma', name: 'Luma AI', prompt: videoPrompts.luma?.main_prompt, settings: videoPrompts.luma?.settings, url: videoUrls.luma }, { id: 'kling', name: 'Kling AI', prompt: videoPrompts.kling?.main_prompt, settings: videoPrompts.kling?.settings, url: videoUrls.kling }, { id: 'veo2', name: 'Google Veo 2', prompt: videoPrompts.veo2?.main_prompt, settings: videoPrompts.veo2?.settings, url: videoUrls.veo2 }, { id: 'runway', name: 'Runway ML', prompt: videoPrompts.runway?.main_prompt, settings: videoPrompts.runway?.settings, url: videoUrls.runway } ];
                let cardsHtml = aiTools.map(ai => {
                    const isSelected = selectedAi === ai.id; const promptForCopy = (ai.prompt || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;").replace(/\n/g, "\\n");
                    let settingsHtml = ai.settings && Object.keys(ai.settings).length > 0 ? `<div class="ai-settings-info"><strong>ÏÑ§Ï†ï:</strong> ${JSON.stringify(ai.settings)}</div>` : `<div class="ai-settings-info">ÏÑ§Ï†ï Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.</div>`;
                    return `
                        <div class="ai-video-card ${ai.id} ${isSelected ? 'selected-ai-card' : ''}" id="ai-card-${shot.id}-${ai.id}">
                            <div class="ai-card-header">${ai.name}</div>
                            <div class="ai-card-content">
                                <div class="ai-prompt-area"><label class="form-label">ÏòÅÏÉÅ ÏÉùÏÑ± ÌîÑÎ°¨ÌîÑÌä∏:</label><div class="prompt-text" id="prompt-text-${shot.id}-${ai.id}">${ai.prompt || 'ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.'}</div><button class="copy-prompt-btn" onclick="copyAIPrompt('${promptForCopy}', '${ai.name}')">ÌîÑÎ°¨ÌîÑÌä∏ Î≥µÏÇ¨</button></div>
                                <div class="form-group"><label class="form-label">ÏòÅÏÉÅ URL:</label><input type="text" class="form-input" value="${ai.url || ''}" placeholder="${ai.name} ÏòÅÏÉÅ URL" onchange="updateAIVideoUrl('${shot.id}', '${ai.id}', this.value)"></div>
                                <div class="ai-video-preview" id="video-preview-${shot.id}-${ai.id}">${ai.url ? `<video controls style="max-width:100%;max-height:200px;border-radius:6px;" src="${ai.url}" onerror="this.style.display='none';this.parentElement.innerHTML='<div style=&quot;color:#999;font-size:0.9rem;&quot;>Î°úÎìú Ïã§Ìå®</div>';"></video>` : `<div style="color:#999;font-size:0.9rem;">URL ÏûÖÎ†•</div>`}</div>
                                ${settingsHtml}
                            </div>
                            <button class="ai-select-button ${isSelected ? 'selected' : ''}" id="select-btn-${shot.id}-${ai.id}" onclick="selectFinalAI('${shot.id}', '${ai.id}')">${isSelected ? '‚úì ÏµúÏ¢Ö ÏÑ†ÌÉùÎê®' : `Ïù¥ AIÎ°ú ÏµúÏ¢Ö ÏÑ†ÌÉù`}</button>
                        </div>`;
                }).join('');
                return `
                    <div class="info-section"><h3>üé¨ AI Í∏∞Î∞ò ÏòÅÏÉÅ ÏÉùÏÑ± Í¥ÄÎ¶¨</h3><p style="font-size:0.9em;color:#555;margin-bottom:20px;">AI ÎèÑÍµ¨Î≥Ñ ÌîÑÎ°¨ÌîÑÌä∏Î•º ÌôïÏù∏ÌïòÍ≥†, ÏÉùÏÑ±Îêú ÏòÅÏÉÅ URLÏùÑ ÏûÖÎ†•ÌïòÏó¨ Í¥ÄÎ¶¨ÌïòÏÑ∏Ïöî. ÏµúÏ¢Ö ÏÇ¨Ïö©Ìï† ÏòÅÏÉÅÏùÑ ÏÑ†ÌÉùÌï† Ïàò ÏûàÏäµÎãàÎã§.</p><div class="video-ai-grid">${cardsHtml}</div></div>
                    <div class="info-section" style="margin-top:30px;"><h3>Í∏∞Ï°¥ ÏòÅÏÉÅ Ï†ïÎ≥¥ (Ï∞∏Í≥†Ïö©)</h3><table class="info-table"><tr><th>ÏµúÏ¢Ö ÏÑ†ÌÉù AI</th><td id="legacy-ai-tool-${shot.id}">${shot.video_design?.selected_ai || shot.video_design?.ai_tool || '-'}</td></tr><tr><th>ÏµúÏ¢Ö ÏòÅÏÉÅ URL</th><td id="legacy-video-url-${shot.id}">${shot.video_design?.video_url || '-'}</td></tr></table><small style="color:#777;font-size:0.85em;">ÏÑ†ÌÉùÎêú AIÏùò Ï†ïÎ≥¥Í∞Ä Ïó¨Í∏∞Ïóê Î∞òÏòÅÎê©ÎãàÎã§.</small></div>`;
            } catch (e) { console.error('‚ùå createShotVideoTab Ïò§Î•ò:', e); return `<div class="info-section"><h3>ÏòÅÏÉÅ ÌÉ≠ Î°úÎìú Ïò§Î•ò</h3><p>${e.message}</p></div>`; }
        }

        // AI ÏòÅÏÉÅ ÌîÑÎ°¨ÌîÑÌä∏ Î≥µÏÇ¨ Ìï®Ïàò
        function copyAIPrompt(promptText, aiName) {
            const actualPromptText = promptText.replace(/\\n/g, "\n");
            if (!actualPromptText || actualPromptText.trim() === 'ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.') return showMessage(`${aiName} ÌîÑÎ°¨ÌîÑÌä∏ ÎπÑÏñ¥ Î≥µÏÇ¨ Î∂àÍ∞Ä.`, 'warning');
            copyToClipboard(actualPromptText).then(ok => ok && showMessage(`${aiName} ÏòÅÏÉÅ ÌîÑÎ°¨ÌîÑÌä∏ Î≥µÏÇ¨Îê®.`, 'success'));
        }

        // AIÎ≥Ñ ÏòÅÏÉÅ URL ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateAIVideoUrl(shotId, aiType, newUrl) {
            try {
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId); if (!shot) return showMessage('ÏÉ∑ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå.', 'error');
                if (!shot.video_urls) shot.video_urls = {}; shot.video_urls[aiType] = newUrl;
                if (!shot.video_design) shot.video_design = { ai_tool: '', video_url: '', selected_ai: null };
                if (shot.video_design.selected_ai === aiType) {
                    shot.video_design.video_url = newUrl;
                    const legacyUrlCell = document.getElementById(`legacy-video-url-${shot.id}`); if (legacyUrlCell) legacyUrlCell.textContent = newUrl || '-';
                    const legacyAiToolCell = document.getElementById(`legacy-ai-tool-${shot.id}`); if (legacyAiToolCell) legacyAiToolCell.textContent = aiType || '-';
                }
                saveDataToLocalStorage();
                const preview = document.getElementById(`video-preview-${shot.id}-${aiType}`);
                if (preview) {
                    if (newUrl) preview.innerHTML = `<video controls style="max-width:100%;max-height:200px;border-radius:6px;" src="${newUrl}" onerror="this.style.display='none';this.parentElement.innerHTML='<div style=&quot;color:#999;font-size:0.9rem;&quot;>Î°úÎìú Ïã§Ìå®</div>';"></video>`;
                    else preview.innerHTML = `<div style="color:#999;font-size:0.9rem;">URL ÏûÖÎ†•</div>`;
                }
            } catch (e) { console.error("ÏòÅÏÉÅ URL ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:", e); showMessage('ÏòÅÏÉÅ URL ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò', 'error');}
        }

        // ÏµúÏ¢Ö AI ÏÑ†ÌÉù Ìï®Ïàò
        function selectFinalAI(shotId, aiType) {
            try {
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId); if (!shot) return showMessage('ÏÉ∑ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå.', 'error');
                if (!shot.video_design) shot.video_design = { ai_tool: aiType, video_url: '', selected_ai: aiType };
                else { shot.video_design.selected_ai = aiType; shot.video_design.ai_tool = aiType; }
                if (!shot.video_urls) shot.video_urls = {}; shot.video_design.video_url = shot.video_urls[aiType] || '';
                saveDataToLocalStorage();
                ['luma', 'kling', 'veo2', 'runway'].forEach(id => {
                    const card = document.getElementById(`ai-card-${shot.id}-${id}`); const btn = document.getElementById(`select-btn-${shot.id}-${id}`);
                    if (card && btn) {
                        if (id === aiType) { card.classList.add('selected-ai-card'); btn.classList.add('selected'); btn.textContent = '‚úì ÏµúÏ¢Ö ÏÑ†ÌÉùÎê®'; }
                        else { card.classList.remove('selected-ai-card'); btn.classList.remove('selected'); btn.textContent = `Ïù¥ AIÎ°ú ÏµúÏ¢Ö ÏÑ†ÌÉù`; }
                    }
                });
                const legacyUrlCell = document.getElementById(`legacy-video-url-${shot.id}`); if (legacyUrlCell) legacyUrlCell.textContent = shot.video_design.video_url || '-';
                const legacyAiToolCell = document.getElementById(`legacy-ai-tool-${shot.id}`); if (legacyAiToolCell) legacyAiToolCell.textContent = aiType || '-';
                showMessage(`${aiType}Ïù¥(Í∞Ä) ÏµúÏ¢Ö ÏòÅÏÉÅÏúºÎ°ú ÏÑ†ÌÉùÎê®.`, 'success');
            } catch (e) { console.error("ÏµúÏ¢Ö AI ÏÑ†ÌÉù Ïò§Î•ò:", e); showMessage('ÏµúÏ¢Ö AI ÏÑ†ÌÉù Ïò§Î•ò', 'error');}
        }

        // ÏÉ∑ Ïò§ÎîîÏò§ ÌÉ≠ ÏÉùÏÑ±
        // ÏÉ∑ Ïò§ÎîîÏò§ ÌÉ≠ ÏÉùÏÑ± (ÎåÄÌôî/ÎÇòÎ†àÏù¥ÏÖò ÏÉÅÏÑ∏ Î∞è TTSÏö© Î∂ÑÎ¶¨)
        function createShotAudioTab(shot) {
            console.log('üîä createShotAudioTab ÏãúÏûë (TTSÏö© Î∂ÑÎ¶¨)');
            try {
                const audioUrls = shot.content?.audio_urls || {};
                const dialogue = shot.content?.dialogue || {};
                const narration = shot.content?.narration || '';
                // audio_promptsÎäî Ïù¥Ï†ú TTSÏö© ÏàúÏàò ÌÖçÏä§Ìä∏Î•º contentÏóêÏÑú Í∞ÄÏ†∏Ïò§ÎØÄÎ°ú, Ïó¨Í∏∞ÏÑúÎäî Ï∞∏Í≥†Ïö©ÏúºÎ°úÎßå ÌôïÏù∏
                const audioPrompts = shot.audio_prompts || {};

                // --- ÎåÄÌôî Ïò§ÎîîÏò§ ÏÑπÏÖò ---
                let dialogueContentHtml = '';
                if (Object.keys(dialogue).length > 0) {
                    dialogueContentHtml = Object.entries(dialogue).map(([charId, dia]) => {
                        return `<strong>${charId}:</strong> ${dia.text || ''} <em>(Í∞êÏ†ï: ${dia.emotion || '-'}, Ïä§ÌÉÄÏùº: ${dia.voice_style || '-'})</em>`;
                    }).join('<br>');
                } else {
                    dialogueContentHtml = 'ÎåÄÌôî ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.';
                }

                const fullDialogueForCopy = Object.entries(dialogue).map(([charId, dia]) => {
                    return `${charId}: ${dia.text || ''} (Í∞êÏ†ï: ${dia.emotion || '-'}, Ïä§ÌÉÄÏùº: ${dia.voice_style || '-'})`;
                }).join('\\n').replace(/'/g, "&#39;");

                let characterOptionsHtml = Object.keys(dialogue).map(charId => `<option value="${charId}">${charId}</option>`).join('');
                let initialTtsDialogueText = '';
                if (Object.keys(dialogue).length > 0) {
                    const firstCharId = Object.keys(dialogue)[0];
                    initialTtsDialogueText = dialogue[firstCharId]?.text || '';
                }

                const dialogueHtml = `
                    <div class="audio-section">
                        <h4>üé§ ÎåÄÌôî Ïò§ÎîîÏò§</h4>
                        <div class="audio-player-area">
                            ${audioUrls.dialogue ? `<audio controls style="width: 100%;" src="${audioUrls.dialogue}"></audio>` : `<div style="color: #999;">ÎåÄÌôî Ïò§ÎîîÏò§ URL ÏûÖÎ†•</div>`}
                        </div>
                        <div class="form-group">
                            <label class="form-label">ÎåÄÌôî Ïò§ÎîîÏò§ URL</label>
                            <input type="text" class="form-input" value="${audioUrls.dialogue || ''}" placeholder="https://example.com/dialogue.mp3" onchange="updateAudioUrl('${shot.id}', 'dialogue', this.value)">
                        </div>

                        <div class="info-section" style="padding:15px; background-color:#fcfcfc;">
                            <h5>ÎåÄÌôî ÎÇ¥Ïö© (Í≤ÄÌÜ†Ïö©)</h5>
                            <div class="audio-content-display" style="min-height:80px; white-space:normal;">${dialogueContentHtml}</div>
                            <button class="copy-btn btn-small" style="margin-top:5px;" onclick="copyToClipboard('${fullDialogueForCopy}').then(ok => ok && showMessage('Ï†ÑÏ≤¥ ÎåÄÌôî ÎÇ¥Ïö© Î≥µÏÇ¨Îê®.', 'success'))">Ï†ÑÏ≤¥ ÎåÄÌôî ÎÇ¥Ïö© Î≥µÏÇ¨</button>
                        </div>

                        <div class="info-section" style="padding:15px; background-color:#fcfcfc; margin-top:15px;">
                            <h5>TTSÏö© Ï∫êÎ¶≠ÌÑ∞ ÎåÄÏÇ¨ (ÎçîÎπôÏö©)</h5>
                            <div class="form-group">
                                <label for="tts-char-select-${shot.id}" class="form-label">Ï∫êÎ¶≠ÌÑ∞ ÏÑ†ÌÉù:</label>
                                <select id="tts-char-select-${shot.id}" class="form-select" onchange="updateTtsDialogueDisplay('${shot.id}')" ${Object.keys(dialogue).length === 0 ? 'disabled' : ''}>
                                    ${characterOptionsHtml || '<option value="">ÏÑ†ÌÉùÌï† Ï∫êÎ¶≠ÌÑ∞ ÏóÜÏùå</option>'}
                                </select>
                            </div>
                            <div class="audio-content-display" id="tts-dialogue-text-${shot.id}" style="min-height:60px;">${initialTtsDialogueText.replace(/\n/g, "<br>")}</div>
                            <button class="copy-btn btn-small" style="margin-top:5px;" onclick="copyTtsDialogue('${shot.id}')">ÏÑ†ÌÉù Ï∫êÎ¶≠ÌÑ∞ ÎåÄÏÇ¨ Î≥µÏÇ¨</button>
                            ${audioPrompts.dialogue?.prompt ? `<div class="prompt-text" style="margin-top:10px; font-size:0.8em; background-color:#eee; padding:5px;">Ï∞∏Í≥†Ïö© Í∏∞Ï°¥ ÌîÑÎ°¨ÌîÑÌä∏: ${audioPrompts.dialogue.prompt}</div>` : ''}
                            ${audioPrompts.dialogue?.settings ? `<div style="margin-top:5px; font-size:0.8em; color:#555;">Ï∞∏Í≥†Ïö© Í∏∞Ï°¥ ÏÑ§Ï†ï: ${JSON.stringify(audioPrompts.dialogue.settings)}</div>` : ''}
                        </div>
                    </div>
                `;

                // --- ÎÇòÎ†àÏù¥ÏÖò Ïò§ÎîîÏò§ ÏÑπÏÖò ---
                const narrationForCopy = (narration || '').replace(/'/g, "&#39;").replace(/\n/g, "\\n");
                // TTSÏö© ÎÇòÎ†àÏù¥ÏÖò ÌÖçÏä§Ìä∏Îäî shot.content.narrationÏùÑ Ïö∞ÏÑ† ÏÇ¨Ïö©. ÏóÜÎã§Î©¥ audio_prompts.narration.prompt ÏÇ¨Ïö©.
                const ttsNarrationSourceText = narration || audioPrompts.narration?.prompt || 'ÎÇòÎ†àÏù¥ÏÖò ÎÇ¥Ïö© ÎòêÎäî ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.';
                const ttsNarrationForCopy = (ttsNarrationSourceText).replace(/'/g, "&#39;").replace(/\n/g, "\\n");


                const narrationHtml = `
                    <div class="audio-section">
                        <h4> narrÔ∏è ÎÇòÎ†àÏù¥ÏÖò Ïò§ÎîîÏò§</h4>
                        <div class="audio-player-area">
                            ${audioUrls.narration ? `<audio controls style="width: 100%;" src="${audioUrls.narration}"></audio>` : `<div style="color: #999;">ÎÇòÎ†àÏù¥ÏÖò Ïò§ÎîîÏò§ URL ÏûÖÎ†•</div>`}
                        </div>
                        <div class="form-group">
                            <label class="form-label">ÎÇòÎ†àÏù¥ÏÖò Ïò§ÎîîÏò§ URL</label>
                            <input type="text" class="form-input" value="${audioUrls.narration || ''}" placeholder="https://example.com/narration.mp3" onchange="updateAudioUrl('${shot.id}', 'narration', this.value)">
                        </div>

                        <div class="info-section" style="padding:15px; background-color:#fcfcfc;">
                            <h5>ÎÇòÎ†àÏù¥ÏÖò ÎÇ¥Ïö© (Í≤ÄÌÜ†Ïö©)</h5>
                            <div class="audio-content-display" style="min-height:60px;">${narration || 'ÎÇòÎ†àÏù¥ÏÖò ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.'}</div>
                            <button class="copy-btn btn-small" style="margin-top:5px;" onclick="copyToClipboard('${narrationForCopy}').then(ok => ok && showMessage('ÎÇòÎ†àÏù¥ÏÖò ÎÇ¥Ïö© Î≥µÏÇ¨Îê®.', 'success'))">ÎÇòÎ†àÏù¥ÏÖò ÎÇ¥Ïö© Î≥µÏÇ¨</button>
                        </div>

                        <div class="info-section" style="padding:15px; background-color:#fcfcfc; margin-top:15px;">
                            <h5>TTSÏö© ÎÇòÎ†àÏù¥ÏÖò ÎåÄÏÇ¨ (ÎçîÎπôÏö©)</h5>
                            <div class="audio-content-display" id="tts-narration-text-${shot.id}" style="min-height:60px;">${ttsNarrationSourceText.replace(/\n/g, "<br>")}</div>
                            <button class="copy-btn btn-small" style="margin-top:5px;" onclick="copyToClipboard('${ttsNarrationForCopy}').then(ok => ok && showMessage('TTSÏö© ÎÇòÎ†àÏù¥ÏÖò ÎåÄÏÇ¨ Î≥µÏÇ¨Îê®.', 'success'))">TTSÏö© ÎÇòÎ†àÏù¥ÏÖò ÎåÄÏÇ¨ Î≥µÏÇ¨</button>
                            ${audioPrompts.narration?.prompt && audioPrompts.narration.prompt !== ttsNarrationSourceText ? `<div class="prompt-text" style="margin-top:10px; font-size:0.8em; background-color:#eee; padding:5px;">Ï∞∏Í≥†Ïö© Í∏∞Ï°¥ ÌîÑÎ°¨ÌîÑÌä∏: ${audioPrompts.narration.prompt}</div>` : ''}
                            ${audioPrompts.narration?.settings ? `<div style="margin-top:5px; font-size:0.8em; color:#555;">Ï∞∏Í≥†Ïö© Í∏∞Ï°¥ ÏÑ§Ï†ï: ${JSON.stringify(audioPrompts.narration.settings)}</div>` : ''}
                        </div>
                    </div>
                `;

                // --- ÏùåÌñ• Ìö®Í≥º ÏÑπÏÖò (Í∏∞Ï°¥Í≥º Ïú†ÏÇ¨ÌïòÍ≤å Ïú†ÏßÄ) ---
                const soundEffects = shot.content?.sound_effects || '';
                const soundEffectsForCopy = (soundEffects || '').replace(/'/g, "&#39;").replace(/\n/g, "\\n");
                const sfxPromptText = audioPrompts.sound_effects?.prompt || 'ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.'; // Î≥ÄÏàò Ïù¥Î¶Ñ Î™ÖÌôïÌûà
                const sfxPromptForCopy = (sfxPromptText).replace(/'/g, "&#39;").replace(/\n/g, "\\n");

                const soundEffectsHtml = `
                    <div class="audio-section">
                        <h4>üîä ÏùåÌñ• Ìö®Í≥º</h4>
                        <div class="audio-player-area">
                            ${audioUrls.sound_effects ? `<audio controls style="width: 100%;" src="${audioUrls.sound_effects}"></audio>` : `<div style="color: #999;">ÏùåÌñ• Ìö®Í≥º URL ÏûÖÎ†•</div>`}
                        </div>
                        <div class="form-group">
                            <label class="form-label">ÏùåÌñ• Ìö®Í≥º URL</label>
                            <input type="text" class="form-input" value="${audioUrls.sound_effects || ''}" placeholder="https://example.com/sound.mp3" onchange="updateAudioUrl('${shot.id}', 'sound_effects', this.value)">
                        </div>
                        ${soundEffects ? `
                        <div class="form-group">
                            <label class="form-label">ÏùåÌñ• Ìö®Í≥º ÏÑ§Î™Ö</label>
                            <div class="audio-content-display">${soundEffects}</div>
                            <button class="copy-btn btn-small" style="margin-top:5px;" onclick="copyToClipboard('${soundEffectsForCopy}').then(ok => ok && showMessage('ÏùåÌñ• ÏÑ§Î™Ö Î≥µÏÇ¨Îê®.', 'success'))">ÏùåÌñ• ÏÑ§Î™Ö Î≥µÏÇ¨</button>
                        </div>` : ''}
                        ${audioPrompts.sound_effects ? `
                        <div class="prompt-container">
                            <div class="prompt-header"><span class="prompt-title">ÏùåÌñ• Ìö®Í≥º ÏÉùÏÑ± ÌîÑÎ°¨ÌîÑÌä∏</span>
                                <button class="copy-btn" onclick="copyToClipboard('${sfxPromptForCopy}').then(ok => ok && showMessage('ÏùåÌñ• ÌîÑÎ°¨ÌîÑÌä∏ Î≥µÏÇ¨Îê®.', 'success'))">Î≥µÏÇ¨</button>
                            </div>
                            <div class="prompt-text">${sfxPromptText}</div>
                            ${audioPrompts.sound_effects.settings ? `<div style="margin-top: 8px; font-size: 0.85rem; color: #666;">ÏÑ§Ï†ï: ${JSON.stringify(audioPrompts.sound_effects.settings)}</div>` : ''}
                        </div>` : ''}
                    </div>`;

                console.log('‚úÖ createShotAudioTab ÏôÑÎ£å');
                return `${dialogueHtml}${narrationHtml}${soundEffectsHtml}`;
            } catch (error) {
                console.error('‚ùå createShotAudioTab Ïò§Î•ò:', error);
                return `<div class="info-section"><h3>Ïò§ÎîîÏò§ ÌÉ≠ Î°úÎìú Ïò§Î•ò</h3><p>Ïò§Î•ò: ${error.message}</p></div>`;
            }
        }

        // TTSÏö© ÎåÄÌôî ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateTtsDialogueDisplay(shotId) {
            try {
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
                const selectElement = document.getElementById(`tts-char-select-${shotId}`);
                const displayElement = document.getElementById(`tts-dialogue-text-${shotId}`);

                if (shot && selectElement && displayElement && shot.content && shot.content.dialogue) {
                    const selectedCharId = selectElement.value;
                    const dialogueText = shot.content.dialogue[selectedCharId]?.text || 'ÏÑ†ÌÉùÎêú Ï∫êÎ¶≠ÌÑ∞Ïùò ÎåÄÏÇ¨Í∞Ä ÏóÜÏäµÎãàÎã§.';
                    displayElement.innerHTML = dialogueText.replace(/\n/g, "<br>"); // ÌëúÏãúÌï† ÎïåÎäî <br>Î°ú
                }
            } catch (error) {
                console.error("TTS ÎåÄÌôî ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:", error);
            }
        }

        // TTSÏö© ÏÑ†ÌÉù Ï∫êÎ¶≠ÌÑ∞ ÎåÄÏÇ¨ Î≥µÏÇ¨ Ìï®Ïàò
        function copyTtsDialogue(shotId) {
            try {
                // ÌëúÏãúÎêú ÎÇ¥Ïö©(innerHTML)Ïù¥ ÏïÑÎãå, ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞ÏóêÏÑú ÌÖçÏä§Ìä∏Î•º Í∞ÄÏ†∏ÏôÄ Î≥µÏÇ¨
                const selectElement = document.getElementById(`tts-char-select-${shotId}`);
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);

                if (selectElement && shot && shot.content && shot.content.dialogue) {
                     const selectedCharId = selectElement.value;
                     const dialogueText = shot.content.dialogue[selectedCharId]?.text || ''; // ÏõêÎ≥∏ ÌÖçÏä§Ìä∏
                     if (dialogueText.trim() === '') {
                        showMessage('Î≥µÏÇ¨Ìï† ÎåÄÏÇ¨Í∞Ä ÏóÜÏäµÎãàÎã§.', 'warning');
                        return;
                     }
                     // Î≥µÏÇ¨Ìï† ÎïåÎäî \nÏùÑ Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ (ÌÅ¥Î¶ΩÎ≥¥Îìú APIÍ∞Ä OSÏóê ÎßûÍ≤å Ï≤òÎ¶¨)
                     copyToClipboard(dialogueText).then(ok => ok && showMessage('ÏÑ†ÌÉùÎêú Ï∫êÎ¶≠ÌÑ∞Ïùò TTSÏö© ÎåÄÏÇ¨Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.', 'success'));
                } else {
                     showMessage('Î≥µÏÇ¨Ìï† ÎåÄÏÇ¨Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'warning');
                }
            } catch (error) {
                console.error("TTS ÎåÄÌôî Î≥µÏÇ¨ Ïò§Î•ò:", error);
                showMessage('TTS ÎåÄÏÇ¨ Î≥µÏÇ¨ Ï§ë Ïò§Î•ò Î∞úÏÉù', 'error');
            }
        }


        // ÏÉ∑ ÏùåÏïÖ ÌÉ≠ ÏÉùÏÑ±
        // ÏÉ∑ ÏùåÏïÖ ÌÉ≠ ÏÉùÏÑ± (ÌîÑÎ°úÏ†ùÌä∏ Ï†ÑÏ≤¥ ÏùåÏïÖ Ï†ïÎ≥¥ + ÏÉ∑Î≥Ñ Î©îÎ™®)
        function createShotMusicTab(shot) {
            console.log('üéµ createShotMusicTab ÏãúÏûë (ÌîÑÎ°úÏ†ùÌä∏ ÏùåÏïÖ Ï†ïÎ≥¥ + ÏÉ∑Î≥Ñ Î©îÎ™®)');
            try {
                // ÌîÑÎ°úÏ†ùÌä∏ Î†àÎ≤®Ïùò ÏùåÏïÖ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                const projectMusicPrompts = currentData.film_metadata?.project_music_prompts || {};
                const projectMusicUrls = currentData.film_metadata?.project_music_urls || {};

                // ÏÉ∑ Î†àÎ≤®Ïùò ÏùåÏïÖ Î©îÎ™® Í∞ÄÏ†∏Ïò§Í∏∞
                const shotMusicMemo = shot.music_memo || '';

                const createProjectOstSection = (ostType, title, emoji) => {
                    const ostPromptData = projectMusicPrompts[ostType];
                    const ostUrl = projectMusicUrls[ostType] || '';

                    if (!ostPromptData) {
                        return `<div class="music-ost-section"><h4>${emoji} ${title} (ÌîÑÎ°úÏ†ùÌä∏)</h4><div style="text-align:center;padding:20px;color:#999;">${title} ÌîÑÎ°¨ÌîÑÌä∏ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§. (film_metadata.project_music_prompts)</div></div>`;
                    }

                    const stylePrompt = ostPromptData.style_prompt || 'Ïä§ÌÉÄÏùº ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.';
                    const lyricsPrompt = ostPromptData.lyrics_structure_prompt || 'Í∞ÄÏÇ¨&Íµ¨Ï°∞ ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.';
                    const stylePromptForCopy = stylePrompt.replace(/'/g, "&#39;").replace(/\n/g, "\\n");
                    const lyricsPromptForCopy = lyricsPrompt.replace(/'/g, "&#39;").replace(/\n/g, "\\n");

                    return `
                        <div class="music-ost-section">
                            <h4>${emoji} ${title} (ÌîÑÎ°úÏ†ùÌä∏ Ï†ÑÏ≤¥)</h4>
                            <div class="audio-player-area" style="margin-bottom:15px;">
                                ${ostUrl ? `<audio controls style="width: 100%;" src="${ostUrl}"></audio>` : `<div style="color: #999;">${title} URL ÏûÖÎ†• (ÌîÑÎ°úÏ†ùÌä∏ Î†àÎ≤®)</div>`}
                            </div>
                            <div class="form-group">
                                <label class="form-label">${title} URL (ÌîÑÎ°úÏ†ùÌä∏ Ï†ÑÏ≤¥)</label>
                                <input type="text" class="form-input" value="${ostUrl}" 
                                       placeholder="https://example.com/${ostType}.mp3" 
                                       onchange="updateProjectMusicUrl('${ostType}', this.value)">
                            </div>
                            <div class="ost-prompt-grid">
                                <div class="ost-prompt-item">
                                    <div class="prompt-title">Ïä§ÌÉÄÏùº ÌîÑÎ°¨ÌîÑÌä∏</div>
                                    <div class="prompt-text">${stylePrompt}</div>
                                    <button class="copy-btn btn-small" onclick="copyToClipboard('${stylePromptForCopy}').then(ok => ok && showMessage('${title} Ïä§ÌÉÄÏùº ÌîÑÎ°¨ÌîÑÌä∏ Î≥µÏÇ¨Îê®.', 'success'))">Î≥µÏÇ¨</button>
                                </div>
                                <div class="ost-prompt-item">
                                    <div class="prompt-title">Í∞ÄÏÇ¨ & Íµ¨Ï°∞ ÌîÑÎ°¨ÌîÑÌä∏</div>
                                    <div class="prompt-text">${lyricsPrompt}</div>
                                    <button class="copy-btn btn-small" onclick="copyToClipboard('${lyricsPromptForCopy}').then(ok => ok && showMessage('${title} Í∞ÄÏÇ¨/Íµ¨Ï°∞ ÌîÑÎ°¨ÌîÑÌä∏ Î≥µÏÇ¨Îê®.', 'success'))">Î≥µÏÇ¨</button>
                                </div>
                            </div>
                        </div>`;
                };

                const mainOstHtml = createProjectOstSection('main_ost', 'Î©îÏù∏ OST', 'üéº');
                const subOst1Html = createProjectOstSection('sub_ost_1', 'ÏÑúÎ∏å OST 1', 'üéµ');
                const subOst2Html = createProjectOstSection('sub_ost_2', 'ÏÑúÎ∏å OST 2', 'üé∂');
                
                const shotMusicMemoHtml = `
                    <div class="info-section">
                        <h3>üìù Ïù¥ ÏÉ∑Ïùò ÏùåÏïÖ Í¥ÄÎ†® Î©îÎ™®</h3>
                         <div class="form-group">
                            <label class="form-label">ÏÉ∑ ÏùåÏïÖ Ï†ÅÏö© ÎÖ∏Ìä∏ (Ïòà: Ïù¥ ÏÉ∑Î∂ÄÌÑ∞ Î©îÏù∏ ÌÖåÎßà ÏÇ¨Ïö©):</label>
                            <textarea class="form-textarea" 
                                      style="min-height: 100px;"
                                      placeholder="Ïù¥ ÏÉ∑Ïóê Ï†ÅÏö©Îê† ÏùåÏïÖÏóê ÎåÄÌïú Íµ¨Ï≤¥Ï†ÅÏù∏ ÏßÄÏãúÏÇ¨Ìï≠Ïù¥ÎÇò ÏïÑÏù¥ÎîîÏñ¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
                                      onchange="updateShotMusicMemo('${shot.id}', this.value)">${shotMusicMemo}</textarea>
                            <small style="color:#777; font-size:0.85em;">Ïù¥ Î©îÎ™®Îäî ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÏÉ∑(${shot.id})ÏóêÎßå Ìï¥ÎãπÎê©ÎãàÎã§.</small>
                        </div>
                    </div>`;

                return `${mainOstHtml}${subOst1Html}${subOst2Html}${shotMusicMemoHtml}`;
            } catch (error) {
                console.error('‚ùå createShotMusicTab Ïò§Î•ò:', error);
                return `<div class="info-section"><h3>ÏùåÏïÖ ÌÉ≠ Î°úÎìú Ïò§Î•ò</h3><p>Ïò§Î•ò Î©îÏãúÏßÄ: ${error.message}</p></div>`;
            }
        }

        // ÌîÑÎ°úÏ†ùÌä∏ Î†àÎ≤® ÏùåÏïÖ URL ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateProjectMusicUrl(ostType, newUrl) {
            try {
                if (!currentData.film_metadata) currentData.film_metadata = {};
                if (!currentData.film_metadata.project_music_urls) currentData.film_metadata.project_music_urls = {};
                
                currentData.film_metadata.project_music_urls[ostType] = newUrl;
                saveDataToLocalStorage();
                
                // ÌòÑÏû¨ ÌÉ≠Ïù¥ ÏùåÏïÖ ÌÉ≠Ïù¥ÎùºÎ©¥ UI Ï¶âÏãú Í∞±Ïã† (ÌîåÎ†àÏù¥Ïñ¥ Î∂ÄÎ∂Ñ)
                const activeTabId = document.querySelector('.tab-button.active')?.getAttribute('onclick').match(/'([^']+)'/)[1];
                if (activeTabId === 'music' && selectedType === 'shot' && selectedId) {
                    showShotContent(selectedId); // ÌòÑÏû¨ ÏÉ∑ ÏΩòÌÖêÏ∏†Î•º Îã§Ïãú Í∑∏Î†§ÏÑú ÏùåÏïÖ ÌÉ≠ ÏóÖÎç∞Ïù¥Ìä∏
                    setTimeout(() => switchTab('music', selectedId), 0); // ÏùåÏïÖ ÌÉ≠ ÌôúÏÑ±Ìôî Ïú†ÏßÄ
                }
                showMessage(`ÌîÑÎ°úÏ†ùÌä∏ ${ostType} URLÏù¥ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§.`, 'success');
            } catch (error) {
                console.error("ÌîÑÎ°úÏ†ùÌä∏ ÏùåÏïÖ URL ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:", error);
                showMessage('ÌîÑÎ°úÏ†ùÌä∏ ÏùåÏïÖ URL ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïò§Î•ò Î∞úÏÉù', 'error');
            }
        }

        // ÏÉ∑Î≥Ñ ÏùåÏïÖ Î©îÎ™® ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateShotMusicMemo(shotId, memo) {
            try {
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
                if (!shot) return showMessage('ÏÉ∑ Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                
                shot.music_memo = memo;
                saveDataToLocalStorage();
                showMessage(`ÏÉ∑ ${shotId}Ïùò ÏùåÏïÖ Î©îÎ™®Í∞Ä ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§.`, 'success');
            } catch (error) {
                console.error("ÏÉ∑ ÏùåÏïÖ Î©îÎ™® ÏóÖÎç∞Ïù¥Ìä∏ Ïò§Î•ò:", error);
                showMessage('ÏÉ∑ ÏùåÏïÖ Î©îÎ™® ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïò§Î•ò Î∞úÏÉù', 'error');
            }
        }
        
        // Î©îÎ™® Í¥ÄÎ¶¨ Ìï®ÏàòÎì§
        function getShotMemo(shotId){try{return JSON.parse(localStorage.getItem('shotMemos')||'{}')[shotId]||''}catch(e){return''}}
        function updateShotMemo(shotId,memo){try{const m=JSON.parse(localStorage.getItem('shotMemos')||'{}');m[shotId]=memo;localStorage.setItem('shotMemos',JSON.stringify(m))}catch(e){showMessage('Î©îÎ™® Ï†ÄÏû• Ïã§Ìå®','error')}}
        
        // Ïò§ÎîîÏò§ URL ÏóÖÎç∞Ïù¥Ìä∏
        function updateAudioUrl(shotId,audioType,newUrl){try{const s=currentData.breakdown_data.shots.find(sh=>sh.id===shotId);if(!s)return;if(!s.content)s.content={};if(!s.content.audio_urls)s.content.audio_urls={};s.content.audio_urls[audioType]=newUrl;saveDataToLocalStorage();const tab=document.querySelector('.tab-button.active')?.getAttribute('onclick').match(/'([^']+)'/)[1];showShotContent(shotId);if(tab)setTimeout(()=>switchTab(tab,shotId),0);showMessage(`${audioType} Ïò§ÎîîÏò§ URL ÏóÖÎç∞Ïù¥Ìä∏`,'success')}catch(e){showMessage('Ïò§ÎîîÏò§ URL ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®','error')}}
        function updateCurrentMusicDescription(shotId,description){try{const s=currentData.breakdown_data.shots.find(sh=>sh.id===shotId);if(!s)return;if(!s.content)s.content={music:''};s.content.music=description;saveDataToLocalStorage();showMessage('ÏùåÏïÖ ÏÑ§Î™Ö ÏóÖÎç∞Ïù¥Ìä∏','success')}catch(e){showMessage('ÏùåÏïÖ ÏÑ§Î™Ö ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®','error')}}

        // Ïª®ÏÖâÏïÑÌä∏ Î≥¥Í∏∞
        function openConceptArt(){try{window.open(`${getProjectName().replace(/ /g,'')}_ConceptArt.html`,'_blank')}catch(e){showMessage('Ïª®ÏÖâÏïÑÌä∏ Ïó¥Í∏∞ Ïã§Ìå®','warning')}}

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        function setupEventListeners() {
            document.getElementById('import-btn')?.addEventListener('click', importData);
            document.getElementById('export-btn')?.addEventListener('click', exportData);
            document.getElementById('concept-art-btn')?.addEventListener('click', openConceptArt);
            document.getElementById('expand-all-btn')?.addEventListener('click', expandAll);
            document.getElementById('collapse-all-btn')?.addEventListener('click', collapseAll);
            document.getElementById('search-input')?.addEventListener('input', searchNavigation);
            document.getElementById('file-input')?.addEventListener('change', handleFileSelect);
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ïã§Ìñâ
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üé¨ ÌéòÏù¥ÏßÄ Î°úÎìú ÏôÑÎ£å, Ï¥àÍ∏∞Ìôî ÏãúÏûë...');
            try {
                setupEventListeners();
                await loadData(); 
                updateUI();       
                console.log('‚úÖ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
            } catch (error) { console.error('‚ùå Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', error); showMessage(`Ï¥àÍ∏∞Ìôî Ïò§Î•ò: ${error.message}`, 'error'); }
        });
        
        console.log('‚úÖ JavaScript Î°úÎî© ÏôÑÎ£å');
    </script>
</body>
</html>
