<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Film Production Manager v5 (Selective Update)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-title {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .project-info {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-primary:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.2);
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 0.8rem;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        /* Navigation Panel */
        .navigation {
            width: 350px;
            background: white;
            border-right: 1px solid #e0e0e0;
            margin-top: 60px;
            overflow-y: auto;
            height: calc(100vh - 60px);
        }

        .nav-header {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .project-header h3 {
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 5px;
        }

        .project-header small {
            color: #666;
            font-size: 0.85rem;
        }

        .nav-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 15px;
        }

        .nav-controls .btn {
            font-size: 0.8rem;
            padding: 6px 12px;
        }

        .search-box {
            margin-top: 10px;
        }

        .search-box input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .nav-content {
            padding: 0;
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .sequence-item {
            border-bottom: 1px solid #f0f0f0;
        }

        .sequence-header {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.2s;
            font-weight: 500;
        }

        .sequence-header:hover {
            background-color: #f8f9fa;
        }

        .sequence-header.active {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .toggle-icon {
            font-size: 0.8rem;
            transition: transform 0.2s;
            color: #666;
        }

        .toggle-icon.expanded {
            transform: rotate(90deg);
        }

        /* 씬 스타일 */
        .scenes-container {
            background-color: #fafafa;
            border-top: 1px solid #e0e0e0;
        }

        .scenes-container.collapsed {
            display: none;
        }

        .scene-item {
            border-bottom: 1px solid #e0e0e0;
        }

        .scene-header {
            padding: 12px 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.2s;
            font-size: 0.95rem;
        }

        .scene-header:hover {
            background-color: #f0f0f0;
        }

        .scene-header.active {
            background-color: #e8f5e8;
            color: #2e7d32;
        }

        /* 샷 스타일 */
        .shots-container {
            background-color: #f5f5f5;
        }

        .shots-container.collapsed {
            display: none;
        }

        .shot-item {
            padding: 8px 60px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.9rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shot-item:hover {
            background-color: #eeeeee;
        }

        .shot-item.active {
            background-color: #fff3e0;
            color: #f57c00;
            font-weight: 500;
        }

        .shot-actions {
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .shot-item:hover .shot-actions {
            opacity: 1;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-top: 60px;
            padding: 30px;
            overflow-y: auto;
            height: calc(100vh - 60px);
        }

        .content-header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .content-subtitle {
            color: #666;
            font-size: 1rem;
        }

        .content-actions {
            display: flex;
            gap: 10px;
        }

        /* Info Section */
        .info-section {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .info-section h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
         .info-section h4 { 
            font-size: 1.05rem;
            font-weight: 600;
            color: #444;
            margin-top: 15px;
            margin-bottom: 10px;
        }


        .info-table {
            width: 100%;
            border-collapse: collapse;
        }

        .info-table th {
            text-align: left;
            padding: 10px 15px;
            background-color: #f8f9fa;
            border: 1px solid #e0e0e0;
            font-weight: 600;
            color: #555;
            width: 150px;
        }

        .info-table td {
            padding: 10px 15px;
            border: 1px solid #e0e0e0;
            color: #333;
        }

        /* 탭 스타일 */
        .tabs {
            margin-bottom: 30px;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .tab-button {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            color: #1976d2;
            border-bottom-color: #1976d2;
            font-weight: 500;
        }

        .tab-button:hover {
            color: #1976d2;
            background-color: #f5f5f5;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* 프롬프트 관련 스타일 (일반) */
        .prompt-container { 
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .prompt-title { 
            font-weight: 600;
            color: #495057;
        }

        .copy-btn { 
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.2s;
        }

        .copy-btn:hover {
            background: #218838;
        }

        .copy-btn:active {
            background: #1e7e34;
        }

        .prompt-text { 
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            white-space: pre-wrap;
            color: #495057;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.95rem;
        }

        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.95rem;
            background: white;
        }

        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.95rem;
            min-height: 80px;
            resize: vertical;
        }


        /* 오디오 섹션 스타일 */
        .audio-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
        }

        .audio-section h4 {
            color: #495057;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9ecef;
        }

        .audio-player-area {
            min-height: 80px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed #ddd;
            margin-bottom: 15px;
        }

        .audio-content-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 10px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 0.9rem;
            line-height: 1.4;
            white-space: pre-wrap;
            color: #495057;
            min-height: 60px;
        }

        /* 음악 탭 전용 스타일 */
        .music-ost-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .music-ost-section h4 {
            color: #495057;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #dee2e6;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .ost-prompt-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .ost-prompt-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
        }

        .ost-prompt-item .prompt-title { 
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .ost-prompt-item .prompt-text { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            white-space: pre-wrap;
            color: #495057;
            max-height: 120px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        /* Messages */
        .message-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1001;
            max-width: 400px;
        }

        .message {
            background: white;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 4px solid #2196f3;
            position: relative;
        }

        .message.success-message {
            border-left-color: #4caf50;
        }

        .message.error-message {
            border-left-color: #f44336;
        }

        .message.warning-message {
            border-left-color: #ff9800;
        }

        .close-button {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #999;
        }

        .hidden-file-input {
            display: none;
        }

        /* 영상 탭 AI 카드 그리드 스타일 시작 */
        .video-ai-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px;
            margin-top: 20px;
        }

        .ai-video-card { 
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            transition: box-shadow 0.3s ease;
        }

        .ai-video-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .ai-video-card .ai-card-header { 
            font-size: 1.2rem;
            font-weight: 600;
            padding-bottom: 10px;
            margin-bottom: 15px;
            border-bottom-width: 2px; 
            border-bottom-style: solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-video-card.luma .ai-card-header { border-color: #FF8C00; color: #FF8C00; } 
        .ai-video-card.kling .ai-card-header { border-color: #1E90FF; color: #1E90FF; } 
        .ai-video-card.veo2 .ai-card-header { border-color: #9370DB; color: #9370DB; } 
        .ai-video-card.runway .ai-card-header { border-color: #3CB371; color: #3CB371; } 

        .ai-video-card .ai-card-content {
            flex-grow: 1;
        }

        .ai-video-card .ai-prompt-area {
            margin-bottom: 15px;
        }

        .ai-video-card .prompt-text { 
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            font-size: 0.85rem; 
            max-height: 150px;
            margin-bottom: 10px;
        }

        .ai-video-card .copy-prompt-btn { 
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.2s;
            margin-bottom: 15px;
        }

        .ai-video-card .copy-prompt-btn:hover {
            background: #5a6268;
        }

        .ai-video-card .form-input { 
            padding: 8px 10px;
            font-size: 0.9rem;
        }

        .ai-video-preview {
            min-height: 150px;
            background: #f0f0f0;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
        }

        .ai-video-preview video {
            max-width: 100%;
            max-height: 250px;
            border-radius: 4px;
        }

        .ai-select-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
            width: 100%;
            margin-top: auto;
        }

        .ai-select-button:hover {
            background-color: #0056b3;
        }

        .ai-select-button.selected {
            background-color: #28a745;
            cursor: default;
        }
        
        .ai-video-card.selected-ai-card {
            border-left: 5px solid #28a745;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);
        }
        
        .ai-video-card .ai-settings-info { 
            font-size: 0.8rem;
            color: #666;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #eee;
        }
        /* 영상 탭 AI 카드 그리드 스타일 끝 */

        /* 이미지 탭 AI 카드 및 이미지 슬롯 스타일 시작 */
        .image-ai-grid { 
            display: grid;
            grid-template-columns: 1fr; 
            gap: 30px; 
            margin-top: 20px;
        }

        .ai-image-section { 
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        }

        .ai-image-section .ai-card-header { 
            font-size: 1.3rem; 
            border-bottom-width: 2px;
            border-bottom-style: solid; 
            margin-bottom: 20px;
             display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }

        .ai-image-section.midjourney .ai-card-header { border-color: #0099FF; color: #0099FF; } 
        .ai-image-section.ideogram .ai-card-header { border-color: #FF6600; color: #FF6600; } 
        .ai-image-section.leonardo .ai-card-header { border-color: #9933CC; color: #9933CC; } 
        .ai-image-section.imagefx .ai-card-header { border-color: #00CC66; color: #00CC66; } 

        .ai-image-prompt-details {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .ai-image-prompt-details .prompt-text-label {
            font-weight: 500;
            color: #333;
            font-size: 0.95rem;
            margin-bottom: 8px;
            display: block;
        }

        .ai-image-prompt-full-text { 
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            white-space: pre-wrap;
            color: #495057;
            max-height: 180px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .ai-image-section .copy-btn { 
            margin-bottom: 0; 
            padding: 8px 15px;
        }

        .generated-images-grid { 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px dashed #e0e0e0;
        }

        .image-slot-card { 
            background: #fdfdfd;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .image-slot-preview {
            width: 100%;
            height: 180px; 
            border: 2px dashed #ccc;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            margin-bottom: 10px;
            overflow: hidden; 
        }

        .image-slot-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; 
            border-radius: 2px;
        }

        .image-slot-card .form-group {
            margin-bottom: 10px;
        }
        .image-slot-card .form-label {
            font-size: 0.85rem;
            margin-bottom: 3px;
        }
        .image-slot-card .form-input,
        .image-slot-card .form-textarea {
            font-size: 0.9rem;
            padding: 6px 8px;
        }
        .image-slot-card .form-textarea {
            min-height: 60px;
            resize: vertical;
        }

        .image-slot-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
        }
        .image-slot-actions .btn-small { 
            flex-grow: 1; 
        }

        /* 참조 이미지 섹션 스타일 */
        .reference-image-slots-container {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ced4da;
        }
        .reference-image-slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .reference-image-slot { 
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .reference-image-slot .reference-preview { 
            width: 100%;
            height: 160px;
            margin-bottom: 12px;
            border: 2px dashed #ddd; 
            border-radius: 6px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: #f8f9fa; 
            overflow: hidden; 
        }
         .reference-image-slot .reference-preview img { 
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 4px;
        }

        .reference-image-slot .form-group {
            margin-bottom: 10px;
        }
        .reference-image-slot .form-label {
            font-size: 0.85rem;
        }
        .reference-image-slot .form-input,
        .reference-image-slot .form-select,
        .reference-image-slot .form-textarea {
            font-size: 0.9rem;
            padding: 7px 10px;
        }
        .reference-image-slot .btn-danger { 
            width: 100%;
            margin-top: 10px;
        }

        /* 이미지 크게 보기 모달 */
        .image-modal {
            display: none; 
            position: fixed;
            z-index: 2000; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.85); 
            justify-content: center; 
            align-items: center; 
        }
        .image-modal-content {
            margin: auto;
            display: block;
            max-width: 85%;
            max-height: 85%;
            border-radius: 5px;
        }
        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }
        .image-modal-close:hover,
        .image-modal-close:focus {
            color: #bbb;
            text-decoration: none;
        }
        /* 이미지 탭 AI 카드 및 이미지 슬롯 스타일 끝 */


        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .navigation {
                width: 100%;
                height: auto;
                position: relative;
                margin-top: 0;
            }
            
            .main-content {
                width: 100%;
                margin-top: 0;
                padding: 15px;
            }
            
            .container {
                flex-direction: column;
            }
            
            .header {
                position: relative;
            }

            .ost-prompt-grid {
                grid-template-columns: 1fr;
            }

            .video-ai-grid { 
                grid-template-columns: 1fr; 
            }
            .generated-images-grid, .reference-image-slots-grid { 
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <div class="header-title">Film Production Manager</div>
            <div class="project-info">
                <div id="project-title">새 프로젝트</div>
                <div id="project-file" style="font-size: 0.8rem; opacity: 0.8;">파일: 없음</div>
            </div>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" id="concept-art-btn">컨셉아트 보기</button>
            <button class="btn btn-primary" id="import-btn">JSON 가져오기</button>
            <button class="btn btn-primary" id="export-btn">JSON 내보내기</button>
        </div>
    </header>

    <div class="container">
        <nav class="navigation">
            <div class="nav-header">
                <div class="project-header">
                    <h3 id="nav-project-title">프로젝트 로딩 중...</h3>
                    <small id="nav-project-file">파일: 로딩 중...</small>
                </div>
                <div class="nav-controls">
                    <button class="btn btn-secondary" id="expand-all-btn">전체 펼치기</button>
                    <button class="btn btn-secondary" id="collapse-all-btn">전체 접기</button>
                </div>
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="시퀀스, 씬, 샷 검색..." />
                </div>
            </div>
            <div class="nav-content" id="navigation-content">
                <div class="empty-state" id="nav-empty">
                    <div class="empty-state-icon">📁</div>
                    <div>데이터가 없습니다</div>
                    <div style="font-size: 0.9rem; margin-top: 10px;">JSON 가져오기를 사용해 데이터를 로드해주세요</div>
                </div>
            </div>
        </nav>

        <main class="main-content">
            <div class="content-header">
                <div>
                    <h1 class="content-title" id="content-title">프로젝트 선택</h1>
                    <p class="content-subtitle" id="content-subtitle">좌측에서 시퀀스, 씬, 또는 샷을 선택하세요</p>
                </div>
                <div class="content-actions" id="content-actions" style="display: none;">
                    </div>
            </div>

            <div id="content-area">
                <div class="empty-state">
                    <div class="empty-state-icon">🎬</div>
                    <div>시퀀스, 씬, 또는 샷을 선택하여 상세 정보를 확인하세요</div>
                </div>
            </div>
        </main>
    </div>

    <div id="message-container" class="message-container"></div>

    <input type="file" id="file-input" class="hidden-file-input" accept=".json">

    <script>
        console.log('🎬 JavaScript 로딩 시작...');
        
        // 전역 변수
        let currentData = null;
        let selectedType = null;
        let selectedId = null;
        let selectedSceneId = null;

        // 동적 파일명 관리
        function getProjectFileName() {
            try {
                const htmlFileName = window.location.pathname.split('/').pop();
                const baseName = htmlFileName.replace('.html', '');
                return baseName + '.json';
            } catch (error) {
                console.error('파일명 생성 오류:', error);
                return 'Film_Production_Manager.json';
            }
        }

        function getProjectName() {
            try {
                return getProjectFileName()
                    .replace('_Manager.json', '')
                    .replace('Film_Production_Manager.json', 'Film Production Manager');
            } catch (error) {
                console.error('프로젝트명 생성 오류:', error);
                return 'Film Production Manager';
            }
        }

        // 메시지 표시
        function showMessage(message, type) {
            console.log('메시지:', message, '타입:', type);
            
            try {
                const messageContainer = document.getElementById('message-container');
                if (!messageContainer) {
                    console.error('메시지 컨테이너를 찾을 수 없음');
                    return;
                }
                
                const messageElement = document.createElement('div');
                messageElement.className = `message ${type}-message`;
                messageElement.innerHTML = `
                    ${message}
                    <button class="close-button" onclick="this.parentElement.remove()">×</button>
                `;
                
                messageContainer.appendChild(messageElement);
                
                if (type !== 'error') {
                    setTimeout(() => {
                        if (messageContainer.contains(messageElement)) {
                            messageContainer.removeChild(messageElement);
                        }
                    }, 5000);
                }
            } catch (error) {
                console.error('메시지 표시 오류:', error);
                alert(message);
            }
        }

        // 클립보드 복사 함수
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                return true;
            } catch (error) {
                console.error('클립보드 복사 실패:', error);
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    return true;
                } catch (fallbackError) {
                    showMessage('클립보드 복사에 실패했습니다.', 'error');
                    return false;
                }
            }
        }

        // 기본 데이터 구조
        function getDefaultData() {
            try {
                return {
                    film_id: 'FILM_NEW',
                    current_stage_name: 'scenario_breakdown',
                    timestamp: new Date().toISOString(),
                    schema_version: '1.1.0', 
                    film_metadata: {
                        title_working: getProjectName(),
                        confirmed_genre: ''
                    },
                    breakdown_data: {
                        sequences: [],
                        scenes: [],
                        shots: []
                    }
                };
            } catch (error) {
                console.error('기본 데이터 생성 오류:', error);
                return null;
            }
        }

        // 테스트용 JSON 데이터 생성 함수 (프롬프트 포함)
        function createTestData() {
            console.log('🧪 테스트 데이터 생성 중...');
            
            return {
                "film_id": "FILM_TEST001",
                // ... (기존 film_id, current_stage_name 등은 그대로) ...
                "film_metadata": {
                    "title_working": "테스트 영화",
                    "confirmed_genre": "SF",
                    // ▼▼▼ 프로젝트 전체 음악 정보 추가 ▼▼▼
                    "project_music_prompts": {
                        "main_ost": {
                            "style_prompt": "웅장하고 미래적인 메인 테마 (프로젝트 전체)",
                            "lyrics_structure_prompt": "A-B-A 구조의 기악곡, 반복적인 모티프 사용"
                        },
                        "sub_ost_1": {
                            "style_prompt": "긴장감 넘치는 추격씬용 음악 스타일 (프로젝트 전체)",
                            "lyrics_structure_prompt": "빠른 템포, 전자음악과 오케스트라 혼합"
                        },
                        "sub_ost_2": {
                            "style_prompt": "감성적인 장면을 위한 서정적인 피아노 선율 (프로젝트 전체)",
                            "lyrics_structure_prompt": "느린 템포, 미니멀한 구성"
                        }
                    },
                    "project_music_urls": { // 프로젝트 대표 음악 URL (예시)
                        "main_ost": "https://example.com/project_main_theme.mp3",
                        "sub_ost_1": "https://example.com/project_tension_theme.mp3",
                        "sub_ost_2": "" // 비워둘 수도 있음
                    }
                    // ▲▲▲ 프로젝트 전체 음악 정보 추가 끝 ▲▲▲
                },
                "breakdown_data": {
                    // ... (기존 source_data_references, sequences, scenes 등은 그대로) ...
                    "shots": [
                        {
                            "id": "S01.01",
                            // ... (기존 S01.01의 다른 필드들은 최대한 유지) ...
                            "content": {
                                "action": "레이븐이 컴퓨터 앞에 앉아 집중하며 키보드를 타이핑",
                                "dialogue": {
                                    "character-1": { "text": "이번 일은 좀 다르군...", "emotion": "집중", "voice_style": "차분하고 신중한" }
                                },
                                "narration": "그녀는 어둠 속에서 빛을 찾고 있었다.",
                                "sound_effects": "키보드 타이핑 소리, 컴퓨터 팬 소리, 빗소리",
                                "music": "", // 이 필드는 이제 shot.music_memo로 대체될 수 있으나, 호환성을 위해 남겨두거나 비워둘 수 있음
                                "audio_urls": {
                                    "dialogue": "https://example.com/audio/S01.01_dialogue.mp3",
                                    "narration": "https://example.com/audio/S01.01_narration.mp3",
                                    "sound_effects": "https://example.com/audio/S01.01_sfx.mp3"
                                    // 샷별 OST URL은 여기서 제거하고 프로젝트 레벨에서 관리
                                }
                            },
                            // ▼▼▼ 샷별 음악 메모 추가 ▼▼▼
                            "music_memo": "이 샷의 오프닝 시퀀스에는 프로젝트 메인 테마를 사용한다. 긴장감을 서서히 고조시키는 편곡.",
                            // ▲▲▲ 샷별 음악 메모 추가 끝 ▲▲▲
                            "audio_prompts": { // 기존 audio_prompts 내 music_prompts는 이제 사용하지 않음 (프로젝트 레벨로 이동)
                                "dialogue": { "prompt": "S01.01 Dialogue: ...", "settings": {} },
                                "narration": { "prompt": "S01.01 Narration: ...", "settings": {} },
                                "sound_effects": { "prompt": "S01.01 SFX: ...", "settings": {} }
                            }
                            // music_prompts 필드는 shot 객체에서 제거하거나 비워둠 (프로젝트 레벨로 이동했으므로)
                        },
                        {
                            "id": "S01.02",
                            // ... (기존 S01.02의 다른 필드들은 최대한 유지) ...
                            "content": {
                                "action": "레이븐의 표정 변화를 클로즈업으로 포착",
                                "narration": "그녀의 눈에는 결의가 담겨 있었다.",
                                "music": "", // 이 필드는 이제 shot.music_memo로 대체될 수 있음
                                "audio_urls": {}
                            },
                            // ▼▼▼ 샷별 음악 메모 추가 ▼▼▼
                            "music_memo": "이 샷은 감정씬이므로 프로젝트 서브 OST 2 (서정적 피아노)를 사용. 대사 없이 음악과 표정으로 전달.",
                            // ▲▲▲ 샷별 음악 메모 추가 끝 ▲▲▲
                            "audio_prompts": {}
                        }
                    ]
                }
            };
        }
        // JSON 데이터 로드
        async function loadData() {
            console.log('🔄 데이터 로드 시작...');
            try {
                const jsonFileName = getProjectFileName();
                console.log('📁 찾을 JSON 파일:', jsonFileName);
                try {
                    console.log('💾 로컬 스토리지 확인...');
                    const storedData = localStorage.getItem(`breakdownData_${jsonFileName}`);
                    if (storedData) {
                        currentData = JSON.parse(storedData);
                        showMessage('이전 작업 데이터를 복구했습니다.', 'info');
                        return true;
                    }
                } catch (storageError) { console.warn('⚠️ 로컬 스토리지 읽기 실패:', storageError.message); }
                
                if (window.location.protocol === 'http:' || window.location.protocol === 'https:') {
                    try {
                        const response = await fetch(jsonFileName);
                        if (response.ok) {
                            const data = await response.json();
                            if (data && typeof data === 'object') {
                                currentData = data;
                                saveDataToLocalStorage();
                                showMessage(`${jsonFileName} 파일을 자동으로 로드했습니다.`, 'success');
                                return true;
                            }
                        } else { console.log(`🤷 ${jsonFileName} 파일 없음 (${response.status})`); }
                    } catch (fetchError) { console.log('❌ JSON 파일 자동 로드 실패:', fetchError.message); }
                } else { console.log('📄 file:// 프로토콜 감지됨 - 자동 로드 생략'); }
                
                currentData = createTestData();
                saveDataToLocalStorage();
                showMessage( (window.location.protocol === 'file:' ? `테스트 데이터로 시작합니다. 'JSON 가져오기'로 실제 데이터를 로드할 수 있습니다.` : `${jsonFileName} 파일이 없어 테스트 데이터로 시작합니다.`), 'info');
                return true;
            } catch (error) {
                console.error('❌ 데이터 로드 전체 오류:', error);
                showMessage(`데이터 로드 오류: ${error.message}`, 'error');
                currentData = getDefaultData();
                saveDataToLocalStorage();
                return false;
            }
        }

        // 데이터 저장
        function saveDataToLocalStorage() {
            try {
                if (currentData) {
                    const jsonFileName = getProjectFileName();
                    localStorage.setItem(`breakdownData_${jsonFileName}`, JSON.stringify(currentData));
                    localStorage.setItem(`lastSaved_${jsonFileName}`, new Date().toISOString());
                    console.log('로컬 스토리지 저장 완료:', JSON.parse(JSON.stringify(currentData))); // 깊은 복사로 로그 순환 참조 방지
                }
            } catch (error) { console.error('로컬 스토리지 저장 오류:', error); showMessage('로컬 저장 실패: ' + error.message, 'error'); }
        }

        // JSON 내보내기
        function exportData() {
            console.log('JSON 내보내기 시작...');
            try {
                if (!currentData) return showMessage('저장할 데이터가 없습니다.', 'error');
                const jsonFileName = getProjectFileName();
                currentData.timestamp = new Date().toISOString();
                const blob = new Blob([JSON.stringify(currentData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = jsonFileName;
                document.body.appendChild(a); a.click();
                document.body.removeChild(a); URL.revokeObjectURL(url);
                localStorage.setItem(`lastSaved_${jsonFileName}`, new Date().toISOString());
                showMessage(`${jsonFileName} 파일이 저장되었습니다.`, 'success');
            } catch (error) { console.error('내보내기 오류:', error); showMessage(`내보내기 오류: ${error.message}`, 'error'); }
        }

        // JSON 가져오기
        function importData() {
            console.log('JSON 가져오기 시작...');
            document.getElementById('file-input')?.click();
        }
        
        // 파일 선택 및 병합/덮어쓰기 처리
        function handleFileSelect(event) {
            console.log('파일 선택 이벤트');
            const file = event.target.files[0];
            if (!file) { console.log('파일 선택 취소됨'); return; }

            console.log('선택된 파일:', file.name);
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const newData = JSON.parse(e.target.result);
                    let updated = false;

                    // 현재 데이터가 없거나, 가져온 데이터가 전체 구조를 가지고 있다면 (sequences 필드 기준) 전체 덮어쓰기
                    if (!currentData || (newData.breakdown_data && newData.breakdown_data.sequences)) {
                        console.log('전체 데이터 구조로 덮어씁니다.');
                        currentData = newData;
                        updated = true;
                        showMessage('JSON 데이터를 전체 로드했습니다.', 'success');
                    } 
                    // 가져온 데이터가 샷 중심의 업데이트 데이터일 경우 (shot_prompts 또는 breakdown_data.shots 존재 기준)
                    // (스테이지 6 스키마는 shot_prompts, 스테이지 7 스키마는 breakdown_data.shots 안에 video_prompts 등을 포함)
                    else if ((newData.shot_prompts || (newData.breakdown_data && newData.breakdown_data.shots)) && 
                               currentData && currentData.breakdown_data && currentData.breakdown_data.shots) {
                        console.log('샷 기반 데이터 병합을 시도합니다.');
                        const shotsToUpdate = newData.shot_prompts || newData.breakdown_data.shots;

                        shotsToUpdate.forEach(newShotData => {
                            // 스테이지 6은 shot_id, 스테이지 7은 id 를 사용하므로 둘 다 확인
                            const shotIdToFind = newShotData.shot_id || newShotData.id; 
                            const existingShot = currentData.breakdown_data.shots.find(shot => shot.id === shotIdToFind);

                            if (existingShot) {
                                console.log(`샷 ID ${shotIdToFind}에 대한 데이터 업데이트 중...`);
                                // 스테이지 6의 ai_prompts를 existingShot.image_prompts로 병합
                                if (newShotData.ai_prompts) {
                                    if (!existingShot.image_prompts) existingShot.image_prompts = {};
                                    Object.keys(newShotData.ai_prompts).forEach(aiKey => {
                                        existingShot.image_prompts[aiKey] = { ...existingShot.image_prompts[aiKey], ...newShotData.ai_prompts[aiKey] };
                                    });
                                    console.log(`  - image_prompts 업데이트됨.`);
                                    updated = true;
                                }
                                // 스테이지 7의 video_prompts, video_urls, final_video_selection, video_design 병합
                                ['video_prompts', 'video_urls', 'final_video_selection', 'video_design'].forEach(videoKey => {
                                    if (newShotData[videoKey]) {
                                        existingShot[videoKey] = { ...existingShot[videoKey], ...newShotData[videoKey] };
                                        console.log(`  - ${videoKey} 업데이트됨.`);
                                        updated = true;
                                    }
                                });
                                // 스테이지 7의 image_design (스테이지 5 구조) 처리 - HTML의 ai_generated_images와는 별개로, 있다면 업데이트
                                if (newShotData.image_design && newShotData.image_design.images) { // 스테이지 5/7의 images[]
                                    if (!existingShot.image_design) existingShot.image_design = {};
                                    existingShot.image_design.images = newShotData.image_design.images;
                                    // 만약 HTML의 ai_generated_images도 이 데이터 기준으로 채워야 한다면 추가 로직 필요
                                    console.log(`  - image_design.images 업데이트됨.`);
                                    updated = true;
                                }
                                // 참조 이미지 병합
                                if (newShotData.reference_images) {
                                    existingShot.reference_images = newShotData.reference_images;
                                    console.log(`  - reference_images 업데이트됨.`);
                                    updated = true;
                                }
                                 // 기타 content, camera_ 등등의 필드도 필요시 병합
                                ['content', 'camera_movement', 'camera_framing', 'camera_effects', 'other_info'].forEach(key => {
                                    if (newShotData[key]) {
                                        existingShot[key] = { ...existingShot[key], ...newShotData[key] };
                                        updated = true;
                                    }
                                });
                            } else {
                                console.warn(`가져온 데이터의 샷 ID ${shotIdToFind}를 현재 데이터에서 찾을 수 없습니다.`);
                            }
                        });
                        if(updated) showMessage('가져온 JSON의 샷 정보를 현재 데이터에 병합/업데이트했습니다.', 'success');
                        else showMessage('가져온 JSON에서 업데이트할 샷 정보를 찾지 못했거나, 변경사항이 없습니다.', 'info');

                    } else {
                        showMessage('가져온 JSON 파일의 구조를 인식할 수 없거나, 현재 데이터와 병합할 수 없습니다.', 'warning');
                        event.target.value = ''; // 파일 입력 초기화
                        return; 
                    }

                    saveDataToLocalStorage();
                    updateUI(); 
                    // 병합 후 현재 선택된 샷이 있다면 해당 탭 다시 로드
                    if (selectedType === 'shot' && selectedId) {
                        showShotContent(selectedId);
                        const lastActiveTab = localStorage.getItem(`shot_${selectedId}_activeTab`) || 'info';
                        setTimeout(() => switchTab(lastActiveTab, selectedId), 0);
                    }

                } catch (parseError) {
                    console.error('JSON 파싱 오류:', parseError);
                    showMessage(`JSON 파싱 오류: ${parseError.message}`, 'error');
                }
            };
            reader.onerror = function() {
                console.error('파일 읽기 오류');
                showMessage('파일 읽기 오류', 'error');
            };
            reader.readAsText(file);
            event.target.value = ''; 
        }


        // 검색 기능
        function searchNavigation() {
            const searchInput = document.getElementById('search-input');
            const searchTerm = searchInput.value.toLowerCase();
            if (!currentData || !currentData.breakdown_data) return;
            const sequenceItems = document.querySelectorAll('.sequence-item');
            sequenceItems.forEach(item => {
                const sequenceText = item.textContent.toLowerCase();
                const isVisible = searchTerm === '' || sequenceText.includes(searchTerm);
                item.style.display = isVisible ? 'block' : 'none';
                if (isVisible && searchTerm !== '') {
                    const scenesContainer = item.querySelector('.scenes-container');
                    if (scenesContainer && scenesContainer.classList.contains('collapsed')) {
                        item.querySelector('.sequence-header').click(); 
                    }
                }
            });
        }

        // 전체 펼치기/접기
        function expandAll() {
            document.querySelectorAll('.sequence-header').forEach(header => {
                const sequenceId = header.dataset.sequenceId;
                const scenesContainer = document.getElementById(`scenes-${sequenceId}`);
                if (scenesContainer && scenesContainer.classList.contains('collapsed')) {
                    header.click(); // selectSequence가 호출되면서 토글 및 로드
                }
            });
            setTimeout(() => {
                 document.querySelectorAll('.scene-header').forEach(header => {
                    const sceneId = header.dataset.sceneId;
                    const shotsContainer = document.getElementById(`shots-${sceneId}`);
                    if (shotsContainer && shotsContainer.classList.contains('collapsed')) {
                       header.click(); // selectScene이 호출되면서 토글 및 로드
                    }
                });
            }, 400); 
        }

        function collapseAll() {
            // 샷 먼저 접기 (씬을 접으면 샷도 같이 접힘)
            document.querySelectorAll('.scene-header').forEach(header => {
                const sceneId = header.dataset.sceneId;
                const shotsContainer = document.getElementById(`shots-${sceneId}`);
                if (shotsContainer && !shotsContainer.classList.contains('collapsed')) {
                    header.click();
                }
            });
            // 시퀀스 접기
            setTimeout(() => { // 씬이 완전히 접힌 후 시퀀스 접기
                document.querySelectorAll('.sequence-header').forEach(header => {
                    const sequenceId = header.dataset.sequenceId;
                    const scenesContainer = document.getElementById(`scenes-${sequenceId}`);
                    if (scenesContainer && !scenesContainer.classList.contains('collapsed')) {
                       header.click();
                    }
                });
            }, 400);
        }

        // UI 업데이트
        function updateUI() {
            console.log('UI 업데이트 시작...');
            try {
                updateHeaderInfo();
                updateNavigation();
                if (selectedId && selectedType) {
                    if (selectedType === 'shot') showShotContent(selectedId);
                    else if (selectedType === 'scene') showSceneContent(selectedId);
                    else if (selectedType === 'sequence') showSequenceContent(selectedId);
                } else {
                     document.getElementById('content-area').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">🎬</div>
                            <div>시퀀스, 씬, 또는 샷을 선택하여 상세 정보를 확인하세요</div>
                        </div>`;
                }
                console.log('UI 업데이트 완료');
            } catch (error) { console.error('UI 업데이트 오류:', error); showMessage('화면 업데이트 오류: ' + error.message, 'error'); }
        }

        // 헤더 정보 업데이트
        function updateHeaderInfo() {
            try {
                const projectName = getProjectName();
                const jsonFileName = getProjectFileName();
                const projectTitleEl = document.getElementById('project-title');
                const projectFileEl = document.getElementById('project-file');
                const navProjectTitleEl = document.getElementById('nav-project-title');
                const navProjectFileEl = document.getElementById('nav-project-file');
                if (projectTitleEl) projectTitleEl.textContent = currentData?.film_metadata?.title_working || projectName;
                if (projectFileEl) projectFileEl.textContent = `파일: ${jsonFileName}`;
                if (navProjectTitleEl) navProjectTitleEl.textContent = currentData?.film_metadata?.title_working || projectName;
                if (navProjectFileEl) navProjectFileEl.textContent = `파일: ${jsonFileName}`;
            } catch (error) { console.error('헤더 업데이트 오류:', error); }
        }

        // 네비게이션 업데이트
        function updateNavigation() {
            try {
                const navContent = document.getElementById('navigation-content');
                if (!navContent) return console.error('네비게이션 컨텐츠 요소를 찾을 수 없음');
                if (!currentData || !currentData.breakdown_data || !currentData.breakdown_data.sequences || currentData.breakdown_data.sequences.length === 0) {
                    navContent.innerHTML = `<div class="empty-state" id="nav-empty"><div class="empty-state-icon">📁</div><div>데이터가 없습니다</div><div style="font-size: 0.9rem; margin-top: 10px;">JSON 가져오기를 사용해 데이터를 로드해주세요</div></div>`;
                    return;
                }
                let html = '';
                currentData.breakdown_data.sequences.forEach(sequence => {
                    html += `<div class="sequence-item"><div class="sequence-header" data-sequence-id="${sequence.id}"><span class="toggle-icon">▶</span><span>${sequence.id}: ${sequence.title}</span></div><div class="scenes-container collapsed" id="scenes-${sequence.id}"></div></div>`;
                });
                navContent.innerHTML = html;
                setupSequenceEventListeners();
            } catch (error) { console.error('네비게이션 업데이트 오류:', error); showMessage('네비게이션 업데이트 오류: ' + error.message, 'error'); }
        }

        // 시퀀스 이벤트 리스너 설정
        function setupSequenceEventListeners() {
            try {
                document.querySelectorAll('.sequence-header[data-sequence-id]').forEach(header => {
                    const newHeader = header.cloneNode(true); header.parentNode.replaceChild(newHeader, header);
                    newHeader.addEventListener('click', function(e) { e.preventDefault(); selectSequence(this.getAttribute('data-sequence-id'), this); });
                });
            } catch (error) { console.error('시퀀스 이벤트 리스너 설정 오류:', error); }
        }

        // 시퀀스 선택 및 토글
        function selectSequence(sequenceId, headerElement = null) {
            try {
                const newlySelected = selectedId !== sequenceId || selectedType !== 'sequence';
                selectedType = 'sequence'; selectedId = sequenceId;
                document.querySelectorAll('.sequence-header.active, .scene-header.active, .shot-item.active').forEach(el => el.classList.remove('active'));
                const currentHeader = headerElement || document.querySelector(`.sequence-header[data-sequence-id="${sequenceId}"]`);
                if (currentHeader) currentHeader.classList.add('active');
                showSequenceContent(sequenceId);
                toggleSequenceScenes(sequenceId, newlySelected);
            } catch (error) { console.error('시퀀스 선택 오류:', error); showMessage('시퀀스 선택 오류: ' + error.message, 'error'); }
        }

        // 시퀀스의 씬들 토글
        function toggleSequenceScenes(sequenceId, forceOpen = false) {
            try {
                const scenesContainer = document.getElementById(`scenes-${sequenceId}`); if (!scenesContainer) return;
                const toggleIcon = scenesContainer.previousElementSibling.querySelector('.toggle-icon'); if (!toggleIcon) return;
                if (forceOpen || scenesContainer.classList.contains('collapsed')) {
                    scenesContainer.classList.remove('collapsed'); toggleIcon.classList.add('expanded'); toggleIcon.textContent = '▼';
                    loadScenesForSequence(sequenceId, scenesContainer);
                } else {
                    scenesContainer.classList.add('collapsed'); toggleIcon.classList.remove('expanded'); toggleIcon.textContent = '▶';
                }
            } catch (error) { console.error('씬 토글 오류:', error); }
        }

        // 시퀀스의 씬들 로드
        function loadScenesForSequence(sequenceId, container) {
            try {
                if (!currentData || !currentData.breakdown_data) return;
                const scenes = currentData.breakdown_data.scenes.filter(scene => scene.sequence_id === sequenceId);
                if (scenes.length === 0) { container.innerHTML = '<div style="padding: 15px 40px; color: #999; font-size: 0.9rem;">씬이 없습니다</div>'; return; }
                let html = '';
                scenes.forEach(scene => { html += `<div class="scene-item"><div class="scene-header" data-scene-id="${scene.id}"><span class="toggle-icon">▷</span><span>${scene.id}: ${scene.title}</span></div><div class="shots-container collapsed" id="shots-${scene.id}"></div></div>`; });
                container.innerHTML = html;
                container.querySelectorAll('.scene-header').forEach(header => {
                    const newHeader = header.cloneNode(true); header.parentNode.replaceChild(newHeader, header);
                    newHeader.addEventListener('click', function(e){ e.stopPropagation(); selectScene(this.dataset.sceneId, this); });
                });
            } catch (error) { console.error('씬 로드 오류:', error); }
        }

        // 씬 선택
        function selectScene(sceneId, headerElement = null) {
            try {
                const newlySelected = selectedId !== sceneId || selectedType !== 'scene';
                selectedType = 'scene'; selectedId = sceneId; selectedSceneId = sceneId;
                document.querySelectorAll('.scene-header.active, .shot-item.active').forEach(el => el.classList.remove('active'));
                const scene = currentData.breakdown_data.scenes.find(s => s.id === sceneId);
                if (scene) document.querySelector(`.sequence-header[data-sequence-id="${scene.sequence_id}"]`)?.classList.add('active');
                const currentHeader = headerElement || document.querySelector(`.scene-header[data-scene-id="${sceneId}"]`);
                if(currentHeader) currentHeader.classList.add('active');
                showSceneContent(sceneId);
                toggleSceneShots(sceneId, newlySelected);
            } catch (error) { console.error('씬 선택 오류:', error); showMessage('씬 선택 오류: ' + error.message, 'error'); }
        }

        // 씬의 샷들 토글
        function toggleSceneShots(sceneId, forceOpen = false) {
            try {
                const shotsContainer = document.getElementById(`shots-${sceneId}`); if(!shotsContainer) return;
                const toggleIcon = shotsContainer.previousElementSibling.querySelector('.toggle-icon'); if(!toggleIcon) return;
                if (forceOpen || shotsContainer.classList.contains('collapsed')) {
                    shotsContainer.classList.remove('collapsed'); toggleIcon.classList.add('expanded'); toggleIcon.textContent = '▽';
                    loadShotsForScene(sceneId, shotsContainer);
                } else {
                    shotsContainer.classList.add('collapsed'); toggleIcon.classList.remove('expanded'); toggleIcon.textContent = '▷';
                }
            } catch (error) { console.error('샷 토글 오류:', error); }
        }

        // 씬의 샷들 로드
        function loadShotsForScene(sceneId, container) {
            try {
                if (!currentData || !currentData.breakdown_data) return;
                const shots = currentData.breakdown_data.shots.filter(shot => shot.scene_id === sceneId);
                if (shots.length === 0) { container.innerHTML = '<div style="padding: 15px 60px; color: #999; font-size: 0.9rem;">샷이 없습니다</div>'; return; }
                let html = '';
                shots.forEach(shot => { html += `<div class="shot-item" data-shot-id="${shot.id}"><span>${shot.id}: ${shot.title}</span></div>`; });
                container.innerHTML = html;
                 container.querySelectorAll('.shot-item').forEach(item => {
                    const newItem = item.cloneNode(true); item.parentNode.replaceChild(newItem, item);
                    newItem.addEventListener('click', function(e){ e.stopPropagation(); selectShot(this.dataset.shotId, this); });
                });
            } catch (error) { console.error('샷 로드 오류:', error); }
        }

        // 샷 선택
        function selectShot(shotId, element = null) {
            try {
                selectedType = 'shot'; selectedId = shotId;
                document.querySelectorAll('.shot-item.active').forEach(el => el.classList.remove('active'));
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
                if (shot) {
                    const scene = currentData.breakdown_data.scenes.find(sc => sc.id === shot.scene_id);
                    if (scene) {
                        document.querySelector(`.scene-header[data-scene-id="${scene.id}"]`)?.classList.add('active');
                        document.querySelector(`.sequence-header[data-sequence-id="${scene.sequence_id}"]`)?.classList.add('active');
                    }
                }
                const currentElement = element || document.querySelector(`.shot-item[data-shot-id="${shotId}"]`);
                if(currentElement) currentElement.classList.add('active');
                showShotContent(shotId);
            } catch (error) { console.error('샷 선택 오류:', error); showMessage('샷 선택 오류: ' + error.message, 'error'); }
        }

        // 시퀀스 내용 표시
        function showSequenceContent(sequenceId) {
            try {
                const sequence = currentData.breakdown_data.sequences.find(s => s.id === sequenceId);
                if (!sequence) return console.error('시퀀스를 찾을 수 없음:', sequenceId);
                document.getElementById('content-title').textContent = `시퀀스: ${sequence.title}`;
                document.getElementById('content-subtitle').textContent = `ID: ${sequence.id}`;
                document.getElementById('content-actions').style.display = 'none';
                document.getElementById('content-area').innerHTML = `<div class="info-section"><h3>시퀀스 정보</h3><table class="info-table"><tr><th>ID</th><td>${sequence.id}</td></tr><tr><th>제목</th><td>${sequence.title}</td></tr><tr><th>기능</th><td>${sequence.function || '-'}</td></tr><tr><th>설명</th><td>${sequence.description || '-'}</td></tr><tr><th>예상 길이</th><td>${sequence.duration_estimate || '-'}</td></tr></table></div>`;
            } catch (error) { console.error('시퀀스 내용 표시 오류:', error); showMessage('시퀀스 내용 표시 오류: ' + error.message, 'error'); }
        }

        // 씬 내용 표시
        function showSceneContent(sceneId) {
            try {
                const scene = currentData.breakdown_data.scenes.find(s => s.id === sceneId);
                if (!scene) return console.error('씬을 찾을 수 없음:', sceneId);
                document.getElementById('content-title').textContent = `씬: ${scene.title}`;
                document.getElementById('content-subtitle').textContent = `ID: ${scene.id}`;
                document.getElementById('content-actions').style.display = 'none';
                document.getElementById('content-area').innerHTML = `<div class="info-section"><h3>씬 정보</h3><table class="info-table"><tr><th>ID</th><td>${scene.id}</td></tr><tr><th>제목</th><td>${scene.title}</td></tr><tr><th>소속 시퀀스</th><td>${scene.sequence_id || '-'}</td></tr><tr><th>설명</th><td>${scene.description || '-'}</td></tr></table></div>
                    ${scene.visual_consistency_info ? `<div class="info-section"><h3>비주얼 정보</h3><table class="info-table"><tr><th>장소 ID</th><td>${scene.visual_consistency_info.location_id || '-'}</td></tr><tr><th>캐릭터 ID</th><td>${(scene.visual_consistency_info.character_ids || []).join(', ') || '-'}</td></tr><tr><th>소품 ID</th><td>${(scene.visual_consistency_info.prop_ids || []).join(', ') || '-'}</td></tr></table></div>` : ''}`;
            } catch (error) { console.error('씬 내용 표시 오류:', error); showMessage('씬 내용 표시 오류: ' + error.message, 'error'); }
        }

        // 샷 내용 표시 (탭 포함)
        function showShotContent(shotId) {
            try {
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
                if (!shot) return console.error('샷을 찾을 수 없음:', shotId);
                document.getElementById('content-title').textContent = `샷: ${shot.title}`;
                document.getElementById('content-subtitle').textContent = `ID: ${shot.id}`;
                document.getElementById('content-actions').style.display = 'none';
                const lastActiveTab = localStorage.getItem(`shot_${shotId}_activeTab`) || 'info';
                document.getElementById('content-area').innerHTML = `
                    <div class="tabs">
                        <div class="tab-buttons">
                            <button class="tab-button ${lastActiveTab === 'info' ? 'active' : ''}" onclick="switchTab('info', '${shotId}')">정보</button>
                            <button class="tab-button ${lastActiveTab === 'image' ? 'active' : ''}" onclick="switchTab('image', '${shotId}')">이미지</button>
                            <button class="tab-button ${lastActiveTab === 'video' ? 'active' : ''}" onclick="switchTab('video', '${shotId}')">영상</button>
                            <button class="tab-button ${lastActiveTab === 'audio' ? 'active' : ''}" onclick="switchTab('audio', '${shotId}')">오디오</button>
                            <button class="tab-button ${lastActiveTab === 'music' ? 'active' : ''}" onclick="switchTab('music', '${shotId}')">음악</button>
                        </div>
                        <div id="tab-info" class="tab-content ${lastActiveTab === 'info' ? 'active' : ''}" style="display: ${lastActiveTab === 'info' ? 'block' : 'none'};">${createShotInfoTab(shot)}</div>
                        <div id="tab-image" class="tab-content ${lastActiveTab === 'image' ? 'active' : ''}" style="display: ${lastActiveTab === 'image' ? 'block' : 'none'};">${createShotImageTab(shot)}</div>
                        <div id="tab-video" class="tab-content ${lastActiveTab === 'video' ? 'active' : ''}" style="display: ${lastActiveTab === 'video' ? 'block' : 'none'};">${createShotVideoTab(shot)}</div>
                        <div id="tab-audio" class="tab-content ${lastActiveTab === 'audio' ? 'active' : ''}" style="display: ${lastActiveTab === 'audio' ? 'block' : 'none'};">${createShotAudioTab(shot)}</div>
                        <div id="tab-music" class="tab-content ${lastActiveTab === 'music' ? 'active' : ''}" style="display: ${lastActiveTab === 'music' ? 'block' : 'none'};">${createShotMusicTab(shot)}</div>
                    </div>`;
            } catch (error) { console.error('샷 내용 표시 오류:', error); showMessage('샷 내용 표시 오류: ' + error.message, 'error'); }
        }

        // 탭 전환
        function switchTab(tabName, shotId = null) { 
            try {
                const tabContainer = document.querySelector('.tabs'); if (!tabContainer) return;
                tabContainer.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                tabContainer.querySelectorAll('.tab-content').forEach(content => { content.style.display = 'none'; content.classList.remove('active'); });
                const activeButton = tabContainer.querySelector(`[onclick*="switchTab('${tabName}'"]`);
                const activeContent = document.getElementById(`tab-${tabName}`);
                if (activeButton) activeButton.classList.add('active');
                if (activeContent) { activeContent.style.display = 'block'; activeContent.classList.add('active');}
                if (shotId) localStorage.setItem(`shot_${shotId}_activeTab`, tabName);
            } catch (error) { console.error('탭 전환 오류:', error); showMessage('탭 전환 중 오류가 발생했습니다.', 'error'); }
        }

        // 샷 정보 탭 생성
        function createShotInfoTab(shot) {
            return `
                <div class="info-section"><h3>기본 정보</h3><table class="info-table"><tr><th>ID</th><td>${shot.id}</td></tr><tr><th>제목</th><td>${shot.title}</td></tr><tr><th>소속 씬</th><td>${shot.scene_id || '-'}</td></tr><tr><th>샷 유형</th><td>${shot.shot_type || '-'}</td></tr><tr><th>설명</th><td>${shot.description || '-'}</td></tr><tr><th>예상 길이</th><td>${shot.other_info?.estimated_duration || '-'}초</td></tr></table></div>
                <div class="info-section"><h3>메모</h3><textarea class="form-textarea" placeholder="이 샷에 대한 메모..." onchange="updateShotMemo('${shot.id}', this.value)">${getShotMemo(shot.id)}</textarea><small style="color:#666;font-size:0.85rem;">메모는 자동으로 저장됩니다.</small></div>
                ${shot.visual_consistency_info ? `<div class="info-section"><h3>비주얼 일관성 정보</h3><table class="info-table"><tr><th>장소 ID</th><td>${shot.visual_consistency_info.location_id || '-'}</td></tr><tr><th>캐릭터 ID</th><td>${(shot.visual_consistency_info.character_ids || []).join(', ') || '-'}</td></tr><tr><th>소품 ID</th><td>${(shot.visual_consistency_info.prop_ids || []).join(', ') || '-'}</td></tr></table></div>` : ''}
                ${shot.camera_framing ? `<div class="info-section"><h3>카메라 정보</h3><table class="info-table"><tr><th>프레이밍</th><td>${shot.camera_framing.framing || '-'}</td></tr><tr><th>앵글</th><td>${shot.camera_framing.angle || '-'}</td></tr><tr><th>시점 방향</th><td>${shot.camera_framing.view_direction || '-'}</td></tr><tr><th>구도</th><td>${shot.camera_framing.composition || '-'}</td></tr></table></div>` : ''}
                ${shot.content ? `<div class="info-section"><h3>콘텐츠</h3><table class="info-table"><tr><th>액션</th><td>${shot.content.action || '-'}</td></tr><tr><th>음향 효과</th><td>${shot.content.sound_effects || '-'}</td></tr><tr><th>나레이션</th><td>${shot.content.narration || '-'}</td></tr></table></div>` : ''}`;
        }

        // 샷 이미지 탭 생성 (4개 AI 섹션 및 AI별 이미지 3개 슬롯 방식)
        function createShotImageTab(shot) {
            console.log('🖼️ createShotImageTab 시작 (4 AI 섹션 방식)');
            try {
                const imagePrompts = shot.image_prompts || {};
                const aiGeneratedImages = shot.image_design?.ai_generated_images || {};
                const referenceImagesData = shot.reference_images || [];

                const imageAIs = [ { id: 'midjourney', name: 'Midjourney' }, { id: 'ideogram', name: 'Ideogram' }, { id: 'leonardo', name: 'Leonardo' }, { id: 'imagefx', name: 'ImageFX' } ];
                let aiSectionsHtml = imageAIs.map(ai => {
                    const currentAiPrompts = imagePrompts[ai.id] || {};
                    const mainPrompt = currentAiPrompts.main_prompt || '프롬프트가 없습니다.';
                    const parameters = currentAiPrompts.parameters || '';
                    const fullPromptForCopy = `${mainPrompt}${parameters ? ` ${parameters}` : ''}`.replace(/'/g, "&#39;").replace(/"/g, "&quot;").replace(/\n/g, "\\n");
                    let imageSlotsHtml = '';
                    for (let i = 0; i < 3; i++) { 
                        const imageSlotData = aiGeneratedImages[ai.id]?.[i] || { url: '', description: '' };
                        const uniqueSlotId = `${shot.id}-${ai.id}-img${i}`;
                        imageSlotsHtml += `
                            <div class="image-slot-card" id="slot-card-${uniqueSlotId}">
                                <div class="image-slot-preview" id="slot-preview-${uniqueSlotId}">${imageSlotData.url ? `<img src="${imageSlotData.url}" alt="${ai.name} 이미지 ${i+1}" onerror="this.style.display='none'; this.parentElement.innerHTML = '<div style=&quot;color: #999; font-size: 0.8rem;&quot;>로드 실패</div>';">` : `<div style="color: #999; font-size: 0.8rem;">URL 입력</div>`}</div>
                                <div class="form-group"><label class="form-label" for="slot-url-${uniqueSlotId}">URL:</label><input type="text" class="form-input" id="slot-url-${uniqueSlotId}" value="${imageSlotData.url || ''}" placeholder="${ai.name} ${i+1} URL" onchange="updateAIGeneratedImageUrl('${shot.id}', '${ai.id}', ${i}, this.value)"></div>
                                <div class="form-group"><label class="form-label" for="slot-desc-${uniqueSlotId}">설명:</label><textarea class="form-textarea" id="slot-desc-${uniqueSlotId}" placeholder="${ai.name} ${i+1} 설명" onchange="updateAIGeneratedImageDescription('${shot.id}', '${ai.id}', ${i}, this.value)">${imageSlotData.description || ''}</textarea></div>
                                <div class="image-slot-actions"><button class="btn btn-small btn-secondary" onclick="openImageModal('${imageSlotData.url || ''}')" ${!imageSlotData.url ? 'disabled' : ''}>크게 보기</button></div>
                            </div>`;
                    }
                    return `
                        <div class="ai-image-section ${ai.id}" id="ai-section-${shot.id}-${ai.id}">
                            <div class="ai-card-header">${ai.name}</div>
                            <div class="ai-image-prompt-details">
                                <label class="prompt-text-label">AI 생성 프롬프트 (프롬프트 + 파라미터):</label>
                                <div class="ai-image-prompt-full-text">${mainPrompt}${parameters ? ` <br><strong style='font-family: inherit; font-size:0.9em; color:#555'>Parameters:</strong> ${parameters}` : ''}</div>
                                <button class="copy-btn" onclick="copyImageAIPrompt('${fullPromptForCopy}', '${ai.name}')">전체 프롬프트 복사</button>
                            </div>
                            <h4>생성된 이미지 (최대 3개)</h4><div class="generated-images-grid">${imageSlotsHtml}</div>
                        </div>`;
                }).join('');
                let referenceSlotsHtml = '';
                for (let i = 0; i < 3; i++) {
                    const refData = referenceImagesData[i] || { url: '', description: '', type: 'composition' };
                    const uniqueRefId = `${shot.id}-ref${i}`;
                    referenceSlotsHtml += `
                        <div class="reference-image-slot" id="ref-slot-card-${uniqueRefId}">
                             <div class="reference-preview" id="ref-preview-${uniqueRefId}">${refData.url ? `<img src="${refData.url}" alt="참조 ${i+1}" onerror="this.style.display='none'; this.parentElement.innerHTML = '<div style=&quot;color:#999;font-size:0.8rem;&quot;>로드 실패</div>';">` : `<div style="color:#999;font-size:0.8rem;">참조 ${i+1} URL</div>`}</div>
                            <div class="form-group"><label class="form-label" for="ref-url-${uniqueRefId}">URL:</label><input type="text" class="form-input" id="ref-url-${uniqueRefId}" value="${refData.url || ''}" placeholder="참조 ${i+1} URL" onchange="updateReferenceImage('${shot.id}', ${i}, 'url', this.value)"></div>
                            <div class="form-group"><label class="form-label" for="ref-desc-${uniqueRefId}">설명:</label><textarea class="form-textarea" id="ref-desc-${uniqueRefId}" onchange="updateReferenceImage('${shot.id}', ${i}, 'description', this.value)" placeholder="참조 ${i+1} 설명">${refData.description || ''}</textarea></div>
                            <div class="form-group"><label class="form-label" for="ref-type-${uniqueRefId}">유형:</label><select class="form-select" id="ref-type-${uniqueRefId}" onchange="updateReferenceImage('${shot.id}', ${i}, 'type', this.value)">
                                <option value="composition" ${refData.type === 'composition' ? 'selected' : ''}>구도</option><option value="style" ${refData.type === 'style' ? 'selected' : ''}>스타일</option><option value="appearance" ${refData.type === 'appearance' ? 'selected' : ''}>외형</option><option value="lighting" ${refData.type === 'lighting' ? 'selected' : ''}>조명</option><option value="mood" ${refData.type === 'mood' ? 'selected' : ''}>분위기</option></select></div>
                            <button class="btn btn-small btn-danger" onclick="clearReferenceImageSlot('${shot.id}', ${i})">이 슬롯 비우기</button>
                        </div>`;
                }
                return `
                    <div class="info-section"><h3>🎨 AI 이미지 생성 및 관리</h3><p style="font-size:0.9em;color:#555;margin-bottom:20px;">각 AI 도구별 프롬프트를 확인하고, 생성된 이미지를 최대 3개까지 등록 및 관리하세요.</p><div class="image-ai-grid">${aiSectionsHtml}</div></div>
                    <div class="info-section reference-image-slots-container"><h3>🖼️ 참조 이미지 (3개 슬롯)</h3><p style="font-size:0.9em;color:#555;margin-bottom:20px;">이미지 생성 시 참고할 이미지를 등록하세요.</p><div class="reference-image-slots-grid">${referenceSlotsHtml}</div></div>
                    <div id="imageDisplayModal" class="image-modal" onclick="closeImageModal(event)"><span class="image-modal-close" onclick="closeImageModal(event)">&times;</span><img class="image-modal-content" id="modalImageContent"></div>`;
            } catch (error) { console.error('❌ createShotImageTab 오류:', error); return `<div class="info-section"><h3>이미지 탭 로드 오류</h3><p>${error.message}</p></div>`; }
        }

        // AI 이미지 프롬프트 (프롬프트+파라미터) 복사 함수
        function copyImageAIPrompt(fullPrompt, aiName) {
            const actualFullPrompt = fullPrompt.replace(/\\n/g, "\n");
            if (!actualFullPrompt || actualFullPrompt.trim() === '프롬프트가 없습니다.') return showMessage(`${aiName} 프롬프트가 비어 복사 불가.`, 'warning');
            copyToClipboard(actualFullPrompt).then(ok => ok && showMessage(`${aiName} 전체 프롬프트 복사됨.`, 'success'));
        }

        // AI별 생성 이미지 URL 업데이트 함수
        function updateAIGeneratedImageUrl(shotId, aiType, imageIndex, newUrl) {
            try {
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId); if (!shot) return showMessage('샷 데이터 없음.', 'error');
                if (!shot.image_design) shot.image_design = { aspect_ratio: "16:9" };
                if (!shot.image_design.ai_generated_images) shot.image_design.ai_generated_images = {};
                if (!shot.image_design.ai_generated_images[aiType]) shot.image_design.ai_generated_images[aiType] = [null,null,null].map(()=>({url:'', description:''}));
                if (imageIndex < 3) {
                    if (!shot.image_design.ai_generated_images[aiType][imageIndex]) shot.image_design.ai_generated_images[aiType][imageIndex] = { url: newUrl, description: '' };
                    else shot.image_design.ai_generated_images[aiType][imageIndex].url = newUrl;
                }
                saveDataToLocalStorage();
                const uid = `${shotId}-${aiType}-img${imageIndex}`;
                const preview = document.getElementById(`slot-preview-${uid}`);
                const viewBtn = document.querySelector(`#slot-card-${uid} .image-slot-actions button`);
                if (preview) {
                    if (newUrl) { preview.innerHTML = `<img src="${newUrl}" alt="${aiType} ${imageIndex+1}" onerror="this.style.display='none';this.parentElement.innerHTML='<div style=&quot;color:#999;font-size:0.8rem;&quot;>로드 실패</div>';">`; if(viewBtn) viewBtn.disabled = false; }
                    else { preview.innerHTML = `<div style="color:#999;font-size:0.8rem;">URL 입력</div>`; if(viewBtn) viewBtn.disabled = true; }
                }
            } catch (e) { console.error("URL 업데이트 오류:", e); showMessage('URL 업데이트 오류', 'error');}
        }

        // AI별 생성 이미지 설명 업데이트 함수
        function updateAIGeneratedImageDescription(shotId, aiType, imageIndex, newDescription) {
            try {
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId); if (!shot) return showMessage('샷 데이터 없음.', 'error');
                if (!shot.image_design) shot.image_design = { aspect_ratio: "16:9" };
                if (!shot.image_design.ai_generated_images) shot.image_design.ai_generated_images = {};
                if (!shot.image_design.ai_generated_images[aiType]) shot.image_design.ai_generated_images[aiType] = [null,null,null].map(()=>({url:'', description:''}));
                if (imageIndex < 3) {
                    if (!shot.image_design.ai_generated_images[aiType][imageIndex]) shot.image_design.ai_generated_images[aiType][imageIndex] = { url: '', description: newDescription };
                    else shot.image_design.ai_generated_images[aiType][imageIndex].description = newDescription;
                    saveDataToLocalStorage();
                }
            } catch (e) { console.error("설명 업데이트 오류:", e); showMessage('설명 업데이트 오류', 'error');}
        }
        
        // 참조 이미지 업데이트 함수
        function updateReferenceImage(shotId, refIndex, field, value) {
            try {
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId); if (!shot) return showMessage('샷 데이터 없음.', 'error');
                if (!shot.reference_images) shot.reference_images = [];
                while (shot.reference_images.length <= refIndex) { shot.reference_images.push({ id: `ref_img_${shot.reference_images.length + 1}_${shotId}`, url: '', description: '', type: 'composition' }); }
                shot.reference_images[refIndex][field] = value;
                if (!shot.reference_images[refIndex].id) shot.reference_images[refIndex].id = `ref_img_${refIndex + 1}_${shotId}`;
                saveDataToLocalStorage();
                if (field === 'url') { 
                    const uid = `${shotId}-ref${refIndex}`;
                    const preview = document.getElementById(`ref-preview-${uid}`);
                    if (preview) {
                        if (value) preview.innerHTML = `<img src="${value}" alt="참조 ${refIndex+1}" onerror="this.style.display='none';this.parentElement.innerHTML='<div style=&quot;color:#999;font-size:0.8rem;&quot;>로드 실패</div>';">`;
                        else preview.innerHTML = `<div style="color:#999;font-size:0.8rem;">참조 ${refIndex+1} URL</div>`;
                    }
                }
            } catch (e) { console.error("참조 이미지 업데이트 오류:", e); showMessage('참조 이미지 업데이트 오류', 'error');}
        }

        // 참조 이미지 슬롯 비우기 함수
        function clearReferenceImageSlot(shotId, refIndex) {
            try {
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
                if (shot && shot.reference_images && shot.reference_images[refIndex]) {
                    shot.reference_images[refIndex] = { id: `ref_img_${refIndex + 1}_${shotId}`, url: '', description: '', type: 'composition' };
                    saveDataToLocalStorage();
                }
                const uid = `${shotId}-ref${refIndex}`;
                const urlIn = document.getElementById(`ref-url-${uid}`); if(urlIn) urlIn.value='';
                const descIn = document.getElementById(`ref-desc-${uid}`); if(descIn) descIn.value='';
                const typeSel = document.getElementById(`ref-type-${uid}`); if(typeSel) typeSel.value='composition';
                const preview = document.getElementById(`ref-preview-${uid}`); if(preview) preview.innerHTML = `<div style="color:#999;font-size:0.8rem;">참조 ${refIndex+1} URL</div>`;
                showMessage(`참조 이미지 슬롯 ${refIndex+1} 비워짐.`, 'success');
            } catch (e) { console.error("참조 슬롯 비우기 오류:", e); showMessage('참조 슬롯 비우기 오류', 'error');}
        }

        // 이미지 크게 보기 모달 열기/닫기
        function openImageModal(imageUrl) {
            const modal = document.getElementById('imageDisplayModal'); const modalImg = document.getElementById('modalImageContent');
            if (modal && modalImg && imageUrl && imageUrl.trim() !== '') { modalImg.src = imageUrl; modal.style.display = "flex"; } 
            else if (!imageUrl || imageUrl.trim() === '') { showMessage('이미지 URL이 없어 크게 볼 수 없습니다.', 'warning'); }
        }
        function closeImageModal(event) { 
            const modal = document.getElementById('imageDisplayModal');
            if (modal && ( (event && event.target === modal) || (event && event.target.classList.contains('image-modal-close')) || !event ) ) { // X버튼 또는 배경 클릭
                modal.style.display = "none"; document.getElementById('modalImageContent').src = ""; 
            }
        }

        // Deprecated image functions (for reference or future migration, not active use)
        function updateImageUrl(s,i,n){console.warn("updateImageUrl deprecated")} function updateImageDescription(s,i,n){console.warn("updateImageDescription deprecated")} function addNewImage(s){console.warn("addNewImage deprecated");showMessage('AI섹션 슬롯 이용','info')} function removeReference(s,i){console.warn("removeReference deprecated");clearReferenceImageSlot(s,i)} function updateReferenceType(s,i,n){console.warn("updateReferenceType deprecated");updateReferenceImage(s,i,'type',n)} function updateReferenceUrl(s,i,n){console.warn("updateReferenceUrl deprecated");updateReferenceImage(s,i,'url',n)} function updateReferenceDescription(s,i,n){console.warn("updateReferenceDescription deprecated");updateReferenceImage(s,i,'description',n)} function addNewReference(s){console.warn("addNewReference deprecated");showMessage('참조 슬롯은 항상 3개 표시','info')}

        // 샷 영상 탭 생성 (4개 AI 카드 방식)
        function createShotVideoTab(shot) {
            console.log('🎥 createShotVideoTab 시작 (4 AI 카드 방식)');
            try {
                const videoPrompts = shot.video_prompts || {}; const videoUrls = shot.video_urls || {}; const selectedAi = shot.video_design?.selected_ai || null; 
                const aiTools = [ { id: 'luma', name: 'Luma AI', prompt: videoPrompts.luma?.main_prompt, settings: videoPrompts.luma?.settings, url: videoUrls.luma }, { id: 'kling', name: 'Kling AI', prompt: videoPrompts.kling?.main_prompt, settings: videoPrompts.kling?.settings, url: videoUrls.kling }, { id: 'veo2', name: 'Google Veo 2', prompt: videoPrompts.veo2?.main_prompt, settings: videoPrompts.veo2?.settings, url: videoUrls.veo2 }, { id: 'runway', name: 'Runway ML', prompt: videoPrompts.runway?.main_prompt, settings: videoPrompts.runway?.settings, url: videoUrls.runway } ];
                let cardsHtml = aiTools.map(ai => {
                    const isSelected = selectedAi === ai.id; const promptForCopy = (ai.prompt || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;").replace(/\n/g, "\\n");
                    let settingsHtml = ai.settings && Object.keys(ai.settings).length > 0 ? `<div class="ai-settings-info"><strong>설정:</strong> ${JSON.stringify(ai.settings)}</div>` : `<div class="ai-settings-info">설정 정보가 없습니다.</div>`;
                    return `
                        <div class="ai-video-card ${ai.id} ${isSelected ? 'selected-ai-card' : ''}" id="ai-card-${shot.id}-${ai.id}">
                            <div class="ai-card-header">${ai.name}</div>
                            <div class="ai-card-content">
                                <div class="ai-prompt-area"><label class="form-label">영상 생성 프롬프트:</label><div class="prompt-text" id="prompt-text-${shot.id}-${ai.id}">${ai.prompt || '프롬프트가 없습니다.'}</div><button class="copy-prompt-btn" onclick="copyAIPrompt('${promptForCopy}', '${ai.name}')">프롬프트 복사</button></div>
                                <div class="form-group"><label class="form-label">영상 URL:</label><input type="text" class="form-input" value="${ai.url || ''}" placeholder="${ai.name} 영상 URL" onchange="updateAIVideoUrl('${shot.id}', '${ai.id}', this.value)"></div>
                                <div class="ai-video-preview" id="video-preview-${shot.id}-${ai.id}">${ai.url ? `<video controls style="max-width:100%;max-height:200px;border-radius:6px;" src="${ai.url}" onerror="this.style.display='none';this.parentElement.innerHTML='<div style=&quot;color:#999;font-size:0.9rem;&quot;>로드 실패</div>';"></video>` : `<div style="color:#999;font-size:0.9rem;">URL 입력</div>`}</div>
                                ${settingsHtml}
                            </div>
                            <button class="ai-select-button ${isSelected ? 'selected' : ''}" id="select-btn-${shot.id}-${ai.id}" onclick="selectFinalAI('${shot.id}', '${ai.id}')">${isSelected ? '✓ 최종 선택됨' : `이 AI로 최종 선택`}</button>
                        </div>`;
                }).join('');
                return `
                    <div class="info-section"><h3>🎬 AI 기반 영상 생성 관리</h3><p style="font-size:0.9em;color:#555;margin-bottom:20px;">AI 도구별 프롬프트를 확인하고, 생성된 영상 URL을 입력하여 관리하세요. 최종 사용할 영상을 선택할 수 있습니다.</p><div class="video-ai-grid">${cardsHtml}</div></div>
                    <div class="info-section" style="margin-top:30px;"><h3>기존 영상 정보 (참고용)</h3><table class="info-table"><tr><th>최종 선택 AI</th><td id="legacy-ai-tool-${shot.id}">${shot.video_design?.selected_ai || shot.video_design?.ai_tool || '-'}</td></tr><tr><th>최종 영상 URL</th><td id="legacy-video-url-${shot.id}">${shot.video_design?.video_url || '-'}</td></tr></table><small style="color:#777;font-size:0.85em;">선택된 AI의 정보가 여기에 반영됩니다.</small></div>`;
            } catch (e) { console.error('❌ createShotVideoTab 오류:', e); return `<div class="info-section"><h3>영상 탭 로드 오류</h3><p>${e.message}</p></div>`; }
        }

        // AI 영상 프롬프트 복사 함수
        function copyAIPrompt(promptText, aiName) {
            const actualPromptText = promptText.replace(/\\n/g, "\n");
            if (!actualPromptText || actualPromptText.trim() === '프롬프트가 없습니다.') return showMessage(`${aiName} 프롬프트 비어 복사 불가.`, 'warning');
            copyToClipboard(actualPromptText).then(ok => ok && showMessage(`${aiName} 영상 프롬프트 복사됨.`, 'success'));
        }

        // AI별 영상 URL 업데이트 함수
        function updateAIVideoUrl(shotId, aiType, newUrl) {
            try {
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId); if (!shot) return showMessage('샷 데이터 없음.', 'error');
                if (!shot.video_urls) shot.video_urls = {}; shot.video_urls[aiType] = newUrl;
                if (!shot.video_design) shot.video_design = { ai_tool: '', video_url: '', selected_ai: null };
                if (shot.video_design.selected_ai === aiType) {
                    shot.video_design.video_url = newUrl;
                    const legacyUrlCell = document.getElementById(`legacy-video-url-${shot.id}`); if (legacyUrlCell) legacyUrlCell.textContent = newUrl || '-';
                    const legacyAiToolCell = document.getElementById(`legacy-ai-tool-${shot.id}`); if (legacyAiToolCell) legacyAiToolCell.textContent = aiType || '-';
                }
                saveDataToLocalStorage();
                const preview = document.getElementById(`video-preview-${shot.id}-${aiType}`);
                if (preview) {
                    if (newUrl) preview.innerHTML = `<video controls style="max-width:100%;max-height:200px;border-radius:6px;" src="${newUrl}" onerror="this.style.display='none';this.parentElement.innerHTML='<div style=&quot;color:#999;font-size:0.9rem;&quot;>로드 실패</div>';"></video>`;
                    else preview.innerHTML = `<div style="color:#999;font-size:0.9rem;">URL 입력</div>`;
                }
            } catch (e) { console.error("영상 URL 업데이트 오류:", e); showMessage('영상 URL 업데이트 오류', 'error');}
        }

        // 최종 AI 선택 함수
        function selectFinalAI(shotId, aiType) {
            try {
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId); if (!shot) return showMessage('샷 데이터 없음.', 'error');
                if (!shot.video_design) shot.video_design = { ai_tool: aiType, video_url: '', selected_ai: aiType };
                else { shot.video_design.selected_ai = aiType; shot.video_design.ai_tool = aiType; }
                if (!shot.video_urls) shot.video_urls = {}; shot.video_design.video_url = shot.video_urls[aiType] || '';
                saveDataToLocalStorage();
                ['luma', 'kling', 'veo2', 'runway'].forEach(id => {
                    const card = document.getElementById(`ai-card-${shot.id}-${id}`); const btn = document.getElementById(`select-btn-${shot.id}-${id}`);
                    if (card && btn) {
                        if (id === aiType) { card.classList.add('selected-ai-card'); btn.classList.add('selected'); btn.textContent = '✓ 최종 선택됨'; }
                        else { card.classList.remove('selected-ai-card'); btn.classList.remove('selected'); btn.textContent = `이 AI로 최종 선택`; }
                    }
                });
                const legacyUrlCell = document.getElementById(`legacy-video-url-${shot.id}`); if (legacyUrlCell) legacyUrlCell.textContent = shot.video_design.video_url || '-';
                const legacyAiToolCell = document.getElementById(`legacy-ai-tool-${shot.id}`); if (legacyAiToolCell) legacyAiToolCell.textContent = aiType || '-';
                showMessage(`${aiType}이(가) 최종 영상으로 선택됨.`, 'success');
            } catch (e) { console.error("최종 AI 선택 오류:", e); showMessage('최종 AI 선택 오류', 'error');}
        }

        // 샷 오디오 탭 생성
        // 샷 오디오 탭 생성 (대화/나레이션 상세 및 TTS용 분리)
        function createShotAudioTab(shot) {
            console.log('🔊 createShotAudioTab 시작 (TTS용 분리)');
            try {
                const audioUrls = shot.content?.audio_urls || {};
                const dialogue = shot.content?.dialogue || {};
                const narration = shot.content?.narration || '';
                // audio_prompts는 이제 TTS용 순수 텍스트를 content에서 가져오므로, 여기서는 참고용으로만 확인
                const audioPrompts = shot.audio_prompts || {};

                // --- 대화 오디오 섹션 ---
                let dialogueContentHtml = '';
                if (Object.keys(dialogue).length > 0) {
                    dialogueContentHtml = Object.entries(dialogue).map(([charId, dia]) => {
                        return `<strong>${charId}:</strong> ${dia.text || ''} <em>(감정: ${dia.emotion || '-'}, 스타일: ${dia.voice_style || '-'})</em>`;
                    }).join('<br>');
                } else {
                    dialogueContentHtml = '대화 내용이 없습니다.';
                }

                const fullDialogueForCopy = Object.entries(dialogue).map(([charId, dia]) => {
                    return `${charId}: ${dia.text || ''} (감정: ${dia.emotion || '-'}, 스타일: ${dia.voice_style || '-'})`;
                }).join('\\n').replace(/'/g, "&#39;");

                let characterOptionsHtml = Object.keys(dialogue).map(charId => `<option value="${charId}">${charId}</option>`).join('');
                let initialTtsDialogueText = '';
                if (Object.keys(dialogue).length > 0) {
                    const firstCharId = Object.keys(dialogue)[0];
                    initialTtsDialogueText = dialogue[firstCharId]?.text || '';
                }

                const dialogueHtml = `
                    <div class="audio-section">
                        <h4>🎤 대화 오디오</h4>
                        <div class="audio-player-area">
                            ${audioUrls.dialogue ? `<audio controls style="width: 100%;" src="${audioUrls.dialogue}"></audio>` : `<div style="color: #999;">대화 오디오 URL 입력</div>`}
                        </div>
                        <div class="form-group">
                            <label class="form-label">대화 오디오 URL</label>
                            <input type="text" class="form-input" value="${audioUrls.dialogue || ''}" placeholder="https://example.com/dialogue.mp3" onchange="updateAudioUrl('${shot.id}', 'dialogue', this.value)">
                        </div>

                        <div class="info-section" style="padding:15px; background-color:#fcfcfc;">
                            <h5>대화 내용 (검토용)</h5>
                            <div class="audio-content-display" style="min-height:80px; white-space:normal;">${dialogueContentHtml}</div>
                            <button class="copy-btn btn-small" style="margin-top:5px;" onclick="copyToClipboard('${fullDialogueForCopy}').then(ok => ok && showMessage('전체 대화 내용 복사됨.', 'success'))">전체 대화 내용 복사</button>
                        </div>

                        <div class="info-section" style="padding:15px; background-color:#fcfcfc; margin-top:15px;">
                            <h5>TTS용 캐릭터 대사 (더빙용)</h5>
                            <div class="form-group">
                                <label for="tts-char-select-${shot.id}" class="form-label">캐릭터 선택:</label>
                                <select id="tts-char-select-${shot.id}" class="form-select" onchange="updateTtsDialogueDisplay('${shot.id}')" ${Object.keys(dialogue).length === 0 ? 'disabled' : ''}>
                                    ${characterOptionsHtml || '<option value="">선택할 캐릭터 없음</option>'}
                                </select>
                            </div>
                            <div class="audio-content-display" id="tts-dialogue-text-${shot.id}" style="min-height:60px;">${initialTtsDialogueText.replace(/\n/g, "<br>")}</div>
                            <button class="copy-btn btn-small" style="margin-top:5px;" onclick="copyTtsDialogue('${shot.id}')">선택 캐릭터 대사 복사</button>
                            ${audioPrompts.dialogue?.prompt ? `<div class="prompt-text" style="margin-top:10px; font-size:0.8em; background-color:#eee; padding:5px;">참고용 기존 프롬프트: ${audioPrompts.dialogue.prompt}</div>` : ''}
                            ${audioPrompts.dialogue?.settings ? `<div style="margin-top:5px; font-size:0.8em; color:#555;">참고용 기존 설정: ${JSON.stringify(audioPrompts.dialogue.settings)}</div>` : ''}
                        </div>
                    </div>
                `;

                // --- 나레이션 오디오 섹션 ---
                const narrationForCopy = (narration || '').replace(/'/g, "&#39;").replace(/\n/g, "\\n");
                // TTS용 나레이션 텍스트는 shot.content.narration을 우선 사용. 없다면 audio_prompts.narration.prompt 사용.
                const ttsNarrationSourceText = narration || audioPrompts.narration?.prompt || '나레이션 내용 또는 프롬프트가 없습니다.';
                const ttsNarrationForCopy = (ttsNarrationSourceText).replace(/'/g, "&#39;").replace(/\n/g, "\\n");


                const narrationHtml = `
                    <div class="audio-section">
                        <h4> narr️ 나레이션 오디오</h4>
                        <div class="audio-player-area">
                            ${audioUrls.narration ? `<audio controls style="width: 100%;" src="${audioUrls.narration}"></audio>` : `<div style="color: #999;">나레이션 오디오 URL 입력</div>`}
                        </div>
                        <div class="form-group">
                            <label class="form-label">나레이션 오디오 URL</label>
                            <input type="text" class="form-input" value="${audioUrls.narration || ''}" placeholder="https://example.com/narration.mp3" onchange="updateAudioUrl('${shot.id}', 'narration', this.value)">
                        </div>

                        <div class="info-section" style="padding:15px; background-color:#fcfcfc;">
                            <h5>나레이션 내용 (검토용)</h5>
                            <div class="audio-content-display" style="min-height:60px;">${narration || '나레이션 내용이 없습니다.'}</div>
                            <button class="copy-btn btn-small" style="margin-top:5px;" onclick="copyToClipboard('${narrationForCopy}').then(ok => ok && showMessage('나레이션 내용 복사됨.', 'success'))">나레이션 내용 복사</button>
                        </div>

                        <div class="info-section" style="padding:15px; background-color:#fcfcfc; margin-top:15px;">
                            <h5>TTS용 나레이션 대사 (더빙용)</h5>
                            <div class="audio-content-display" id="tts-narration-text-${shot.id}" style="min-height:60px;">${ttsNarrationSourceText.replace(/\n/g, "<br>")}</div>
                            <button class="copy-btn btn-small" style="margin-top:5px;" onclick="copyToClipboard('${ttsNarrationForCopy}').then(ok => ok && showMessage('TTS용 나레이션 대사 복사됨.', 'success'))">TTS용 나레이션 대사 복사</button>
                            ${audioPrompts.narration?.prompt && audioPrompts.narration.prompt !== ttsNarrationSourceText ? `<div class="prompt-text" style="margin-top:10px; font-size:0.8em; background-color:#eee; padding:5px;">참고용 기존 프롬프트: ${audioPrompts.narration.prompt}</div>` : ''}
                            ${audioPrompts.narration?.settings ? `<div style="margin-top:5px; font-size:0.8em; color:#555;">참고용 기존 설정: ${JSON.stringify(audioPrompts.narration.settings)}</div>` : ''}
                        </div>
                    </div>
                `;

                // --- 음향 효과 섹션 (기존과 유사하게 유지) ---
                const soundEffects = shot.content?.sound_effects || '';
                const soundEffectsForCopy = (soundEffects || '').replace(/'/g, "&#39;").replace(/\n/g, "\\n");
                const sfxPromptText = audioPrompts.sound_effects?.prompt || '프롬프트가 없습니다.'; // 변수 이름 명확히
                const sfxPromptForCopy = (sfxPromptText).replace(/'/g, "&#39;").replace(/\n/g, "\\n");

                const soundEffectsHtml = `
                    <div class="audio-section">
                        <h4>🔊 음향 효과</h4>
                        <div class="audio-player-area">
                            ${audioUrls.sound_effects ? `<audio controls style="width: 100%;" src="${audioUrls.sound_effects}"></audio>` : `<div style="color: #999;">음향 효과 URL 입력</div>`}
                        </div>
                        <div class="form-group">
                            <label class="form-label">음향 효과 URL</label>
                            <input type="text" class="form-input" value="${audioUrls.sound_effects || ''}" placeholder="https://example.com/sound.mp3" onchange="updateAudioUrl('${shot.id}', 'sound_effects', this.value)">
                        </div>
                        ${soundEffects ? `
                        <div class="form-group">
                            <label class="form-label">음향 효과 설명</label>
                            <div class="audio-content-display">${soundEffects}</div>
                            <button class="copy-btn btn-small" style="margin-top:5px;" onclick="copyToClipboard('${soundEffectsForCopy}').then(ok => ok && showMessage('음향 설명 복사됨.', 'success'))">음향 설명 복사</button>
                        </div>` : ''}
                        ${audioPrompts.sound_effects ? `
                        <div class="prompt-container">
                            <div class="prompt-header"><span class="prompt-title">음향 효과 생성 프롬프트</span>
                                <button class="copy-btn" onclick="copyToClipboard('${sfxPromptForCopy}').then(ok => ok && showMessage('음향 프롬프트 복사됨.', 'success'))">복사</button>
                            </div>
                            <div class="prompt-text">${sfxPromptText}</div>
                            ${audioPrompts.sound_effects.settings ? `<div style="margin-top: 8px; font-size: 0.85rem; color: #666;">설정: ${JSON.stringify(audioPrompts.sound_effects.settings)}</div>` : ''}
                        </div>` : ''}
                    </div>`;

                console.log('✅ createShotAudioTab 완료');
                return `${dialogueHtml}${narrationHtml}${soundEffectsHtml}`;
            } catch (error) {
                console.error('❌ createShotAudioTab 오류:', error);
                return `<div class="info-section"><h3>오디오 탭 로드 오류</h3><p>오류: ${error.message}</p></div>`;
            }
        }

        // TTS용 대화 표시 업데이트 함수
        function updateTtsDialogueDisplay(shotId) {
            try {
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
                const selectElement = document.getElementById(`tts-char-select-${shotId}`);
                const displayElement = document.getElementById(`tts-dialogue-text-${shotId}`);

                if (shot && selectElement && displayElement && shot.content && shot.content.dialogue) {
                    const selectedCharId = selectElement.value;
                    const dialogueText = shot.content.dialogue[selectedCharId]?.text || '선택된 캐릭터의 대사가 없습니다.';
                    displayElement.innerHTML = dialogueText.replace(/\n/g, "<br>"); // 표시할 때는 <br>로
                }
            } catch (error) {
                console.error("TTS 대화 표시 업데이트 오류:", error);
            }
        }

        // TTS용 선택 캐릭터 대사 복사 함수
        function copyTtsDialogue(shotId) {
            try {
                // 표시된 내용(innerHTML)이 아닌, 원본 데이터에서 텍스트를 가져와 복사
                const selectElement = document.getElementById(`tts-char-select-${shotId}`);
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);

                if (selectElement && shot && shot.content && shot.content.dialogue) {
                     const selectedCharId = selectElement.value;
                     const dialogueText = shot.content.dialogue[selectedCharId]?.text || ''; // 원본 텍스트
                     if (dialogueText.trim() === '') {
                        showMessage('복사할 대사가 없습니다.', 'warning');
                        return;
                     }
                     // 복사할 때는 \n을 그대로 유지 (클립보드 API가 OS에 맞게 처리)
                     copyToClipboard(dialogueText).then(ok => ok && showMessage('선택된 캐릭터의 TTS용 대사가 복사되었습니다.', 'success'));
                } else {
                     showMessage('복사할 대사를 찾을 수 없습니다.', 'warning');
                }
            } catch (error) {
                console.error("TTS 대화 복사 오류:", error);
                showMessage('TTS 대사 복사 중 오류 발생', 'error');
            }
        }


        // 샷 음악 탭 생성
        // 샷 음악 탭 생성 (프로젝트 전체 음악 정보 + 샷별 메모)
        function createShotMusicTab(shot) {
            console.log('🎵 createShotMusicTab 시작 (프로젝트 음악 정보 + 샷별 메모)');
            try {
                // 프로젝트 레벨의 음악 정보 가져오기
                const projectMusicPrompts = currentData.film_metadata?.project_music_prompts || {};
                const projectMusicUrls = currentData.film_metadata?.project_music_urls || {};

                // 샷 레벨의 음악 메모 가져오기
                const shotMusicMemo = shot.music_memo || '';

                const createProjectOstSection = (ostType, title, emoji) => {
                    const ostPromptData = projectMusicPrompts[ostType];
                    const ostUrl = projectMusicUrls[ostType] || '';

                    if (!ostPromptData) {
                        return `<div class="music-ost-section"><h4>${emoji} ${title} (프로젝트)</h4><div style="text-align:center;padding:20px;color:#999;">${title} 프롬프트 정보가 없습니다. (film_metadata.project_music_prompts)</div></div>`;
                    }

                    const stylePrompt = ostPromptData.style_prompt || '스타일 프롬프트가 없습니다.';
                    const lyricsPrompt = ostPromptData.lyrics_structure_prompt || '가사&구조 프롬프트가 없습니다.';
                    const stylePromptForCopy = stylePrompt.replace(/'/g, "&#39;").replace(/\n/g, "\\n");
                    const lyricsPromptForCopy = lyricsPrompt.replace(/'/g, "&#39;").replace(/\n/g, "\\n");

                    return `
                        <div class="music-ost-section">
                            <h4>${emoji} ${title} (프로젝트 전체)</h4>
                            <div class="audio-player-area" style="margin-bottom:15px;">
                                ${ostUrl ? `<audio controls style="width: 100%;" src="${ostUrl}"></audio>` : `<div style="color: #999;">${title} URL 입력 (프로젝트 레벨)</div>`}
                            </div>
                            <div class="form-group">
                                <label class="form-label">${title} URL (프로젝트 전체)</label>
                                <input type="text" class="form-input" value="${ostUrl}" 
                                       placeholder="https://example.com/${ostType}.mp3" 
                                       onchange="updateProjectMusicUrl('${ostType}', this.value)">
                            </div>
                            <div class="ost-prompt-grid">
                                <div class="ost-prompt-item">
                                    <div class="prompt-title">스타일 프롬프트</div>
                                    <div class="prompt-text">${stylePrompt}</div>
                                    <button class="copy-btn btn-small" onclick="copyToClipboard('${stylePromptForCopy}').then(ok => ok && showMessage('${title} 스타일 프롬프트 복사됨.', 'success'))">복사</button>
                                </div>
                                <div class="ost-prompt-item">
                                    <div class="prompt-title">가사 & 구조 프롬프트</div>
                                    <div class="prompt-text">${lyricsPrompt}</div>
                                    <button class="copy-btn btn-small" onclick="copyToClipboard('${lyricsPromptForCopy}').then(ok => ok && showMessage('${title} 가사/구조 프롬프트 복사됨.', 'success'))">복사</button>
                                </div>
                            </div>
                        </div>`;
                };

                const mainOstHtml = createProjectOstSection('main_ost', '메인 OST', '🎼');
                const subOst1Html = createProjectOstSection('sub_ost_1', '서브 OST 1', '🎵');
                const subOst2Html = createProjectOstSection('sub_ost_2', '서브 OST 2', '🎶');
                
                const shotMusicMemoHtml = `
                    <div class="info-section">
                        <h3>📝 이 샷의 음악 관련 메모</h3>
                         <div class="form-group">
                            <label class="form-label">샷 음악 적용 노트 (예: 이 샷부터 메인 테마 사용):</label>
                            <textarea class="form-textarea" 
                                      style="min-height: 100px;"
                                      placeholder="이 샷에 적용될 음악에 대한 구체적인 지시사항이나 아이디어를 입력하세요..."
                                      onchange="updateShotMusicMemo('${shot.id}', this.value)">${shotMusicMemo}</textarea>
                            <small style="color:#777; font-size:0.85em;">이 메모는 현재 선택된 샷(${shot.id})에만 해당됩니다.</small>
                        </div>
                    </div>`;

                return `${mainOstHtml}${subOst1Html}${subOst2Html}${shotMusicMemoHtml}`;
            } catch (error) {
                console.error('❌ createShotMusicTab 오류:', error);
                return `<div class="info-section"><h3>음악 탭 로드 오류</h3><p>오류 메시지: ${error.message}</p></div>`;
            }
        }

        // 프로젝트 레벨 음악 URL 업데이트 함수
        function updateProjectMusicUrl(ostType, newUrl) {
            try {
                if (!currentData.film_metadata) currentData.film_metadata = {};
                if (!currentData.film_metadata.project_music_urls) currentData.film_metadata.project_music_urls = {};
                
                currentData.film_metadata.project_music_urls[ostType] = newUrl;
                saveDataToLocalStorage();
                
                // 현재 탭이 음악 탭이라면 UI 즉시 갱신 (플레이어 부분)
                const activeTabId = document.querySelector('.tab-button.active')?.getAttribute('onclick').match(/'([^']+)'/)[1];
                if (activeTabId === 'music' && selectedType === 'shot' && selectedId) {
                    showShotContent(selectedId); // 현재 샷 콘텐츠를 다시 그려서 음악 탭 업데이트
                    setTimeout(() => switchTab('music', selectedId), 0); // 음악 탭 활성화 유지
                }
                showMessage(`프로젝트 ${ostType} URL이 업데이트되었습니다.`, 'success');
            } catch (error) {
                console.error("프로젝트 음악 URL 업데이트 오류:", error);
                showMessage('프로젝트 음악 URL 업데이트 중 오류 발생', 'error');
            }
        }

        // 샷별 음악 메모 업데이트 함수
        function updateShotMusicMemo(shotId, memo) {
            try {
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
                if (!shot) return showMessage('샷 데이터를 찾을 수 없습니다.', 'error');
                
                shot.music_memo = memo;
                saveDataToLocalStorage();
                showMessage(`샷 ${shotId}의 음악 메모가 업데이트되었습니다.`, 'success');
            } catch (error) {
                console.error("샷 음악 메모 업데이트 오류:", error);
                showMessage('샷 음악 메모 업데이트 중 오류 발생', 'error');
            }
        }
        
        // 메모 관리 함수들
        function getShotMemo(shotId){try{return JSON.parse(localStorage.getItem('shotMemos')||'{}')[shotId]||''}catch(e){return''}}
        function updateShotMemo(shotId,memo){try{const m=JSON.parse(localStorage.getItem('shotMemos')||'{}');m[shotId]=memo;localStorage.setItem('shotMemos',JSON.stringify(m))}catch(e){showMessage('메모 저장 실패','error')}}
        
        // 오디오 URL 업데이트
        function updateAudioUrl(shotId,audioType,newUrl){try{const s=currentData.breakdown_data.shots.find(sh=>sh.id===shotId);if(!s)return;if(!s.content)s.content={};if(!s.content.audio_urls)s.content.audio_urls={};s.content.audio_urls[audioType]=newUrl;saveDataToLocalStorage();const tab=document.querySelector('.tab-button.active')?.getAttribute('onclick').match(/'([^']+)'/)[1];showShotContent(shotId);if(tab)setTimeout(()=>switchTab(tab,shotId),0);showMessage(`${audioType} 오디오 URL 업데이트`,'success')}catch(e){showMessage('오디오 URL 업데이트 실패','error')}}
        function updateCurrentMusicDescription(shotId,description){try{const s=currentData.breakdown_data.shots.find(sh=>sh.id===shotId);if(!s)return;if(!s.content)s.content={music:''};s.content.music=description;saveDataToLocalStorage();showMessage('음악 설명 업데이트','success')}catch(e){showMessage('음악 설명 업데이트 실패','error')}}

        // 컨셉아트 보기
        function openConceptArt(){try{window.open(`${getProjectName().replace(/ /g,'')}_ConceptArt.html`,'_blank')}catch(e){showMessage('컨셉아트 열기 실패','warning')}}

        // 이벤트 리스너 설정
        function setupEventListeners() {
            document.getElementById('import-btn')?.addEventListener('click', importData);
            document.getElementById('export-btn')?.addEventListener('click', exportData);
            document.getElementById('concept-art-btn')?.addEventListener('click', openConceptArt);
            document.getElementById('expand-all-btn')?.addEventListener('click', expandAll);
            document.getElementById('collapse-all-btn')?.addEventListener('click', collapseAll);
            document.getElementById('search-input')?.addEventListener('input', searchNavigation);
            document.getElementById('file-input')?.addEventListener('change', handleFileSelect);
        }

        // 페이지 로드 시 실행
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🎬 페이지 로드 완료, 초기화 시작...');
            try {
                setupEventListeners();
                await loadData(); 
                updateUI();       
                console.log('✅ 초기화 완료');
            } catch (error) { console.error('❌ 초기화 오류:', error); showMessage(`초기화 오류: ${error.message}`, 'error'); }
        });
        
        console.log('✅ JavaScript 로딩 완료');
    </script>
</body>
</html>
