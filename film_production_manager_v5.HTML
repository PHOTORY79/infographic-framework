<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Film Production Manager v5 (Selective Update)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-title {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .project-info {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-primary:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.2);
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 0.8rem;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        /* Navigation Panel */
        .navigation {
            width: 350px;
            background: white;
            border-right: 1px solid #e0e0e0;
            margin-top: 60px;
            overflow-y: auto;
            height: calc(100vh - 60px);
        }

        .nav-header {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .project-header h3 {
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 5px;
        }

        .project-header small {
            color: #666;
            font-size: 0.85rem;
        }

        .nav-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 15px;
        }

        .nav-controls .btn {
            font-size: 0.8rem;
            padding: 6px 12px;
        }

        .search-box {
            margin-top: 10px;
        }

        .search-box input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .nav-content {
            padding: 0;
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .sequence-item {
            border-bottom: 1px solid #f0f0f0;
        }

        .sequence-header {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.2s;
            font-weight: 500;
        }

        .sequence-header:hover {
            background-color: #f8f9fa;
        }

        .sequence-header.active {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .toggle-icon {
            font-size: 0.8rem;
            transition: transform 0.2s;
            color: #666;
        }

        .toggle-icon.expanded {
            transform: rotate(90deg);
        }

        /* ì”¬ ìŠ¤íƒ€ì¼ */
        .scenes-container {
            background-color: #fafafa;
            border-top: 1px solid #e0e0e0;
        }

        .scenes-container.collapsed {
            display: none;
        }

        .scene-item {
            border-bottom: 1px solid #e0e0e0;
        }

        .scene-header {
            padding: 12px 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.2s;
            font-size: 0.95rem;
        }

        .scene-header:hover {
            background-color: #f0f0f0;
        }

        .scene-header.active {
            background-color: #e8f5e8;
            color: #2e7d32;
        }

        /* ìƒ· ìŠ¤íƒ€ì¼ */
        .shots-container {
            background-color: #f5f5f5;
        }

        .shots-container.collapsed {
            display: none;
        }

        .shot-item {
            padding: 8px 60px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.9rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shot-item:hover {
            background-color: #eeeeee;
        }

        .shot-item.active {
            background-color: #fff3e0;
            color: #f57c00;
            font-weight: 500;
        }

        .shot-actions {
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .shot-item:hover .shot-actions {
            opacity: 1;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-top: 60px;
            padding: 30px;
            overflow-y: auto;
            height: calc(100vh - 60px);
        }

        .content-header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .content-subtitle {
            color: #666;
            font-size: 1rem;
        }

        .content-actions {
            display: flex;
            gap: 10px;
        }

        /* Info Section */
        .info-section {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .info-section h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
         .info-section h4 { 
            font-size: 1.05rem;
            font-weight: 600;
            color: #444;
            margin-top: 15px;
            margin-bottom: 10px;
        }


        .info-table {
            width: 100%;
            border-collapse: collapse;
        }

        .info-table th {
            text-align: left;
            padding: 10px 15px;
            background-color: #f8f9fa;
            border: 1px solid #e0e0e0;
            font-weight: 600;
            color: #555;
            width: 150px;
        }

        .info-table td {
            padding: 10px 15px;
            border: 1px solid #e0e0e0;
            color: #333;
        }

        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tabs {
            margin-bottom: 30px;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .tab-button {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            color: #1976d2;
            border-bottom-color: #1976d2;
            font-weight: 500;
        }

        .tab-button:hover {
            color: #1976d2;
            background-color: #f5f5f5;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* í”„ë¡¬í”„íŠ¸ ê´€ë ¨ ìŠ¤íƒ€ì¼ (ì¼ë°˜) */
        .prompt-container { 
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .prompt-title { 
            font-weight: 600;
            color: #495057;
        }

        .copy-btn { 
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.2s;
        }

        .copy-btn:hover {
            background: #218838;
        }

        .copy-btn:active {
            background: #1e7e34;
        }

        .prompt-text { 
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            white-space: pre-wrap;
            color: #495057;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.95rem;
        }

        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.95rem;
            background: white;
        }

        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.95rem;
            min-height: 80px;
            resize: vertical;
        }


        /* ì˜¤ë””ì˜¤ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .audio-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
        }

        .audio-section h4 {
            color: #495057;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9ecef;
        }

        .audio-player-area {
            min-height: 80px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed #ddd;
            margin-bottom: 15px;
        }

        .audio-content-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 10px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 0.9rem;
            line-height: 1.4;
            white-space: pre-wrap;
            color: #495057;
            min-height: 60px;
        }

        /* ìŒì•… íƒ­ ì „ìš© ìŠ¤íƒ€ì¼ */
        .music-ost-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .music-ost-section h4 {
            color: #495057;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #dee2e6;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .ost-prompt-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .ost-prompt-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
        }

        .ost-prompt-item .prompt-title { 
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .ost-prompt-item .prompt-text { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            white-space: pre-wrap;
            color: #495057;
            max-height: 120px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        /* Messages */
        .message-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1001;
            max-width: 400px;
        }

        .message {
            background: white;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 4px solid #2196f3;
            position: relative;
        }

        .message.success-message {
            border-left-color: #4caf50;
        }

        .message.error-message {
            border-left-color: #f44336;
        }

        .message.warning-message {
            border-left-color: #ff9800;
        }

        .close-button {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #999;
        }

        .hidden-file-input {
            display: none;
        }

        /* ì˜ìƒ íƒ­ AI ì¹´ë“œ ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼ ì‹œì‘ */
        .video-ai-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px;
            margin-top: 20px;
        }

        .ai-video-card { 
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            transition: box-shadow 0.3s ease;
        }

        .ai-video-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .ai-video-card .ai-card-header { 
            font-size: 1.2rem;
            font-weight: 600;
            padding-bottom: 10px;
            margin-bottom: 15px;
            border-bottom-width: 2px; 
            border-bottom-style: solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-video-card.luma .ai-card-header { border-color: #FF8C00; color: #FF8C00; } 
        .ai-video-card.kling .ai-card-header { border-color: #1E90FF; color: #1E90FF; } 
        .ai-video-card.veo2 .ai-card-header { border-color: #9370DB; color: #9370DB; } 
        .ai-video-card.runway .ai-card-header { border-color: #3CB371; color: #3CB371; } 

        .ai-video-card .ai-card-content {
            flex-grow: 1;
        }

        .ai-video-card .ai-prompt-area {
            margin-bottom: 15px;
        }

        .ai-video-card .prompt-text { 
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            font-size: 0.85rem; 
            max-height: 150px;
            margin-bottom: 10px;
        }

        .ai-video-card .copy-prompt-btn { 
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.2s;
            margin-bottom: 15px;
        }

        .ai-video-card .copy-prompt-btn:hover {
            background: #5a6268;
        }

        .ai-video-card .form-input { 
            padding: 8px 10px;
            font-size: 0.9rem;
        }

        .ai-video-preview {
            min-height: 150px;
            background: #f0f0f0;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
        }

        .ai-video-preview video {
            max-width: 100%;
            max-height: 250px;
            border-radius: 4px;
        }

        .ai-select-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
            width: 100%;
            margin-top: auto;
        }

        .ai-select-button:hover {
            background-color: #0056b3;
        }

        .ai-select-button.selected {
            background-color: #28a745;
            cursor: default;
        }
        
        .ai-video-card.selected-ai-card {
            border-left: 5px solid #28a745;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);
        }
        
        .ai-video-card .ai-settings-info { 
            font-size: 0.8rem;
            color: #666;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #eee;
        }
        /* ì˜ìƒ íƒ­ AI ì¹´ë“œ ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼ ë */

        /* ì´ë¯¸ì§€ íƒ­ AI ì¹´ë“œ ë° ì´ë¯¸ì§€ ìŠ¬ë¡¯ ìŠ¤íƒ€ì¼ ì‹œì‘ */
        .image-ai-grid { 
            display: grid;
            grid-template-columns: 1fr; 
            gap: 30px; 
            margin-top: 20px;
        }

        .ai-image-section { 
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        }

        .ai-image-section .ai-card-header { 
            font-size: 1.3rem; 
            border-bottom-width: 2px;
            border-bottom-style: solid; 
            margin-bottom: 20px;
             display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }

        .ai-image-section.midjourney .ai-card-header { border-color: #0099FF; color: #0099FF; } 
        .ai-image-section.ideogram .ai-card-header { border-color: #FF6600; color: #FF6600; } 
        .ai-image-section.leonardo .ai-card-header { border-color: #9933CC; color: #9933CC; } 
        .ai-image-section.imagefx .ai-card-header { border-color: #00CC66; color: #00CC66; } 

        .ai-image-prompt-details {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .ai-image-prompt-details .prompt-text-label {
            font-weight: 500;
            color: #333;
            font-size: 0.95rem;
            margin-bottom: 8px;
            display: block;
        }

        .ai-image-prompt-full-text { 
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            white-space: pre-wrap;
            color: #495057;
            max-height: 180px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .ai-image-section .copy-btn { 
            margin-bottom: 0; 
            padding: 8px 15px;
        }

        .generated-images-grid { 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px dashed #e0e0e0;
        }

        .image-slot-card { 
            background: #fdfdfd;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .image-slot-preview {
            width: 100%;
            height: 180px; 
            border: 2px dashed #ccc;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            margin-bottom: 10px;
            overflow: hidden; 
        }

        .image-slot-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; 
            border-radius: 2px;
        }

        .image-slot-card .form-group {
            margin-bottom: 10px;
        }
        .image-slot-card .form-label {
            font-size: 0.85rem;
            margin-bottom: 3px;
        }
        .image-slot-card .form-input,
        .image-slot-card .form-textarea {
            font-size: 0.9rem;
            padding: 6px 8px;
        }
        .image-slot-card .form-textarea {
            min-height: 60px;
            resize: vertical;
        }

        .image-slot-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
        }
        .image-slot-actions .btn-small { 
            flex-grow: 1; 
        }

        /* ì°¸ì¡° ì´ë¯¸ì§€ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .reference-image-slots-container {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ced4da;
        }
        .reference-image-slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .reference-image-slot { 
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .reference-image-slot .reference-preview { 
            width: 100%;
            height: 160px;
            margin-bottom: 12px;
            border: 2px dashed #ddd; 
            border-radius: 6px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: #f8f9fa; 
            overflow: hidden; 
        }
         .reference-image-slot .reference-preview img { 
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 4px;
        }

        .reference-image-slot .form-group {
            margin-bottom: 10px;
        }
        .reference-image-slot .form-label {
            font-size: 0.85rem;
        }
        .reference-image-slot .form-input,
        .reference-image-slot .form-select,
        .reference-image-slot .form-textarea {
            font-size: 0.9rem;
            padding: 7px 10px;
        }
        .reference-image-slot .btn-danger { 
            width: 100%;
            margin-top: 10px;
        }

        /* ì´ë¯¸ì§€ í¬ê²Œ ë³´ê¸° ëª¨ë‹¬ */
        .image-modal {
            display: none; 
            position: fixed;
            z-index: 2000; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.85); 
            justify-content: center; 
            align-items: center; 
        }
        .image-modal-content {
            margin: auto;
            display: block;
            max-width: 85%;
            max-height: 85%;
            border-radius: 5px;
        }
        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }
        .image-modal-close:hover,
        .image-modal-close:focus {
            color: #bbb;
            text-decoration: none;
        }
        /* ì´ë¯¸ì§€ íƒ­ AI ì¹´ë“œ ë° ì´ë¯¸ì§€ ìŠ¬ë¡¯ ìŠ¤íƒ€ì¼ ë */


        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .navigation {
                width: 100%;
                height: auto;
                position: relative;
                margin-top: 0;
            }
            
            .main-content {
                width: 100%;
                margin-top: 0;
                padding: 15px;
            }
            
            .container {
                flex-direction: column;
            }
            
            .header {
                position: relative;
            }

            .ost-prompt-grid {
                grid-template-columns: 1fr;
            }

            .video-ai-grid { 
                grid-template-columns: 1fr; 
            }
            .generated-images-grid, .reference-image-slots-grid { 
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <div class="header-title">Film Production Manager</div>
            <div class="project-info">
                <div id="project-title">ìƒˆ í”„ë¡œì íŠ¸</div>
                <div id="project-file" style="font-size: 0.8rem; opacity: 0.8;">íŒŒì¼: ì—†ìŒ</div>
            </div>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" id="concept-art-btn">ì»¨ì…‰ì•„íŠ¸ ë³´ê¸°</button>
            <button class="btn btn-primary" id="import-btn">JSON ê°€ì ¸ì˜¤ê¸°</button>
            <button class="btn btn-primary" id="export-btn">JSON ë‚´ë³´ë‚´ê¸°</button>
        </div>
    </header>

    <div class="container">
        <nav class="navigation">
            <div class="nav-header">
                <div class="project-header">
                    <h3 id="nav-project-title">í”„ë¡œì íŠ¸ ë¡œë”© ì¤‘...</h3>
                    <small id="nav-project-file">íŒŒì¼: ë¡œë”© ì¤‘...</small>
                </div>
                <div class="nav-controls">
                    <button class="btn btn-secondary" id="expand-all-btn">ì „ì²´ í¼ì¹˜ê¸°</button>
                    <button class="btn btn-secondary" id="collapse-all-btn">ì „ì²´ ì ‘ê¸°</button>
                </div>
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="ì‹œí€€ìŠ¤, ì”¬, ìƒ· ê²€ìƒ‰..." />
                </div>
            </div>
            <div class="nav-content" id="navigation-content">
                <div class="empty-state" id="nav-empty">
                    <div class="empty-state-icon">ğŸ“</div>
                    <div>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                    <div style="font-size: 0.9rem; margin-top: 10px;">JSON ê°€ì ¸ì˜¤ê¸°ë¥¼ ì‚¬ìš©í•´ ë°ì´í„°ë¥¼ ë¡œë“œí•´ì£¼ì„¸ìš”</div>
                </div>
            </div>
        </nav>

        <main class="main-content">
            <div class="content-header">
                <div>
                    <h1 class="content-title" id="content-title">í”„ë¡œì íŠ¸ ì„ íƒ</h1>
                    <p class="content-subtitle" id="content-subtitle">ì¢Œì¸¡ì—ì„œ ì‹œí€€ìŠ¤, ì”¬, ë˜ëŠ” ìƒ·ì„ ì„ íƒí•˜ì„¸ìš”</p>
                </div>
                <div class="content-actions" id="content-actions" style="display: none;">
                    </div>
            </div>

            <div id="content-area">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ¬</div>
                    <div>ì‹œí€€ìŠ¤, ì”¬, ë˜ëŠ” ìƒ·ì„ ì„ íƒí•˜ì—¬ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”</div>
                </div>
            </div>
        </main>
    </div>

    <div id="message-container" class="message-container"></div>

    <input type="file" id="file-input" class="hidden-file-input" accept=".json">

    <script>
        console.log('ğŸ¬ JavaScript ë¡œë”© ì‹œì‘...');
        
        // ì „ì—­ ë³€ìˆ˜
        let currentData = null;
        let selectedType = null;
        let selectedId = null;
        let selectedSceneId = null;

        // ë™ì  íŒŒì¼ëª… ê´€ë¦¬
        function getProjectFileName() {
            try {
                const htmlFileName = window.location.pathname.split('/').pop();
                const baseName = htmlFileName.replace('.html', '');
                return baseName + '.json';
            } catch (error) {
                console.error('íŒŒì¼ëª… ìƒì„± ì˜¤ë¥˜:', error);
                return 'Film_Production_Manager.json';
            }
        }

        function getProjectName() {
            try {
                return getProjectFileName()
                    .replace('_Manager.json', '')
                    .replace('Film_Production_Manager.json', 'Film Production Manager');
            } catch (error) {
                console.error('í”„ë¡œì íŠ¸ëª… ìƒì„± ì˜¤ë¥˜:', error);
                return 'Film Production Manager';
            }
        }

        // ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(message, type) {
            console.log('ë©”ì‹œì§€:', message, 'íƒ€ì…:', type);
            
            try {
                const messageContainer = document.getElementById('message-container');
                if (!messageContainer) {
                    console.error('ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                    return;
                }
                
                const messageElement = document.createElement('div');
                messageElement.className = `message ${type}-message`;
                messageElement.innerHTML = `
                    ${message}
                    <button class="close-button" onclick="this.parentElement.remove()">Ã—</button>
                `;
                
                messageContainer.appendChild(messageElement);
                
                if (type !== 'error') {
                    setTimeout(() => {
                        if (messageContainer.contains(messageElement)) {
                            messageContainer.removeChild(messageElement);
                        }
                    }, 5000);
                }
            } catch (error) {
                console.error('ë©”ì‹œì§€ í‘œì‹œ ì˜¤ë¥˜:', error);
                alert(message);
            }
        }

        // í´ë¦½ë³´ë“œ ë³µì‚¬ í•¨ìˆ˜
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                return true;
            } catch (error) {
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', error);
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    return true;
                } catch (fallbackError) {
                    showMessage('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    return false;
                }
            }
        }

        // ê¸°ë³¸ ë°ì´í„° êµ¬ì¡°
        function getDefaultData() {
            try {
                return {
                    film_id: 'FILM_NEW',
                    current_stage_name: 'scenario_breakdown',
                    timestamp: new Date().toISOString(),
                    schema_version: '1.1.0', 
                    film_metadata: {
                        title_working: getProjectName(),
                        confirmed_genre: ''
                    },
                    breakdown_data: {
                        sequences: [],
                        scenes: [],
                        shots: []
                    }
                };
            } catch (error) {
                console.error('ê¸°ë³¸ ë°ì´í„° ìƒì„± ì˜¤ë¥˜:', error);
                return null;
            }
        }

        // í…ŒìŠ¤íŠ¸ìš© JSON ë°ì´í„° ìƒì„± í•¨ìˆ˜ (í”„ë¡¬í”„íŠ¸ í¬í•¨)
        function createTestData() {
            console.log('ğŸ§ª í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì¤‘...');
            
            return {
                "film_id": "FILM_TEST001",
                // ... (ê¸°ì¡´ film_id, current_stage_name ë“±ì€ ê·¸ëŒ€ë¡œ) ...
                "film_metadata": {
                    "title_working": "í…ŒìŠ¤íŠ¸ ì˜í™”",
                    "confirmed_genre": "SF",
                    // â–¼â–¼â–¼ í”„ë¡œì íŠ¸ ì „ì²´ ìŒì•… ì •ë³´ ì¶”ê°€ â–¼â–¼â–¼
                    "project_music_prompts": {
                        "main_ost": {
                            "style_prompt": "ì›…ì¥í•˜ê³  ë¯¸ë˜ì ì¸ ë©”ì¸ í…Œë§ˆ (í”„ë¡œì íŠ¸ ì „ì²´)",
                            "lyrics_structure_prompt": "A-B-A êµ¬ì¡°ì˜ ê¸°ì•…ê³¡, ë°˜ë³µì ì¸ ëª¨í‹°í”„ ì‚¬ìš©"
                        },
                        "sub_ost_1": {
                            "style_prompt": "ê¸´ì¥ê° ë„˜ì¹˜ëŠ” ì¶”ê²©ì”¬ìš© ìŒì•… ìŠ¤íƒ€ì¼ (í”„ë¡œì íŠ¸ ì „ì²´)",
                            "lyrics_structure_prompt": "ë¹ ë¥¸ í…œí¬, ì „ììŒì•…ê³¼ ì˜¤ì¼€ìŠ¤íŠ¸ë¼ í˜¼í•©"
                        },
                        "sub_ost_2": {
                            "style_prompt": "ê°ì„±ì ì¸ ì¥ë©´ì„ ìœ„í•œ ì„œì •ì ì¸ í”¼ì•„ë…¸ ì„ ìœ¨ (í”„ë¡œì íŠ¸ ì „ì²´)",
                            "lyrics_structure_prompt": "ëŠë¦° í…œí¬, ë¯¸ë‹ˆë©€í•œ êµ¬ì„±"
                        }
                    },
                    "project_music_urls": { // í”„ë¡œì íŠ¸ ëŒ€í‘œ ìŒì•… URL (ì˜ˆì‹œ)
                        "main_ost": "https://example.com/project_main_theme.mp3",
                        "sub_ost_1": "https://example.com/project_tension_theme.mp3",
                        "sub_ost_2": "" // ë¹„ì›Œë‘˜ ìˆ˜ë„ ìˆìŒ
                    }
                    // â–²â–²â–² í”„ë¡œì íŠ¸ ì „ì²´ ìŒì•… ì •ë³´ ì¶”ê°€ ë â–²â–²â–²
                },
                "breakdown_data": {
                    // ... (ê¸°ì¡´ source_data_references, sequences, scenes ë“±ì€ ê·¸ëŒ€ë¡œ) ...
                    "shots": [
                        {
                            "id": "S01.01",
                            // ... (ê¸°ì¡´ S01.01ì˜ ë‹¤ë¥¸ í•„ë“œë“¤ì€ ìµœëŒ€í•œ ìœ ì§€) ...
                            "content": {
                                "action": "ë ˆì´ë¸ì´ ì»´í“¨í„° ì•ì— ì•‰ì•„ ì§‘ì¤‘í•˜ë©° í‚¤ë³´ë“œë¥¼ íƒ€ì´í•‘",
                                "dialogue": {
                                    "character-1": { "text": "ì´ë²ˆ ì¼ì€ ì¢€ ë‹¤ë¥´êµ°...", "emotion": "ì§‘ì¤‘", "voice_style": "ì°¨ë¶„í•˜ê³  ì‹ ì¤‘í•œ" }
                                },
                                "narration": "ê·¸ë…€ëŠ” ì–´ë‘  ì†ì—ì„œ ë¹›ì„ ì°¾ê³  ìˆì—ˆë‹¤.",
                                "sound_effects": "í‚¤ë³´ë“œ íƒ€ì´í•‘ ì†Œë¦¬, ì»´í“¨í„° íŒ¬ ì†Œë¦¬, ë¹—ì†Œë¦¬",
                                "music": "", // ì´ í•„ë“œëŠ” ì´ì œ shot.music_memoë¡œ ëŒ€ì²´ë  ìˆ˜ ìˆìœ¼ë‚˜, í˜¸í™˜ì„±ì„ ìœ„í•´ ë‚¨ê²¨ë‘ê±°ë‚˜ ë¹„ì›Œë‘˜ ìˆ˜ ìˆìŒ
                                "audio_urls": {
                                    "dialogue": "https://example.com/audio/S01.01_dialogue.mp3",
                                    "narration": "https://example.com/audio/S01.01_narration.mp3",
                                    "sound_effects": "https://example.com/audio/S01.01_sfx.mp3"
                                    // ìƒ·ë³„ OST URLì€ ì—¬ê¸°ì„œ ì œê±°í•˜ê³  í”„ë¡œì íŠ¸ ë ˆë²¨ì—ì„œ ê´€ë¦¬
                                }
                            },
                            // â–¼â–¼â–¼ ìƒ·ë³„ ìŒì•… ë©”ëª¨ ì¶”ê°€ â–¼â–¼â–¼
                            "music_memo": "ì´ ìƒ·ì˜ ì˜¤í”„ë‹ ì‹œí€€ìŠ¤ì—ëŠ” í”„ë¡œì íŠ¸ ë©”ì¸ í…Œë§ˆë¥¼ ì‚¬ìš©í•œë‹¤. ê¸´ì¥ê°ì„ ì„œì„œíˆ ê³ ì¡°ì‹œí‚¤ëŠ” í¸ê³¡.",
                            // â–²â–²â–² ìƒ·ë³„ ìŒì•… ë©”ëª¨ ì¶”ê°€ ë â–²â–²â–²
                            "audio_prompts": { // ê¸°ì¡´ audio_prompts ë‚´ music_promptsëŠ” ì´ì œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (í”„ë¡œì íŠ¸ ë ˆë²¨ë¡œ ì´ë™)
                                "dialogue": { "prompt": "S01.01 Dialogue: ...", "settings": {} },
                                "narration": { "prompt": "S01.01 Narration: ...", "settings": {} },
                                "sound_effects": { "prompt": "S01.01 SFX: ...", "settings": {} }
                            }
                            // music_prompts í•„ë“œëŠ” shot ê°ì²´ì—ì„œ ì œê±°í•˜ê±°ë‚˜ ë¹„ì›Œë‘  (í”„ë¡œì íŠ¸ ë ˆë²¨ë¡œ ì´ë™í–ˆìœ¼ë¯€ë¡œ)
                        },
                        {
                            "id": "S01.02",
                            // ... (ê¸°ì¡´ S01.02ì˜ ë‹¤ë¥¸ í•„ë“œë“¤ì€ ìµœëŒ€í•œ ìœ ì§€) ...
                            "content": {
                                "action": "ë ˆì´ë¸ì˜ í‘œì • ë³€í™”ë¥¼ í´ë¡œì¦ˆì—…ìœ¼ë¡œ í¬ì°©",
                                "narration": "ê·¸ë…€ì˜ ëˆˆì—ëŠ” ê²°ì˜ê°€ ë‹´ê²¨ ìˆì—ˆë‹¤.",
                                "music": "", // ì´ í•„ë“œëŠ” ì´ì œ shot.music_memoë¡œ ëŒ€ì²´ë  ìˆ˜ ìˆìŒ
                                "audio_urls": {}
                            },
                            // â–¼â–¼â–¼ ìƒ·ë³„ ìŒì•… ë©”ëª¨ ì¶”ê°€ â–¼â–¼â–¼
                            "music_memo": "ì´ ìƒ·ì€ ê°ì •ì”¬ì´ë¯€ë¡œ í”„ë¡œì íŠ¸ ì„œë¸Œ OST 2 (ì„œì •ì  í”¼ì•„ë…¸)ë¥¼ ì‚¬ìš©. ëŒ€ì‚¬ ì—†ì´ ìŒì•…ê³¼ í‘œì •ìœ¼ë¡œ ì „ë‹¬.",
                            // â–²â–²â–² ìƒ·ë³„ ìŒì•… ë©”ëª¨ ì¶”ê°€ ë â–²â–²â–²
                            "audio_prompts": {}
                        }
                    ]
                }
            };
        }
        // JSON ë°ì´í„° ë¡œë“œ
        async function loadData() {
            console.log('ğŸ”„ ë°ì´í„° ë¡œë“œ ì‹œì‘...');
            try {
                const jsonFileName = getProjectFileName();
                console.log('ğŸ“ ì°¾ì„ JSON íŒŒì¼:', jsonFileName);
                try {
                    console.log('ğŸ’¾ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í™•ì¸...');
                    const storedData = localStorage.getItem(`breakdownData_${jsonFileName}`);
                    if (storedData) {
                        currentData = JSON.parse(storedData);
                        showMessage('ì´ì „ ì‘ì—… ë°ì´í„°ë¥¼ ë³µêµ¬í–ˆìŠµë‹ˆë‹¤.', 'info');
                        return true;
                    }
                } catch (storageError) { console.warn('âš ï¸ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì½ê¸° ì‹¤íŒ¨:', storageError.message); }
                
                if (window.location.protocol === 'http:' || window.location.protocol === 'https:') {
                    try {
                        const response = await fetch(jsonFileName);
                        if (response.ok) {
                            const data = await response.json();
                            if (data && typeof data === 'object') {
                                currentData = data;
                                saveDataToLocalStorage();
                                showMessage(`${jsonFileName} íŒŒì¼ì„ ìë™ìœ¼ë¡œ ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`, 'success');
                                return true;
                            }
                        } else { console.log(`ğŸ¤· ${jsonFileName} íŒŒì¼ ì—†ìŒ (${response.status})`); }
                    } catch (fetchError) { console.log('âŒ JSON íŒŒì¼ ìë™ ë¡œë“œ ì‹¤íŒ¨:', fetchError.message); }
                } else { console.log('ğŸ“„ file:// í”„ë¡œí† ì½œ ê°ì§€ë¨ - ìë™ ë¡œë“œ ìƒëµ'); }
                
                currentData = createTestData();
                saveDataToLocalStorage();
                showMessage( (window.location.protocol === 'file:' ? `í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¡œ ì‹œì‘í•©ë‹ˆë‹¤. 'JSON ê°€ì ¸ì˜¤ê¸°'ë¡œ ì‹¤ì œ ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.` : `${jsonFileName} íŒŒì¼ì´ ì—†ì–´ í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¡œ ì‹œì‘í•©ë‹ˆë‹¤.`), 'info');
                return true;
            } catch (error) {
                console.error('âŒ ë°ì´í„° ë¡œë“œ ì „ì²´ ì˜¤ë¥˜:', error);
                showMessage(`ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: ${error.message}`, 'error');
                currentData = getDefaultData();
                saveDataToLocalStorage();
                return false;
            }
        }

        // ë°ì´í„° ì €ì¥
        function saveDataToLocalStorage() {
            try {
                if (currentData) {
                    const jsonFileName = getProjectFileName();
                    localStorage.setItem(`breakdownData_${jsonFileName}`, JSON.stringify(currentData));
                    localStorage.setItem(`lastSaved_${jsonFileName}`, new Date().toISOString());
                    console.log('ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥ ì™„ë£Œ:', JSON.parse(JSON.stringify(currentData))); // ê¹Šì€ ë³µì‚¬ë¡œ ë¡œê·¸ ìˆœí™˜ ì°¸ì¡° ë°©ì§€
                }
            } catch (error) { console.error('ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥ ì˜¤ë¥˜:', error); showMessage('ë¡œì»¬ ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error'); }
        }

        // JSON ë‚´ë³´ë‚´ê¸°
        function exportData() {
            console.log('JSON ë‚´ë³´ë‚´ê¸° ì‹œì‘...');
            try {
                if (!currentData) return showMessage('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                const jsonFileName = getProjectFileName();
                currentData.timestamp = new Date().toISOString();
                const blob = new Blob([JSON.stringify(currentData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = jsonFileName;
                document.body.appendChild(a); a.click();
                document.body.removeChild(a); URL.revokeObjectURL(url);
                localStorage.setItem(`lastSaved_${jsonFileName}`, new Date().toISOString());
                showMessage(`${jsonFileName} íŒŒì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            } catch (error) { console.error('ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error); showMessage(`ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜: ${error.message}`, 'error'); }
        }

        // JSON ê°€ì ¸ì˜¤ê¸°
        function importData() {
            console.log('JSON ê°€ì ¸ì˜¤ê¸° ì‹œì‘...');
            document.getElementById('file-input')?.click();
        }
        
        // íŒŒì¼ ì„ íƒ ë° ë³‘í•©/ë®ì–´ì“°ê¸° ì²˜ë¦¬
        function handleFileSelect(event) {
            console.log('íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸');
            const file = event.target.files[0];
            if (!file) { console.log('íŒŒì¼ ì„ íƒ ì·¨ì†Œë¨'); return; }

            console.log('ì„ íƒëœ íŒŒì¼:', file.name);
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const newData = JSON.parse(e.target.result);
                    let updated = false;

                    // í˜„ì¬ ë°ì´í„°ê°€ ì—†ê±°ë‚˜, ê°€ì ¸ì˜¨ ë°ì´í„°ê°€ ì „ì²´ êµ¬ì¡°ë¥¼ ê°€ì§€ê³  ìˆë‹¤ë©´ (sequences í•„ë“œ ê¸°ì¤€) ì „ì²´ ë®ì–´ì“°ê¸°
                    if (!currentData || (newData.breakdown_data && newData.breakdown_data.sequences)) {
                        console.log('ì „ì²´ ë°ì´í„° êµ¬ì¡°ë¡œ ë®ì–´ì”ë‹ˆë‹¤.');
                        currentData = newData;
                        updated = true;
                        showMessage('JSON ë°ì´í„°ë¥¼ ì „ì²´ ë¡œë“œí–ˆìŠµë‹ˆë‹¤.', 'success');
                    } 
                    // ê°€ì ¸ì˜¨ ë°ì´í„°ê°€ ìƒ· ì¤‘ì‹¬ì˜ ì—…ë°ì´íŠ¸ ë°ì´í„°ì¼ ê²½ìš° (shot_prompts ë˜ëŠ” breakdown_data.shots ì¡´ì¬ ê¸°ì¤€)
                    // (ìŠ¤í…Œì´ì§€ 6 ìŠ¤í‚¤ë§ˆëŠ” shot_prompts, ìŠ¤í…Œì´ì§€ 7 ìŠ¤í‚¤ë§ˆëŠ” breakdown_data.shots ì•ˆì— video_prompts ë“±ì„ í¬í•¨)
                    else if ((newData.shot_prompts || (newData.breakdown_data && newData.breakdown_data.shots)) && 
                               currentData && currentData.breakdown_data && currentData.breakdown_data.shots) {
                        console.log('ìƒ· ê¸°ë°˜ ë°ì´í„° ë³‘í•©ì„ ì‹œë„í•©ë‹ˆë‹¤.');
                        const shotsToUpdate = newData.shot_prompts || newData.breakdown_data.shots;

                        shotsToUpdate.forEach(newShotData => {
                            // ìŠ¤í…Œì´ì§€ 6ì€ shot_id, ìŠ¤í…Œì´ì§€ 7ì€ id ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ ë‘˜ ë‹¤ í™•ì¸
                            const shotIdToFind = newShotData.shot_id || newShotData.id; 
                            const existingShot = currentData.breakdown_data.shots.find(shot => shot.id === shotIdToFind);

                            if (existingShot) {
                                console.log(`ìƒ· ID ${shotIdToFind}ì— ëŒ€í•œ ë°ì´í„° ì—…ë°ì´íŠ¸ ì¤‘...`);
                                // ìŠ¤í…Œì´ì§€ 6ì˜ ai_promptsë¥¼ existingShot.image_promptsë¡œ ë³‘í•©
                                if (newShotData.ai_prompts) {
                                    if (!existingShot.image_prompts) existingShot.image_prompts = {};
                                    Object.keys(newShotData.ai_prompts).forEach(aiKey => {
                                        existingShot.image_prompts[aiKey] = { ...existingShot.image_prompts[aiKey], ...newShotData.ai_prompts[aiKey] };
                                    });
                                    console.log(`  - image_prompts ì—…ë°ì´íŠ¸ë¨.`);
                                    updated = true;
                                }
                                // ìŠ¤í…Œì´ì§€ 7ì˜ video_prompts, video_urls, final_video_selection, video_design ë³‘í•©
                                ['video_prompts', 'video_urls', 'final_video_selection', 'video_design'].forEach(videoKey => {
                                    if (newShotData[videoKey]) {
                                        existingShot[videoKey] = { ...existingShot[videoKey], ...newShotData[videoKey] };
                                        console.log(`  - ${videoKey} ì—…ë°ì´íŠ¸ë¨.`);
                                        updated = true;
                                    }
                                });
                                // ìŠ¤í…Œì´ì§€ 7ì˜ image_design (ìŠ¤í…Œì´ì§€ 5 êµ¬ì¡°) ì²˜ë¦¬ - HTMLì˜ ai_generated_imagesì™€ëŠ” ë³„ê°œë¡œ, ìˆë‹¤ë©´ ì—…ë°ì´íŠ¸
                                if (newShotData.image_design && newShotData.image_design.images) { // ìŠ¤í…Œì´ì§€ 5/7ì˜ images[]
                                    if (!existingShot.image_design) existingShot.image_design = {};
                                    existingShot.image_design.images = newShotData.image_design.images;
                                    // ë§Œì•½ HTMLì˜ ai_generated_imagesë„ ì´ ë°ì´í„° ê¸°ì¤€ìœ¼ë¡œ ì±„ì›Œì•¼ í•œë‹¤ë©´ ì¶”ê°€ ë¡œì§ í•„ìš”
                                    console.log(`  - image_design.images ì—…ë°ì´íŠ¸ë¨.`);
                                    updated = true;
                                }
                                // ì°¸ì¡° ì´ë¯¸ì§€ ë³‘í•©
                                if (newShotData.reference_images) {
                                    existingShot.reference_images = newShotData.reference_images;
                                    console.log(`  - reference_images ì—…ë°ì´íŠ¸ë¨.`);
                                    updated = true;
                                }
                                 // ê¸°íƒ€ content, camera_ ë“±ë“±ì˜ í•„ë“œë„ í•„ìš”ì‹œ ë³‘í•©
                                ['content', 'camera_movement', 'camera_framing', 'camera_effects', 'other_info'].forEach(key => {
                                    if (newShotData[key]) {
                                        existingShot[key] = { ...existingShot[key], ...newShotData[key] };
                                        updated = true;
                                    }
                                });
                            } else {
                                console.warn(`ê°€ì ¸ì˜¨ ë°ì´í„°ì˜ ìƒ· ID ${shotIdToFind}ë¥¼ í˜„ì¬ ë°ì´í„°ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                            }
                        });
                        if(updated) showMessage('ê°€ì ¸ì˜¨ JSONì˜ ìƒ· ì •ë³´ë¥¼ í˜„ì¬ ë°ì´í„°ì— ë³‘í•©/ì—…ë°ì´íŠ¸í–ˆìŠµë‹ˆë‹¤.', 'success');
                        else showMessage('ê°€ì ¸ì˜¨ JSONì—ì„œ ì—…ë°ì´íŠ¸í•  ìƒ· ì •ë³´ë¥¼ ì°¾ì§€ ëª»í–ˆê±°ë‚˜, ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.', 'info');

                    } else {
                        showMessage('ê°€ì ¸ì˜¨ JSON íŒŒì¼ì˜ êµ¬ì¡°ë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ê±°ë‚˜, í˜„ì¬ ë°ì´í„°ì™€ ë³‘í•©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                        event.target.value = ''; // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
                        return; 
                    }

                    saveDataToLocalStorage();
                    updateUI(); 
                    // ë³‘í•© í›„ í˜„ì¬ ì„ íƒëœ ìƒ·ì´ ìˆë‹¤ë©´ í•´ë‹¹ íƒ­ ë‹¤ì‹œ ë¡œë“œ
                    if (selectedType === 'shot' && selectedId) {
                        showShotContent(selectedId);
                        const lastActiveTab = localStorage.getItem(`shot_${selectedId}_activeTab`) || 'info';
                        setTimeout(() => switchTab(lastActiveTab, selectedId), 0);
                    }

                } catch (parseError) {
                    console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', parseError);
                    showMessage(`JSON íŒŒì‹± ì˜¤ë¥˜: ${parseError.message}`, 'error');
                }
            };
            reader.onerror = function() {
                console.error('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜');
                showMessage('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜', 'error');
            };
            reader.readAsText(file);
            event.target.value = ''; 
        }


        // ê²€ìƒ‰ ê¸°ëŠ¥
        function searchNavigation() {
            const searchInput = document.getElementById('search-input');
            const searchTerm = searchInput.value.toLowerCase();
            if (!currentData || !currentData.breakdown_data) return;
            const sequenceItems = document.querySelectorAll('.sequence-item');
            sequenceItems.forEach(item => {
                const sequenceText = item.textContent.toLowerCase();
                const isVisible = searchTerm === '' || sequenceText.includes(searchTerm);
                item.style.display = isVisible ? 'block' : 'none';
                if (isVisible && searchTerm !== '') {
                    const scenesContainer = item.querySelector('.scenes-container');
                    if (scenesContainer && scenesContainer.classList.contains('collapsed')) {
                        item.querySelector('.sequence-header').click(); 
                    }
                }
            });
        }

        // ì „ì²´ í¼ì¹˜ê¸°/ì ‘ê¸°
        function expandAll() {
            document.querySelectorAll('.sequence-header').forEach(header => {
                const sequenceId = header.dataset.sequenceId;
                const scenesContainer = document.getElementById(`scenes-${sequenceId}`);
                if (scenesContainer && scenesContainer.classList.contains('collapsed')) {
                    header.click(); // selectSequenceê°€ í˜¸ì¶œë˜ë©´ì„œ í† ê¸€ ë° ë¡œë“œ
                }
            });
            setTimeout(() => {
                 document.querySelectorAll('.scene-header').forEach(header => {
                    const sceneId = header.dataset.sceneId;
                    const shotsContainer = document.getElementById(`shots-${sceneId}`);
                    if (shotsContainer && shotsContainer.classList.contains('collapsed')) {
                       header.click(); // selectSceneì´ í˜¸ì¶œë˜ë©´ì„œ í† ê¸€ ë° ë¡œë“œ
                    }
                });
            }, 400); 
        }

        function collapseAll() {
            // ìƒ· ë¨¼ì € ì ‘ê¸° (ì”¬ì„ ì ‘ìœ¼ë©´ ìƒ·ë„ ê°™ì´ ì ‘í˜)
            document.querySelectorAll('.scene-header').forEach(header => {
                const sceneId = header.dataset.sceneId;
                const shotsContainer = document.getElementById(`shots-${sceneId}`);
                if (shotsContainer && !shotsContainer.classList.contains('collapsed')) {
                    header.click();
                }
            });
            // ì‹œí€€ìŠ¤ ì ‘ê¸°
            setTimeout(() => { // ì”¬ì´ ì™„ì „íˆ ì ‘íŒ í›„ ì‹œí€€ìŠ¤ ì ‘ê¸°
                document.querySelectorAll('.sequence-header').forEach(header => {
                    const sequenceId = header.dataset.sequenceId;
                    const scenesContainer = document.getElementById(`scenes-${sequenceId}`);
                    if (scenesContainer && !scenesContainer.classList.contains('collapsed')) {
                       header.click();
                    }
                });
            }, 400);
        }

        // UI ì—…ë°ì´íŠ¸
        function updateUI() {
            console.log('UI ì—…ë°ì´íŠ¸ ì‹œì‘...');
            try {
                updateHeaderInfo();
                updateNavigation();
                if (selectedId && selectedType) {
                    if (selectedType === 'shot') showShotContent(selectedId);
                    else if (selectedType === 'scene') showSceneContent(selectedId);
                    else if (selectedType === 'sequence') showSequenceContent(selectedId);
                } else {
                     document.getElementById('content-area').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ¬</div>
                            <div>ì‹œí€€ìŠ¤, ì”¬, ë˜ëŠ” ìƒ·ì„ ì„ íƒí•˜ì—¬ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”</div>
                        </div>`;
                }
                console.log('UI ì—…ë°ì´íŠ¸ ì™„ë£Œ');
            } catch (error) { console.error('UI ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error); showMessage('í™”ë©´ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ' + error.message, 'error'); }
        }

        // í—¤ë” ì •ë³´ ì—…ë°ì´íŠ¸
        function updateHeaderInfo() {
            try {
                const projectName = getProjectName();
                const jsonFileName = getProjectFileName();
                const projectTitleEl = document.getElementById('project-title');
                const projectFileEl = document.getElementById('project-file');
                const navProjectTitleEl = document.getElementById('nav-project-title');
                const navProjectFileEl = document.getElementById('nav-project-file');
                if (projectTitleEl) projectTitleEl.textContent = currentData?.film_metadata?.title_working || projectName;
                if (projectFileEl) projectFileEl.textContent = `íŒŒì¼: ${jsonFileName}`;
                if (navProjectTitleEl) navProjectTitleEl.textContent = currentData?.film_metadata?.title_working || projectName;
                if (navProjectFileEl) navProjectFileEl.textContent = `íŒŒì¼: ${jsonFileName}`;
            } catch (error) { console.error('í—¤ë” ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error); }
        }

        // ë„¤ë¹„ê²Œì´ì…˜ ì—…ë°ì´íŠ¸
        function updateNavigation() {
            try {
                const navContent = document.getElementById('navigation-content');
                if (!navContent) return console.error('ë„¤ë¹„ê²Œì´ì…˜ ì»¨í…ì¸  ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                if (!currentData || !currentData.breakdown_data || !currentData.breakdown_data.sequences || currentData.breakdown_data.sequences.length === 0) {
                    navContent.innerHTML = `<div class="empty-state" id="nav-empty"><div class="empty-state-icon">ğŸ“</div><div>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div><div style="font-size: 0.9rem; margin-top: 10px;">JSON ê°€ì ¸ì˜¤ê¸°ë¥¼ ì‚¬ìš©í•´ ë°ì´í„°ë¥¼ ë¡œë“œí•´ì£¼ì„¸ìš”</div></div>`;
                    return;
                }
                let html = '';
                currentData.breakdown_data.sequences.forEach(sequence => {
                    html += `<div class="sequence-item"><div class="sequence-header" data-sequence-id="${sequence.id}"><span class="toggle-icon">â–¶</span><span>${sequence.id}: ${sequence.title}</span></div><div class="scenes-container collapsed" id="scenes-${sequence.id}"></div></div>`;
                });
                navContent.innerHTML = html;
                setupSequenceEventListeners();
            } catch (error) { console.error('ë„¤ë¹„ê²Œì´ì…˜ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error); showMessage('ë„¤ë¹„ê²Œì´ì…˜ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ' + error.message, 'error'); }
        }

        // ì‹œí€€ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupSequenceEventListeners() {
            try {
                document.querySelectorAll('.sequence-header[data-sequence-id]').forEach(header => {
                    const newHeader = header.cloneNode(true); header.parentNode.replaceChild(newHeader, header);
                    newHeader.addEventListener('click', function(e) { e.preventDefault(); selectSequence(this.getAttribute('data-sequence-id'), this); });
                });
            } catch (error) { console.error('ì‹œí€€ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì˜¤ë¥˜:', error); }
        }

        // ì‹œí€€ìŠ¤ ì„ íƒ ë° í† ê¸€
        function selectSequence(sequenceId, headerElement = null) {
            try {
                const newlySelected = selectedId !== sequenceId || selectedType !== 'sequence';
                selectedType = 'sequence'; selectedId = sequenceId;
                document.querySelectorAll('.sequence-header.active, .scene-header.active, .shot-item.active').forEach(el => el.classList.remove('active'));
                const currentHeader = headerElement || document.querySelector(`.sequence-header[data-sequence-id="${sequenceId}"]`);
                if (currentHeader) currentHeader.classList.add('active');
                showSequenceContent(sequenceId);
                toggleSequenceScenes(sequenceId, newlySelected);
            } catch (error) { console.error('ì‹œí€€ìŠ¤ ì„ íƒ ì˜¤ë¥˜:', error); showMessage('ì‹œí€€ìŠ¤ ì„ íƒ ì˜¤ë¥˜: ' + error.message, 'error'); }
        }

        // ì‹œí€€ìŠ¤ì˜ ì”¬ë“¤ í† ê¸€
        function toggleSequenceScenes(sequenceId, forceOpen = false) {
            try {
                const scenesContainer = document.getElementById(`scenes-${sequenceId}`); if (!scenesContainer) return;
                const toggleIcon = scenesContainer.previousElementSibling.querySelector('.toggle-icon'); if (!toggleIcon) return;
                if (forceOpen || scenesContainer.classList.contains('collapsed')) {
                    scenesContainer.classList.remove('collapsed'); toggleIcon.classList.add('expanded'); toggleIcon.textContent = 'â–¼';
                    loadScenesForSequence(sequenceId, scenesContainer);
                } else {
                    scenesContainer.classList.add('collapsed'); toggleIcon.classList.remove('expanded'); toggleIcon.textContent = 'â–¶';
                }
            } catch (error) { console.error('ì”¬ í† ê¸€ ì˜¤ë¥˜:', error); }
        }

        // ì‹œí€€ìŠ¤ì˜ ì”¬ë“¤ ë¡œë“œ
        function loadScenesForSequence(sequenceId, container) {
            try {
                if (!currentData || !currentData.breakdown_data) return;
                const scenes = currentData.breakdown_data.scenes.filter(scene => scene.sequence_id === sequenceId);
                if (scenes.length === 0) { container.innerHTML = '<div style="padding: 15px 40px; color: #999; font-size: 0.9rem;">ì”¬ì´ ì—†ìŠµë‹ˆë‹¤</div>'; return; }
                let html = '';
                scenes.forEach(scene => { html += `<div class="scene-item"><div class="scene-header" data-scene-id="${scene.id}"><span class="toggle-icon">â–·</span><span>${scene.id}: ${scene.title}</span></div><div class="shots-container collapsed" id="shots-${scene.id}"></div></div>`; });
                container.innerHTML = html;
                container.querySelectorAll('.scene-header').forEach(header => {
                    const newHeader = header.cloneNode(true); header.parentNode.replaceChild(newHeader, header);
                    newHeader.addEventListener('click', function(e){ e.stopPropagation(); selectScene(this.dataset.sceneId, this); });
                });
            } catch (error) { console.error('ì”¬ ë¡œë“œ ì˜¤ë¥˜:', error); }
        }

        // ì”¬ ì„ íƒ
        function selectScene(sceneId, headerElement = null) {
            try {
                const newlySelected = selectedId !== sceneId || selectedType !== 'scene';
                selectedType = 'scene'; selectedId = sceneId; selectedSceneId = sceneId;
                document.querySelectorAll('.scene-header.active, .shot-item.active').forEach(el => el.classList.remove('active'));
                const scene = currentData.breakdown_data.scenes.find(s => s.id === sceneId);
                if (scene) document.querySelector(`.sequence-header[data-sequence-id="${scene.sequence_id}"]`)?.classList.add('active');
                const currentHeader = headerElement || document.querySelector(`.scene-header[data-scene-id="${sceneId}"]`);
                if(currentHeader) currentHeader.classList.add('active');
                showSceneContent(sceneId);
                toggleSceneShots(sceneId, newlySelected);
            } catch (error) { console.error('ì”¬ ì„ íƒ ì˜¤ë¥˜:', error); showMessage('ì”¬ ì„ íƒ ì˜¤ë¥˜: ' + error.message, 'error'); }
        }

        // ì”¬ì˜ ìƒ·ë“¤ í† ê¸€
        function toggleSceneShots(sceneId, forceOpen = false) {
            try {
                const shotsContainer = document.getElementById(`shots-${sceneId}`); if(!shotsContainer) return;
                const toggleIcon = shotsContainer.previousElementSibling.querySelector('.toggle-icon'); if(!toggleIcon) return;
                if (forceOpen || shotsContainer.classList.contains('collapsed')) {
                    shotsContainer.classList.remove('collapsed'); toggleIcon.classList.add('expanded'); toggleIcon.textContent = 'â–½';
                    loadShotsForScene(sceneId, shotsContainer);
                } else {
                    shotsContainer.classList.add('collapsed'); toggleIcon.classList.remove('expanded'); toggleIcon.textContent = 'â–·';
                }
            } catch (error) { console.error('ìƒ· í† ê¸€ ì˜¤ë¥˜:', error); }
        }

        // ì”¬ì˜ ìƒ·ë“¤ ë¡œë“œ
        function loadShotsForScene(sceneId, container) {
            try {
                if (!currentData || !currentData.breakdown_data) return;
                const shots = currentData.breakdown_data.shots.filter(shot => shot.scene_id === sceneId);
                if (shots.length === 0) { container.innerHTML = '<div style="padding: 15px 60px; color: #999; font-size: 0.9rem;">ìƒ·ì´ ì—†ìŠµë‹ˆë‹¤</div>'; return; }
                let html = '';
                shots.forEach(shot => { html += `<div class="shot-item" data-shot-id="${shot.id}"><span>${shot.id}: ${shot.title}</span></div>`; });
                container.innerHTML = html;
                 container.querySelectorAll('.shot-item').forEach(item => {
                    const newItem = item.cloneNode(true); item.parentNode.replaceChild(newItem, item);
                    newItem.addEventListener('click', function(e){ e.stopPropagation(); selectShot(this.dataset.shotId, this); });
                });
            } catch (error) { console.error('ìƒ· ë¡œë“œ ì˜¤ë¥˜:', error); }
        }

        // ìƒ· ì„ íƒ
        function selectShot(shotId, element = null) {
            try {
                selectedType = 'shot'; selectedId = shotId;
                document.querySelectorAll('.shot-item.active').forEach(el => el.classList.remove('active'));
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
                if (shot) {
                    const scene = currentData.breakdown_data.scenes.find(sc => sc.id === shot.scene_id);
                    if (scene) {
                        document.querySelector(`.scene-header[data-scene-id="${scene.id}"]`)?.classList.add('active');
                        document.querySelector(`.sequence-header[data-sequence-id="${scene.sequence_id}"]`)?.classList.add('active');
                    }
                }
                const currentElement = element || document.querySelector(`.shot-item[data-shot-id="${shotId}"]`);
                if(currentElement) currentElement.classList.add('active');
                showShotContent(shotId);
            } catch (error) { console.error('ìƒ· ì„ íƒ ì˜¤ë¥˜:', error); showMessage('ìƒ· ì„ íƒ ì˜¤ë¥˜: ' + error.message, 'error'); }
        }

        // ì‹œí€€ìŠ¤ ë‚´ìš© í‘œì‹œ
        function showSequenceContent(sequenceId) {
            try {
                const sequence = currentData.breakdown_data.sequences.find(s => s.id === sequenceId);
                if (!sequence) return console.error('ì‹œí€€ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', sequenceId);
                document.getElementById('content-title').textContent = `ì‹œí€€ìŠ¤: ${sequence.title}`;
                document.getElementById('content-subtitle').textContent = `ID: ${sequence.id}`;
                document.getElementById('content-actions').style.display = 'none';
                document.getElementById('content-area').innerHTML = `<div class="info-section"><h3>ì‹œí€€ìŠ¤ ì •ë³´</h3><table class="info-table"><tr><th>ID</th><td>${sequence.id}</td></tr><tr><th>ì œëª©</th><td>${sequence.title}</td></tr><tr><th>ê¸°ëŠ¥</th><td>${sequence.function || '-'}</td></tr><tr><th>ì„¤ëª…</th><td>${sequence.description || '-'}</td></tr><tr><th>ì˜ˆìƒ ê¸¸ì´</th><td>${sequence.duration_estimate || '-'}</td></tr></table></div>`;
            } catch (error) { console.error('ì‹œí€€ìŠ¤ ë‚´ìš© í‘œì‹œ ì˜¤ë¥˜:', error); showMessage('ì‹œí€€ìŠ¤ ë‚´ìš© í‘œì‹œ ì˜¤ë¥˜: ' + error.message, 'error'); }
        }

        // ì”¬ ë‚´ìš© í‘œì‹œ
        function showSceneContent(sceneId) {
            try {
                const scene = currentData.breakdown_data.scenes.find(s => s.id === sceneId);
                if (!scene) return console.error('ì”¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ:', sceneId);
                document.getElementById('content-title').textContent = `ì”¬: ${scene.title}`;
                document.getElementById('content-subtitle').textContent = `ID: ${scene.id}`;
                document.getElementById('content-actions').style.display = 'none';
                document.getElementById('content-area').innerHTML = `<div class="info-section"><h3>ì”¬ ì •ë³´</h3><table class="info-table"><tr><th>ID</th><td>${scene.id}</td></tr><tr><th>ì œëª©</th><td>${scene.title}</td></tr><tr><th>ì†Œì† ì‹œí€€ìŠ¤</th><td>${scene.sequence_id || '-'}</td></tr><tr><th>ì„¤ëª…</th><td>${scene.description || '-'}</td></tr></table></div>
                    ${scene.visual_consistency_info ? `<div class="info-section"><h3>ë¹„ì£¼ì–¼ ì •ë³´</h3><table class="info-table"><tr><th>ì¥ì†Œ ID</th><td>${scene.visual_consistency_info.location_id || '-'}</td></tr><tr><th>ìºë¦­í„° ID</th><td>${(scene.visual_consistency_info.character_ids || []).join(', ') || '-'}</td></tr><tr><th>ì†Œí’ˆ ID</th><td>${(scene.visual_consistency_info.prop_ids || []).join(', ') || '-'}</td></tr></table></div>` : ''}`;
            } catch (error) { console.error('ì”¬ ë‚´ìš© í‘œì‹œ ì˜¤ë¥˜:', error); showMessage('ì”¬ ë‚´ìš© í‘œì‹œ ì˜¤ë¥˜: ' + error.message, 'error'); }
        }

        // ìƒ· ë‚´ìš© í‘œì‹œ (íƒ­ í¬í•¨)
        function showShotContent(shotId) {
            try {
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
                if (!shot) return console.error('ìƒ·ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ:', shotId);
                document.getElementById('content-title').textContent = `ìƒ·: ${shot.title}`;
                document.getElementById('content-subtitle').textContent = `ID: ${shot.id}`;
                document.getElementById('content-actions').style.display = 'none';
                const lastActiveTab = localStorage.getItem(`shot_${shotId}_activeTab`) || 'info';
                document.getElementById('content-area').innerHTML = `
                    <div class="tabs">
                        <div class="tab-buttons">
                            <button class="tab-button ${lastActiveTab === 'info' ? 'active' : ''}" onclick="switchTab('info', '${shotId}')">ì •ë³´</button>
                            <button class="tab-button ${lastActiveTab === 'image' ? 'active' : ''}" onclick="switchTab('image', '${shotId}')">ì´ë¯¸ì§€</button>
                            <button class="tab-button ${lastActiveTab === 'video' ? 'active' : ''}" onclick="switchTab('video', '${shotId}')">ì˜ìƒ</button>
                            <button class="tab-button ${lastActiveTab === 'audio' ? 'active' : ''}" onclick="switchTab('audio', '${shotId}')">ì˜¤ë””ì˜¤</button>
                            <button class="tab-button ${lastActiveTab === 'music' ? 'active' : ''}" onclick="switchTab('music', '${shotId}')">ìŒì•…</button>
                        </div>
                        <div id="tab-info" class="tab-content ${lastActiveTab === 'info' ? 'active' : ''}" style="display: ${lastActiveTab === 'info' ? 'block' : 'none'};">${createShotInfoTab(shot)}</div>
                        <div id="tab-image" class="tab-content ${lastActiveTab === 'image' ? 'active' : ''}" style="display: ${lastActiveTab === 'image' ? 'block' : 'none'};">${createShotImageTab(shot)}</div>
                        <div id="tab-video" class="tab-content ${lastActiveTab === 'video' ? 'active' : ''}" style="display: ${lastActiveTab === 'video' ? 'block' : 'none'};">${createShotVideoTab(shot)}</div>
                        <div id="tab-audio" class="tab-content ${lastActiveTab === 'audio' ? 'active' : ''}" style="display: ${lastActiveTab === 'audio' ? 'block' : 'none'};">${createShotAudioTab(shot)}</div>
                        <div id="tab-music" class="tab-content ${lastActiveTab === 'music' ? 'active' : ''}" style="display: ${lastActiveTab === 'music' ? 'block' : 'none'};">${createShotMusicTab(shot)}</div>
                    </div>`;
            } catch (error) { console.error('ìƒ· ë‚´ìš© í‘œì‹œ ì˜¤ë¥˜:', error); showMessage('ìƒ· ë‚´ìš© í‘œì‹œ ì˜¤ë¥˜: ' + error.message, 'error'); }
        }

        // íƒ­ ì „í™˜
        function switchTab(tabName, shotId = null) { 
            try {
                const tabContainer = document.querySelector('.tabs'); if (!tabContainer) return;
                tabContainer.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                tabContainer.querySelectorAll('.tab-content').forEach(content => { content.style.display = 'none'; content.classList.remove('active'); });
                const activeButton = tabContainer.querySelector(`[onclick*="switchTab('${tabName}'"]`);
                const activeContent = document.getElementById(`tab-${tabName}`);
                if (activeButton) activeButton.classList.add('active');
                if (activeContent) { activeContent.style.display = 'block'; activeContent.classList.add('active');}
                if (shotId) localStorage.setItem(`shot_${shotId}_activeTab`, tabName);
            } catch (error) { console.error('íƒ­ ì „í™˜ ì˜¤ë¥˜:', error); showMessage('íƒ­ ì „í™˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error'); }
        }

        // ìƒ· ì •ë³´ íƒ­ ìƒì„±
        function createShotInfoTab(shot) {
            return `
                <div class="info-section"><h3>ê¸°ë³¸ ì •ë³´</h3><table class="info-table"><tr><th>ID</th><td>${shot.id}</td></tr><tr><th>ì œëª©</th><td>${shot.title}</td></tr><tr><th>ì†Œì† ì”¬</th><td>${shot.scene_id || '-'}</td></tr><tr><th>ìƒ· ìœ í˜•</th><td>${shot.shot_type || '-'}</td></tr><tr><th>ì„¤ëª…</th><td>${shot.description || '-'}</td></tr><tr><th>ì˜ˆìƒ ê¸¸ì´</th><td>${shot.other_info?.estimated_duration || '-'}ì´ˆ</td></tr></table></div>
                <div class="info-section"><h3>ë©”ëª¨</h3><textarea class="form-textarea" placeholder="ì´ ìƒ·ì— ëŒ€í•œ ë©”ëª¨..." onchange="updateShotMemo('${shot.id}', this.value)">${getShotMemo(shot.id)}</textarea><small style="color:#666;font-size:0.85rem;">ë©”ëª¨ëŠ” ìë™ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.</small></div>
                ${shot.visual_consistency_info ? `<div class="info-section"><h3>ë¹„ì£¼ì–¼ ì¼ê´€ì„± ì •ë³´</h3><table class="info-table"><tr><th>ì¥ì†Œ ID</th><td>${shot.visual_consistency_info.location_id || '-'}</td></tr><tr><th>ìºë¦­í„° ID</th><td>${(shot.visual_consistency_info.character_ids || []).join(', ') || '-'}</td></tr><tr><th>ì†Œí’ˆ ID</th><td>${(shot.visual_consistency_info.prop_ids || []).join(', ') || '-'}</td></tr></table></div>` : ''}
                ${shot.camera_framing ? `<div class="info-section"><h3>ì¹´ë©”ë¼ ì •ë³´</h3><table class="info-table"><tr><th>í”„ë ˆì´ë°</th><td>${shot.camera_framing.framing || '-'}</td></tr><tr><th>ì•µê¸€</th><td>${shot.camera_framing.angle || '-'}</td></tr><tr><th>ì‹œì  ë°©í–¥</th><td>${shot.camera_framing.view_direction || '-'}</td></tr><tr><th>êµ¬ë„</th><td>${shot.camera_framing.composition || '-'}</td></tr></table></div>` : ''}
                ${shot.content ? `<div class="info-section"><h3>ì½˜í…ì¸ </h3><table class="info-table"><tr><th>ì•¡ì…˜</th><td>${shot.content.action || '-'}</td></tr><tr><th>ìŒí–¥ íš¨ê³¼</th><td>${shot.content.sound_effects || '-'}</td></tr><tr><th>ë‚˜ë ˆì´ì…˜</th><td>${shot.content.narration || '-'}</td></tr></table></div>` : ''}`;
        }

        // ìƒ· ì´ë¯¸ì§€ íƒ­ ìƒì„± (4ê°œ AI ì„¹ì…˜ ë° AIë³„ ì´ë¯¸ì§€ 3ê°œ ìŠ¬ë¡¯ ë°©ì‹)
        function createShotImageTab(shot) {
            console.log('ğŸ–¼ï¸ createShotImageTab ì‹œì‘ (4 AI ì„¹ì…˜ ë°©ì‹)');
            try {
                const imagePrompts = shot.image_prompts || {};
                const aiGeneratedImages = shot.image_design?.ai_generated_images || {};
                const referenceImagesData = shot.reference_images || [];

                const imageAIs = [ { id: 'midjourney', name: 'Midjourney' }, { id: 'ideogram', name: 'Ideogram' }, { id: 'leonardo', name: 'Leonardo' }, { id: 'imagefx', name: 'ImageFX' } ];
                let aiSectionsHtml = imageAIs.map(ai => {
                    const currentAiPrompts = imagePrompts[ai.id] || {};
                    const mainPrompt = currentAiPrompts.main_prompt || 'í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.';
                    const parameters = currentAiPrompts.parameters || '';
                    const fullPromptForCopy = `${mainPrompt}${parameters ? ` ${parameters}` : ''}`.replace(/'/g, "&#39;").replace(/"/g, "&quot;").replace(/\n/g, "\\n");
                    let imageSlotsHtml = '';
                    for (let i = 0; i < 3; i++) { 
                        const imageSlotData = aiGeneratedImages[ai.id]?.[i] || { url: '', description: '' };
                        const uniqueSlotId = `${shot.id}-${ai.id}-img${i}`;
                        imageSlotsHtml += `
                            <div class="image-slot-card" id="slot-card-${uniqueSlotId}">
                                <div class="image-slot-preview" id="slot-preview-${uniqueSlotId}">${imageSlotData.url ? `<img src="${imageSlotData.url}" alt="${ai.name} ì´ë¯¸ì§€ ${i+1}" onerror="this.style.display='none'; this.parentElement.innerHTML = '<div style=&quot;color: #999; font-size: 0.8rem;&quot;>ë¡œë“œ ì‹¤íŒ¨</div>';">` : `<div style="color: #999; font-size: 0.8rem;">URL ì…ë ¥</div>`}</div>
                                <div class="form-group"><label class="form-label" for="slot-url-${uniqueSlotId}">URL:</label><input type="text" class="form-input" id="slot-url-${uniqueSlotId}" value="${imageSlotData.url || ''}" placeholder="${ai.name} ${i+1} URL" onchange="updateAIGeneratedImageUrl('${shot.id}', '${ai.id}', ${i}, this.value)"></div>
                                <div class="form-group"><label class="form-label" for="slot-desc-${uniqueSlotId}">ì„¤ëª…:</label><textarea class="form-textarea" id="slot-desc-${uniqueSlotId}" placeholder="${ai.name} ${i+1} ì„¤ëª…" onchange="updateAIGeneratedImageDescription('${shot.id}', '${ai.id}', ${i}, this.value)">${imageSlotData.description || ''}</textarea></div>
                                <div class="image-slot-actions"><button class="btn btn-small btn-secondary" onclick="openImageModal('${imageSlotData.url || ''}')" ${!imageSlotData.url ? 'disabled' : ''}>í¬ê²Œ ë³´ê¸°</button></div>
                            </div>`;
                    }
                    return `
                        <div class="ai-image-section ${ai.id}" id="ai-section-${shot.id}-${ai.id}">
                            <div class="ai-card-header">${ai.name}</div>
                            <div class="ai-image-prompt-details">
                                <label class="prompt-text-label">AI ìƒì„± í”„ë¡¬í”„íŠ¸ (í”„ë¡¬í”„íŠ¸ + íŒŒë¼ë¯¸í„°):</label>
                                <div class="ai-image-prompt-full-text">${mainPrompt}${parameters ? ` <br><strong style='font-family: inherit; font-size:0.9em; color:#555'>Parameters:</strong> ${parameters}` : ''}</div>
                                <button class="copy-btn" onclick="copyImageAIPrompt('${fullPromptForCopy}', '${ai.name}')">ì „ì²´ í”„ë¡¬í”„íŠ¸ ë³µì‚¬</button>
                            </div>
                            <h4>ìƒì„±ëœ ì´ë¯¸ì§€ (ìµœëŒ€ 3ê°œ)</h4><div class="generated-images-grid">${imageSlotsHtml}</div>
                        </div>`;
                }).join('');
                let referenceSlotsHtml = '';
                for (let i = 0; i < 3; i++) {
                    const refData = referenceImagesData[i] || { url: '', description: '', type: 'composition' };
                    const uniqueRefId = `${shot.id}-ref${i}`;
                    referenceSlotsHtml += `
                        <div class="reference-image-slot" id="ref-slot-card-${uniqueRefId}">
                             <div class="reference-preview" id="ref-preview-${uniqueRefId}">${refData.url ? `<img src="${refData.url}" alt="ì°¸ì¡° ${i+1}" onerror="this.style.display='none'; this.parentElement.innerHTML = '<div style=&quot;color:#999;font-size:0.8rem;&quot;>ë¡œë“œ ì‹¤íŒ¨</div>';">` : `<div style="color:#999;font-size:0.8rem;">ì°¸ì¡° ${i+1} URL</div>`}</div>
                            <div class="form-group"><label class="form-label" for="ref-url-${uniqueRefId}">URL:</label><input type="text" class="form-input" id="ref-url-${uniqueRefId}" value="${refData.url || ''}" placeholder="ì°¸ì¡° ${i+1} URL" onchange="updateReferenceImage('${shot.id}', ${i}, 'url', this.value)"></div>
                            <div class="form-group"><label class="form-label" for="ref-desc-${uniqueRefId}">ì„¤ëª…:</label><textarea class="form-textarea" id="ref-desc-${uniqueRefId}" onchange="updateReferenceImage('${shot.id}', ${i}, 'description', this.value)" placeholder="ì°¸ì¡° ${i+1} ì„¤ëª…">${refData.description || ''}</textarea></div>
                            <div class="form-group"><label class="form-label" for="ref-type-${uniqueRefId}">ìœ í˜•:</label><select class="form-select" id="ref-type-${uniqueRefId}" onchange="updateReferenceImage('${shot.id}', ${i}, 'type', this.value)">
                                <option value="composition" ${refData.type === 'composition' ? 'selected' : ''}>êµ¬ë„</option><option value="style" ${refData.type === 'style' ? 'selected' : ''}>ìŠ¤íƒ€ì¼</option><option value="appearance" ${refData.type === 'appearance' ? 'selected' : ''}>ì™¸í˜•</option><option value="lighting" ${refData.type === 'lighting' ? 'selected' : ''}>ì¡°ëª…</option><option value="mood" ${refData.type === 'mood' ? 'selected' : ''}>ë¶„ìœ„ê¸°</option></select></div>
                            <button class="btn btn-small btn-danger" onclick="clearReferenceImageSlot('${shot.id}', ${i})">ì´ ìŠ¬ë¡¯ ë¹„ìš°ê¸°</button>
                        </div>`;
                }
                return `
                    <div class="info-section"><h3>ğŸ¨ AI ì´ë¯¸ì§€ ìƒì„± ë° ê´€ë¦¬</h3><p style="font-size:0.9em;color:#555;margin-bottom:20px;">ê° AI ë„êµ¬ë³„ í”„ë¡¬í”„íŠ¸ë¥¼ í™•ì¸í•˜ê³ , ìƒì„±ëœ ì´ë¯¸ì§€ë¥¼ ìµœëŒ€ 3ê°œê¹Œì§€ ë“±ë¡ ë° ê´€ë¦¬í•˜ì„¸ìš”.</p><div class="image-ai-grid">${aiSectionsHtml}</div></div>
                    <div class="info-section reference-image-slots-container"><h3>ğŸ–¼ï¸ ì°¸ì¡° ì´ë¯¸ì§€ (3ê°œ ìŠ¬ë¡¯)</h3><p style="font-size:0.9em;color:#555;margin-bottom:20px;">ì´ë¯¸ì§€ ìƒì„± ì‹œ ì°¸ê³ í•  ì´ë¯¸ì§€ë¥¼ ë“±ë¡í•˜ì„¸ìš”.</p><div class="reference-image-slots-grid">${referenceSlotsHtml}</div></div>
                    <div id="imageDisplayModal" class="image-modal" onclick="closeImageModal(event)"><span class="image-modal-close" onclick="closeImageModal(event)">&times;</span><img class="image-modal-content" id="modalImageContent"></div>`;
            } catch (error) { console.error('âŒ createShotImageTab ì˜¤ë¥˜:', error); return `<div class="info-section"><h3>ì´ë¯¸ì§€ íƒ­ ë¡œë“œ ì˜¤ë¥˜</h3><p>${error.message}</p></div>`; }
        }

        // AI ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ (í”„ë¡¬í”„íŠ¸+íŒŒë¼ë¯¸í„°) ë³µì‚¬ í•¨ìˆ˜
        function copyImageAIPrompt(fullPrompt, aiName) {
            const actualFullPrompt = fullPrompt.replace(/\\n/g, "\n");
            if (!actualFullPrompt || actualFullPrompt.trim() === 'í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.') return showMessage(`${aiName} í”„ë¡¬í”„íŠ¸ê°€ ë¹„ì–´ ë³µì‚¬ ë¶ˆê°€.`, 'warning');
            copyToClipboard(actualFullPrompt).then(ok => ok && showMessage(`${aiName} ì „ì²´ í”„ë¡¬í”„íŠ¸ ë³µì‚¬ë¨.`, 'success'));
        }

        // AIë³„ ìƒì„± ì´ë¯¸ì§€ URL ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateAIGeneratedImageUrl(shotId, aiType, imageIndex, newUrl) {
            try {
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId); if (!shot) return showMessage('ìƒ· ë°ì´í„° ì—†ìŒ.', 'error');
                if (!shot.image_design) shot.image_design = { aspect_ratio: "16:9" };
                if (!shot.image_design.ai_generated_images) shot.image_design.ai_generated_images = {};
                if (!shot.image_design.ai_generated_images[aiType]) shot.image_design.ai_generated_images[aiType] = [null,null,null].map(()=>({url:'', description:''}));
                if (imageIndex < 3) {
                    if (!shot.image_design.ai_generated_images[aiType][imageIndex]) shot.image_design.ai_generated_images[aiType][imageIndex] = { url: newUrl, description: '' };
                    else shot.image_design.ai_generated_images[aiType][imageIndex].url = newUrl;
                }
                saveDataToLocalStorage();
                const uid = `${shotId}-${aiType}-img${imageIndex}`;
                const preview = document.getElementById(`slot-preview-${uid}`);
                const viewBtn = document.querySelector(`#slot-card-${uid} .image-slot-actions button`);
                if (preview) {
                    if (newUrl) { preview.innerHTML = `<img src="${newUrl}" alt="${aiType} ${imageIndex+1}" onerror="this.style.display='none';this.parentElement.innerHTML='<div style=&quot;color:#999;font-size:0.8rem;&quot;>ë¡œë“œ ì‹¤íŒ¨</div>';">`; if(viewBtn) viewBtn.disabled = false; }
                    else { preview.innerHTML = `<div style="color:#999;font-size:0.8rem;">URL ì…ë ¥</div>`; if(viewBtn) viewBtn.disabled = true; }
                }
            } catch (e) { console.error("URL ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", e); showMessage('URL ì—…ë°ì´íŠ¸ ì˜¤ë¥˜', 'error');}
        }

        // AIë³„ ìƒì„± ì´ë¯¸ì§€ ì„¤ëª… ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateAIGeneratedImageDescription(shotId, aiType, imageIndex, newDescription) {
            try {
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId); if (!shot) return showMessage('ìƒ· ë°ì´í„° ì—†ìŒ.', 'error');
                if (!shot.image_design) shot.image_design = { aspect_ratio: "16:9" };
                if (!shot.image_design.ai_generated_images) shot.image_design.ai_generated_images = {};
                if (!shot.image_design.ai_generated_images[aiType]) shot.image_design.ai_generated_images[aiType] = [null,null,null].map(()=>({url:'', description:''}));
                if (imageIndex < 3) {
                    if (!shot.image_design.ai_generated_images[aiType][imageIndex]) shot.image_design.ai_generated_images[aiType][imageIndex] = { url: '', description: newDescription };
                    else shot.image_design.ai_generated_images[aiType][imageIndex].description = newDescription;
                    saveDataToLocalStorage();
                }
            } catch (e) { console.error("ì„¤ëª… ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", e); showMessage('ì„¤ëª… ì—…ë°ì´íŠ¸ ì˜¤ë¥˜', 'error');}
        }
        
        // ì°¸ì¡° ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateReferenceImage(shotId, refIndex, field, value) {
            try {
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId); if (!shot) return showMessage('ìƒ· ë°ì´í„° ì—†ìŒ.', 'error');
                if (!shot.reference_images) shot.reference_images = [];
                while (shot.reference_images.length <= refIndex) { shot.reference_images.push({ id: `ref_img_${shot.reference_images.length + 1}_${shotId}`, url: '', description: '', type: 'composition' }); }
                shot.reference_images[refIndex][field] = value;
                if (!shot.reference_images[refIndex].id) shot.reference_images[refIndex].id = `ref_img_${refIndex + 1}_${shotId}`;
                saveDataToLocalStorage();
                if (field === 'url') { 
                    const uid = `${shotId}-ref${refIndex}`;
                    const preview = document.getElementById(`ref-preview-${uid}`);
                    if (preview) {
                        if (value) preview.innerHTML = `<img src="${value}" alt="ì°¸ì¡° ${refIndex+1}" onerror="this.style.display='none';this.parentElement.innerHTML='<div style=&quot;color:#999;font-size:0.8rem;&quot;>ë¡œë“œ ì‹¤íŒ¨</div>';">`;
                        else preview.innerHTML = `<div style="color:#999;font-size:0.8rem;">ì°¸ì¡° ${refIndex+1} URL</div>`;
                    }
                }
            } catch (e) { console.error("ì°¸ì¡° ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", e); showMessage('ì°¸ì¡° ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜', 'error');}
        }

        // ì°¸ì¡° ì´ë¯¸ì§€ ìŠ¬ë¡¯ ë¹„ìš°ê¸° í•¨ìˆ˜
        function clearReferenceImageSlot(shotId, refIndex) {
            try {
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
                if (shot && shot.reference_images && shot.reference_images[refIndex]) {
                    shot.reference_images[refIndex] = { id: `ref_img_${refIndex + 1}_${shotId}`, url: '', description: '', type: 'composition' };
                    saveDataToLocalStorage();
                }
                const uid = `${shotId}-ref${refIndex}`;
                const urlIn = document.getElementById(`ref-url-${uid}`); if(urlIn) urlIn.value='';
                const descIn = document.getElementById(`ref-desc-${uid}`); if(descIn) descIn.value='';
                const typeSel = document.getElementById(`ref-type-${uid}`); if(typeSel) typeSel.value='composition';
                const preview = document.getElementById(`ref-preview-${uid}`); if(preview) preview.innerHTML = `<div style="color:#999;font-size:0.8rem;">ì°¸ì¡° ${refIndex+1} URL</div>`;
                showMessage(`ì°¸ì¡° ì´ë¯¸ì§€ ìŠ¬ë¡¯ ${refIndex+1} ë¹„ì›Œì§.`, 'success');
            } catch (e) { console.error("ì°¸ì¡° ìŠ¬ë¡¯ ë¹„ìš°ê¸° ì˜¤ë¥˜:", e); showMessage('ì°¸ì¡° ìŠ¬ë¡¯ ë¹„ìš°ê¸° ì˜¤ë¥˜', 'error');}
        }

        // ì´ë¯¸ì§€ í¬ê²Œ ë³´ê¸° ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
        function openImageModal(imageUrl) {
            const modal = document.getElementById('imageDisplayModal'); const modalImg = document.getElementById('modalImageContent');
            if (modal && modalImg && imageUrl && imageUrl.trim() !== '') { modalImg.src = imageUrl; modal.style.display = "flex"; } 
            else if (!imageUrl || imageUrl.trim() === '') { showMessage('ì´ë¯¸ì§€ URLì´ ì—†ì–´ í¬ê²Œ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'warning'); }
        }
        function closeImageModal(event) { 
            const modal = document.getElementById('imageDisplayModal');
            if (modal && ( (event && event.target === modal) || (event && event.target.classList.contains('image-modal-close')) || !event ) ) { // Xë²„íŠ¼ ë˜ëŠ” ë°°ê²½ í´ë¦­
                modal.style.display = "none"; document.getElementById('modalImageContent').src = ""; 
            }
        }

        // Deprecated image functions (for reference or future migration, not active use)
        function updateImageUrl(s,i,n){console.warn("updateImageUrl deprecated")} function updateImageDescription(s,i,n){console.warn("updateImageDescription deprecated")} function addNewImage(s){console.warn("addNewImage deprecated");showMessage('AIì„¹ì…˜ ìŠ¬ë¡¯ ì´ìš©','info')} function removeReference(s,i){console.warn("removeReference deprecated");clearReferenceImageSlot(s,i)} function updateReferenceType(s,i,n){console.warn("updateReferenceType deprecated");updateReferenceImage(s,i,'type',n)} function updateReferenceUrl(s,i,n){console.warn("updateReferenceUrl deprecated");updateReferenceImage(s,i,'url',n)} function updateReferenceDescription(s,i,n){console.warn("updateReferenceDescription deprecated");updateReferenceImage(s,i,'description',n)} function addNewReference(s){console.warn("addNewReference deprecated");showMessage('ì°¸ì¡° ìŠ¬ë¡¯ì€ í•­ìƒ 3ê°œ í‘œì‹œ','info')}

        // ìƒ· ì˜ìƒ íƒ­ ìƒì„± (4ê°œ AI ì¹´ë“œ ë°©ì‹)
        function createShotVideoTab(shot) {
            console.log('ğŸ¥ createShotVideoTab ì‹œì‘ (4 AI ì¹´ë“œ ë°©ì‹)');
            try {
                const videoPrompts = shot.video_prompts || {}; const videoUrls = shot.video_urls || {}; const selectedAi = shot.video_design?.selected_ai || null; 
                const aiTools = [ { id: 'luma', name: 'Luma AI', prompt: videoPrompts.luma?.main_prompt, settings: videoPrompts.luma?.settings, url: videoUrls.luma }, { id: 'kling', name: 'Kling AI', prompt: videoPrompts.kling?.main_prompt, settings: videoPrompts.kling?.settings, url: videoUrls.kling }, { id: 'veo2', name: 'Google Veo 2', prompt: videoPrompts.veo2?.main_prompt, settings: videoPrompts.veo2?.settings, url: videoUrls.veo2 }, { id: 'runway', name: 'Runway ML', prompt: videoPrompts.runway?.main_prompt, settings: videoPrompts.runway?.settings, url: videoUrls.runway } ];
                let cardsHtml = aiTools.map(ai => {
                    const isSelected = selectedAi === ai.id; const promptForCopy = (ai.prompt || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;").replace(/\n/g, "\\n");
                    let settingsHtml = ai.settings && Object.keys(ai.settings).length > 0 ? `<div class="ai-settings-info"><strong>ì„¤ì •:</strong> ${JSON.stringify(ai.settings)}</div>` : `<div class="ai-settings-info">ì„¤ì • ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                    return `
                        <div class="ai-video-card ${ai.id} ${isSelected ? 'selected-ai-card' : ''}" id="ai-card-${shot.id}-${ai.id}">
                            <div class="ai-card-header">${ai.name}</div>
                            <div class="ai-card-content">
                                <div class="ai-prompt-area"><label class="form-label">ì˜ìƒ ìƒì„± í”„ë¡¬í”„íŠ¸:</label><div class="prompt-text" id="prompt-text-${shot.id}-${ai.id}">${ai.prompt || 'í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.'}</div><button class="copy-prompt-btn" onclick="copyAIPrompt('${promptForCopy}', '${ai.name}')">í”„ë¡¬í”„íŠ¸ ë³µì‚¬</button></div>
                                <div class="form-group"><label class="form-label">ì˜ìƒ URL:</label><input type="text" class="form-input" value="${ai.url || ''}" placeholder="${ai.name} ì˜ìƒ URL" onchange="updateAIVideoUrl('${shot.id}', '${ai.id}', this.value)"></div>
                                <div class="ai-video-preview" id="video-preview-${shot.id}-${ai.id}">${ai.url ? `<video controls style="max-width:100%;max-height:200px;border-radius:6px;" src="${ai.url}" onerror="this.style.display='none';this.parentElement.innerHTML='<div style=&quot;color:#999;font-size:0.9rem;&quot;>ë¡œë“œ ì‹¤íŒ¨</div>';"></video>` : `<div style="color:#999;font-size:0.9rem;">URL ì…ë ¥</div>`}</div>
                                ${settingsHtml}
                            </div>
                            <button class="ai-select-button ${isSelected ? 'selected' : ''}" id="select-btn-${shot.id}-${ai.id}" onclick="selectFinalAI('${shot.id}', '${ai.id}')">${isSelected ? 'âœ“ ìµœì¢… ì„ íƒë¨' : `ì´ AIë¡œ ìµœì¢… ì„ íƒ`}</button>
                        </div>`;
                }).join('');
                return `
                    <div class="info-section"><h3>ğŸ¬ AI ê¸°ë°˜ ì˜ìƒ ìƒì„± ê´€ë¦¬</h3><p style="font-size:0.9em;color:#555;margin-bottom:20px;">AI ë„êµ¬ë³„ í”„ë¡¬í”„íŠ¸ë¥¼ í™•ì¸í•˜ê³ , ìƒì„±ëœ ì˜ìƒ URLì„ ì…ë ¥í•˜ì—¬ ê´€ë¦¬í•˜ì„¸ìš”. ìµœì¢… ì‚¬ìš©í•  ì˜ìƒì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><div class="video-ai-grid">${cardsHtml}</div></div>
                    <div class="info-section" style="margin-top:30px;"><h3>ê¸°ì¡´ ì˜ìƒ ì •ë³´ (ì°¸ê³ ìš©)</h3><table class="info-table"><tr><th>ìµœì¢… ì„ íƒ AI</th><td id="legacy-ai-tool-${shot.id}">${shot.video_design?.selected_ai || shot.video_design?.ai_tool || '-'}</td></tr><tr><th>ìµœì¢… ì˜ìƒ URL</th><td id="legacy-video-url-${shot.id}">${shot.video_design?.video_url || '-'}</td></tr></table><small style="color:#777;font-size:0.85em;">ì„ íƒëœ AIì˜ ì •ë³´ê°€ ì—¬ê¸°ì— ë°˜ì˜ë©ë‹ˆë‹¤.</small></div>`;
            } catch (e) { console.error('âŒ createShotVideoTab ì˜¤ë¥˜:', e); return `<div class="info-section"><h3>ì˜ìƒ íƒ­ ë¡œë“œ ì˜¤ë¥˜</h3><p>${e.message}</p></div>`; }
        }

        // AI ì˜ìƒ í”„ë¡¬í”„íŠ¸ ë³µì‚¬ í•¨ìˆ˜
        function copyAIPrompt(promptText, aiName) {
            const actualPromptText = promptText.replace(/\\n/g, "\n");
            if (!actualPromptText || actualPromptText.trim() === 'í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.') return showMessage(`${aiName} í”„ë¡¬í”„íŠ¸ ë¹„ì–´ ë³µì‚¬ ë¶ˆê°€.`, 'warning');
            copyToClipboard(actualPromptText).then(ok => ok && showMessage(`${aiName} ì˜ìƒ í”„ë¡¬í”„íŠ¸ ë³µì‚¬ë¨.`, 'success'));
        }

        // AIë³„ ì˜ìƒ URL ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateAIVideoUrl(shotId, aiType, newUrl) {
            try {
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId); if (!shot) return showMessage('ìƒ· ë°ì´í„° ì—†ìŒ.', 'error');
                if (!shot.video_urls) shot.video_urls = {}; shot.video_urls[aiType] = newUrl;
                if (!shot.video_design) shot.video_design = { ai_tool: '', video_url: '', selected_ai: null };
                if (shot.video_design.selected_ai === aiType) {
                    shot.video_design.video_url = newUrl;
                    const legacyUrlCell = document.getElementById(`legacy-video-url-${shot.id}`); if (legacyUrlCell) legacyUrlCell.textContent = newUrl || '-';
                    const legacyAiToolCell = document.getElementById(`legacy-ai-tool-${shot.id}`); if (legacyAiToolCell) legacyAiToolCell.textContent = aiType || '-';
                }
                saveDataToLocalStorage();
                const preview = document.getElementById(`video-preview-${shot.id}-${aiType}`);
                if (preview) {
                    if (newUrl) preview.innerHTML = `<video controls style="max-width:100%;max-height:200px;border-radius:6px;" src="${newUrl}" onerror="this.style.display='none';this.parentElement.innerHTML='<div style=&quot;color:#999;font-size:0.9rem;&quot;>ë¡œë“œ ì‹¤íŒ¨</div>';"></video>`;
                    else preview.innerHTML = `<div style="color:#999;font-size:0.9rem;">URL ì…ë ¥</div>`;
                }
            } catch (e) { console.error("ì˜ìƒ URL ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", e); showMessage('ì˜ìƒ URL ì—…ë°ì´íŠ¸ ì˜¤ë¥˜', 'error');}
        }

        // ìµœì¢… AI ì„ íƒ í•¨ìˆ˜
        function selectFinalAI(shotId, aiType) {
            try {
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId); if (!shot) return showMessage('ìƒ· ë°ì´í„° ì—†ìŒ.', 'error');
                if (!shot.video_design) shot.video_design = { ai_tool: aiType, video_url: '', selected_ai: aiType };
                else { shot.video_design.selected_ai = aiType; shot.video_design.ai_tool = aiType; }
                if (!shot.video_urls) shot.video_urls = {}; shot.video_design.video_url = shot.video_urls[aiType] || '';
                saveDataToLocalStorage();
                ['luma', 'kling', 'veo2', 'runway'].forEach(id => {
                    const card = document.getElementById(`ai-card-${shot.id}-${id}`); const btn = document.getElementById(`select-btn-${shot.id}-${id}`);
                    if (card && btn) {
                        if (id === aiType) { card.classList.add('selected-ai-card'); btn.classList.add('selected'); btn.textContent = 'âœ“ ìµœì¢… ì„ íƒë¨'; }
                        else { card.classList.remove('selected-ai-card'); btn.classList.remove('selected'); btn.textContent = `ì´ AIë¡œ ìµœì¢… ì„ íƒ`; }
                    }
                });
                const legacyUrlCell = document.getElementById(`legacy-video-url-${shot.id}`); if (legacyUrlCell) legacyUrlCell.textContent = shot.video_design.video_url || '-';
                const legacyAiToolCell = document.getElementById(`legacy-ai-tool-${shot.id}`); if (legacyAiToolCell) legacyAiToolCell.textContent = aiType || '-';
                showMessage(`${aiType}ì´(ê°€) ìµœì¢… ì˜ìƒìœ¼ë¡œ ì„ íƒë¨.`, 'success');
            } catch (e) { console.error("ìµœì¢… AI ì„ íƒ ì˜¤ë¥˜:", e); showMessage('ìµœì¢… AI ì„ íƒ ì˜¤ë¥˜', 'error');}
        }

        // ìƒ· ì˜¤ë””ì˜¤ íƒ­ ìƒì„±
        // ìƒ· ì˜¤ë””ì˜¤ íƒ­ ìƒì„± (ëŒ€í™”/ë‚˜ë ˆì´ì…˜ ìƒì„¸ ë° TTSìš© ë¶„ë¦¬)
        function createShotAudioTab(shot) {
            console.log('ğŸ”Š createShotAudioTab ì‹œì‘ (TTSìš© ë¶„ë¦¬)');
            try {
                const audioUrls = shot.content?.audio_urls || {};
                const dialogue = shot.content?.dialogue || {};
                const narration = shot.content?.narration || '';
                // audio_promptsëŠ” ì´ì œ TTSìš© ìˆœìˆ˜ í…ìŠ¤íŠ¸ë¥¼ contentì—ì„œ ê°€ì ¸ì˜¤ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” ì°¸ê³ ìš©ìœ¼ë¡œë§Œ í™•ì¸
                const audioPrompts = shot.audio_prompts || {};

                // --- ëŒ€í™” ì˜¤ë””ì˜¤ ì„¹ì…˜ ---
                let dialogueContentHtml = '';
                if (Object.keys(dialogue).length > 0) {
                    dialogueContentHtml = Object.entries(dialogue).map(([charId, dia]) => {
                        return `<strong>${charId}:</strong> ${dia.text || ''} <em>(ê°ì •: ${dia.emotion || '-'}, ìŠ¤íƒ€ì¼: ${dia.voice_style || '-'})</em>`;
                    }).join('<br>');
                } else {
                    dialogueContentHtml = 'ëŒ€í™” ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.';
                }

                const fullDialogueForCopy = Object.entries(dialogue).map(([charId, dia]) => {
                    return `${charId}: ${dia.text || ''} (ê°ì •: ${dia.emotion || '-'}, ìŠ¤íƒ€ì¼: ${dia.voice_style || '-'})`;
                }).join('\\n').replace(/'/g, "&#39;");

                let characterOptionsHtml = Object.keys(dialogue).map(charId => `<option value="${charId}">${charId}</option>`).join('');
                let initialTtsDialogueText = '';
                if (Object.keys(dialogue).length > 0) {
                    const firstCharId = Object.keys(dialogue)[0];
                    initialTtsDialogueText = dialogue[firstCharId]?.text || '';
                }

                const dialogueHtml = `
                    <div class="audio-section">
                        <h4>ğŸ¤ ëŒ€í™” ì˜¤ë””ì˜¤</h4>
                        <div class="audio-player-area">
                            ${audioUrls.dialogue ? `<audio controls style="width: 100%;" src="${audioUrls.dialogue}"></audio>` : `<div style="color: #999;">ëŒ€í™” ì˜¤ë””ì˜¤ URL ì…ë ¥</div>`}
                        </div>
                        <div class="form-group">
                            <label class="form-label">ëŒ€í™” ì˜¤ë””ì˜¤ URL</label>
                            <input type="text" class="form-input" value="${audioUrls.dialogue || ''}" placeholder="https://example.com/dialogue.mp3" onchange="updateAudioUrl('${shot.id}', 'dialogue', this.value)">
                        </div>

                        <div class="info-section" style="padding:15px; background-color:#fcfcfc;">
                            <h5>ëŒ€í™” ë‚´ìš© (ê²€í† ìš©)</h5>
                            <div class="audio-content-display" style="min-height:80px; white-space:normal;">${dialogueContentHtml}</div>
                            <button class="copy-btn btn-small" style="margin-top:5px;" onclick="copyToClipboard('${fullDialogueForCopy}').then(ok => ok && showMessage('ì „ì²´ ëŒ€í™” ë‚´ìš© ë³µì‚¬ë¨.', 'success'))">ì „ì²´ ëŒ€í™” ë‚´ìš© ë³µì‚¬</button>
                        </div>

                        <div class="info-section" style="padding:15px; background-color:#fcfcfc; margin-top:15px;">
                            <h5>TTSìš© ìºë¦­í„° ëŒ€ì‚¬ (ë”ë¹™ìš©)</h5>
                            <div class="form-group">
                                <label for="tts-char-select-${shot.id}" class="form-label">ìºë¦­í„° ì„ íƒ:</label>
                                <select id="tts-char-select-${shot.id}" class="form-select" onchange="updateTtsDialogueDisplay('${shot.id}')" ${Object.keys(dialogue).length === 0 ? 'disabled' : ''}>
                                    ${characterOptionsHtml || '<option value="">ì„ íƒí•  ìºë¦­í„° ì—†ìŒ</option>'}
                                </select>
                            </div>
                            <div class="audio-content-display" id="tts-dialogue-text-${shot.id}" style="min-height:60px;">${initialTtsDialogueText.replace(/\n/g, "<br>")}</div>
                            <button class="copy-btn btn-small" style="margin-top:5px;" onclick="copyTtsDialogue('${shot.id}')">ì„ íƒ ìºë¦­í„° ëŒ€ì‚¬ ë³µì‚¬</button>
                            ${audioPrompts.dialogue?.prompt ? `<div class="prompt-text" style="margin-top:10px; font-size:0.8em; background-color:#eee; padding:5px;">ì°¸ê³ ìš© ê¸°ì¡´ í”„ë¡¬í”„íŠ¸: ${audioPrompts.dialogue.prompt}</div>` : ''}
                            ${audioPrompts.dialogue?.settings ? `<div style="margin-top:5px; font-size:0.8em; color:#555;">ì°¸ê³ ìš© ê¸°ì¡´ ì„¤ì •: ${JSON.stringify(audioPrompts.dialogue.settings)}</div>` : ''}
                        </div>
                    </div>
                `;

                // --- ë‚˜ë ˆì´ì…˜ ì˜¤ë””ì˜¤ ì„¹ì…˜ ---
                const narrationForCopy = (narration || '').replace(/'/g, "&#39;").replace(/\n/g, "\\n");
                // TTSìš© ë‚˜ë ˆì´ì…˜ í…ìŠ¤íŠ¸ëŠ” shot.content.narrationì„ ìš°ì„  ì‚¬ìš©. ì—†ë‹¤ë©´ audio_prompts.narration.prompt ì‚¬ìš©.
                const ttsNarrationSourceText = narration || audioPrompts.narration?.prompt || 'ë‚˜ë ˆì´ì…˜ ë‚´ìš© ë˜ëŠ” í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.';
                const ttsNarrationForCopy = (ttsNarrationSourceText).replace(/'/g, "&#39;").replace(/\n/g, "\\n");


                const narrationHtml = `
                    <div class="audio-section">
                        <h4> narrï¸ ë‚˜ë ˆì´ì…˜ ì˜¤ë””ì˜¤</h4>
                        <div class="audio-player-area">
                            ${audioUrls.narration ? `<audio controls style="width: 100%;" src="${audioUrls.narration}"></audio>` : `<div style="color: #999;">ë‚˜ë ˆì´ì…˜ ì˜¤ë””ì˜¤ URL ì…ë ¥</div>`}
                        </div>
                        <div class="form-group">
                            <label class="form-label">ë‚˜ë ˆì´ì…˜ ì˜¤ë””ì˜¤ URL</label>
                            <input type="text" class="form-input" value="${audioUrls.narration || ''}" placeholder="https://example.com/narration.mp3" onchange="updateAudioUrl('${shot.id}', 'narration', this.value)">
                        </div>

                        <div class="info-section" style="padding:15px; background-color:#fcfcfc;">
                            <h5>ë‚˜ë ˆì´ì…˜ ë‚´ìš© (ê²€í† ìš©)</h5>
                            <div class="audio-content-display" style="min-height:60px;">${narration || 'ë‚˜ë ˆì´ì…˜ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
                            <button class="copy-btn btn-small" style="margin-top:5px;" onclick="copyToClipboard('${narrationForCopy}').then(ok => ok && showMessage('ë‚˜ë ˆì´ì…˜ ë‚´ìš© ë³µì‚¬ë¨.', 'success'))">ë‚˜ë ˆì´ì…˜ ë‚´ìš© ë³µì‚¬</button>
                        </div>

                        <div class="info-section" style="padding:15px; background-color:#fcfcfc; margin-top:15px;">
                            <h5>TTSìš© ë‚˜ë ˆì´ì…˜ ëŒ€ì‚¬ (ë”ë¹™ìš©)</h5>
                            <div class="audio-content-display" id="tts-narration-text-${shot.id}" style="min-height:60px;">${ttsNarrationSourceText.replace(/\n/g, "<br>")}</div>
                            <button class="copy-btn btn-small" style="margin-top:5px;" onclick="copyToClipboard('${ttsNarrationForCopy}').then(ok => ok && showMessage('TTSìš© ë‚˜ë ˆì´ì…˜ ëŒ€ì‚¬ ë³µì‚¬ë¨.', 'success'))">TTSìš© ë‚˜ë ˆì´ì…˜ ëŒ€ì‚¬ ë³µì‚¬</button>
                            ${audioPrompts.narration?.prompt && audioPrompts.narration.prompt !== ttsNarrationSourceText ? `<div class="prompt-text" style="margin-top:10px; font-size:0.8em; background-color:#eee; padding:5px;">ì°¸ê³ ìš© ê¸°ì¡´ í”„ë¡¬í”„íŠ¸: ${audioPrompts.narration.prompt}</div>` : ''}
                            ${audioPrompts.narration?.settings ? `<div style="margin-top:5px; font-size:0.8em; color:#555;">ì°¸ê³ ìš© ê¸°ì¡´ ì„¤ì •: ${JSON.stringify(audioPrompts.narration.settings)}</div>` : ''}
                        </div>
                    </div>
                `;

                // --- ìŒí–¥ íš¨ê³¼ ì„¹ì…˜ (ê¸°ì¡´ê³¼ ìœ ì‚¬í•˜ê²Œ ìœ ì§€) ---
                const soundEffects = shot.content?.sound_effects || '';
                const soundEffectsForCopy = (soundEffects || '').replace(/'/g, "&#39;").replace(/\n/g, "\\n");
                const sfxPromptText = audioPrompts.sound_effects?.prompt || 'í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.'; // ë³€ìˆ˜ ì´ë¦„ ëª…í™•íˆ
                const sfxPromptForCopy = (sfxPromptText).replace(/'/g, "&#39;").replace(/\n/g, "\\n");

                const soundEffectsHtml = `
                    <div class="audio-section">
                        <h4>ğŸ”Š ìŒí–¥ íš¨ê³¼</h4>
                        <div class="audio-player-area">
                            ${audioUrls.sound_effects ? `<audio controls style="width: 100%;" src="${audioUrls.sound_effects}"></audio>` : `<div style="color: #999;">ìŒí–¥ íš¨ê³¼ URL ì…ë ¥</div>`}
                        </div>
                        <div class="form-group">
                            <label class="form-label">ìŒí–¥ íš¨ê³¼ URL</label>
                            <input type="text" class="form-input" value="${audioUrls.sound_effects || ''}" placeholder="https://example.com/sound.mp3" onchange="updateAudioUrl('${shot.id}', 'sound_effects', this.value)">
                        </div>
                        ${soundEffects ? `
                        <div class="form-group">
                            <label class="form-label">ìŒí–¥ íš¨ê³¼ ì„¤ëª…</label>
                            <div class="audio-content-display">${soundEffects}</div>
                            <button class="copy-btn btn-small" style="margin-top:5px;" onclick="copyToClipboard('${soundEffectsForCopy}').then(ok => ok && showMessage('ìŒí–¥ ì„¤ëª… ë³µì‚¬ë¨.', 'success'))">ìŒí–¥ ì„¤ëª… ë³µì‚¬</button>
                        </div>` : ''}
                        ${audioPrompts.sound_effects ? `
                        <div class="prompt-container">
                            <div class="prompt-header"><span class="prompt-title">ìŒí–¥ íš¨ê³¼ ìƒì„± í”„ë¡¬í”„íŠ¸</span>
                                <button class="copy-btn" onclick="copyToClipboard('${sfxPromptForCopy}').then(ok => ok && showMessage('ìŒí–¥ í”„ë¡¬í”„íŠ¸ ë³µì‚¬ë¨.', 'success'))">ë³µì‚¬</button>
                            </div>
                            <div class="prompt-text">${sfxPromptText}</div>
                            ${audioPrompts.sound_effects.settings ? `<div style="margin-top: 8px; font-size: 0.85rem; color: #666;">ì„¤ì •: ${JSON.stringify(audioPrompts.sound_effects.settings)}</div>` : ''}
                        </div>` : ''}
                    </div>`;

                console.log('âœ… createShotAudioTab ì™„ë£Œ');
                return `${dialogueHtml}${narrationHtml}${soundEffectsHtml}`;
            } catch (error) {
                console.error('âŒ createShotAudioTab ì˜¤ë¥˜:', error);
                return `<div class="info-section"><h3>ì˜¤ë””ì˜¤ íƒ­ ë¡œë“œ ì˜¤ë¥˜</h3><p>ì˜¤ë¥˜: ${error.message}</p></div>`;
            }
        }

        // TTSìš© ëŒ€í™” í‘œì‹œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateTtsDialogueDisplay(shotId) {
            try {
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
                const selectElement = document.getElementById(`tts-char-select-${shotId}`);
                const displayElement = document.getElementById(`tts-dialogue-text-${shotId}`);

                if (shot && selectElement && displayElement && shot.content && shot.content.dialogue) {
                    const selectedCharId = selectElement.value;
                    const dialogueText = shot.content.dialogue[selectedCharId]?.text || 'ì„ íƒëœ ìºë¦­í„°ì˜ ëŒ€ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.';
                    displayElement.innerHTML = dialogueText.replace(/\n/g, "<br>"); // í‘œì‹œí•  ë•ŒëŠ” <br>ë¡œ
                }
            } catch (error) {
                console.error("TTS ëŒ€í™” í‘œì‹œ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", error);
            }
        }

        // TTSìš© ì„ íƒ ìºë¦­í„° ëŒ€ì‚¬ ë³µì‚¬ í•¨ìˆ˜
        function copyTtsDialogue(shotId) {
            try {
                // í‘œì‹œëœ ë‚´ìš©(innerHTML)ì´ ì•„ë‹Œ, ì›ë³¸ ë°ì´í„°ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì™€ ë³µì‚¬
                const selectElement = document.getElementById(`tts-char-select-${shotId}`);
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);

                if (selectElement && shot && shot.content && shot.content.dialogue) {
                     const selectedCharId = selectElement.value;
                     const dialogueText = shot.content.dialogue[selectedCharId]?.text || ''; // ì›ë³¸ í…ìŠ¤íŠ¸
                     if (dialogueText.trim() === '') {
                        showMessage('ë³µì‚¬í•  ëŒ€ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                        return;
                     }
                     // ë³µì‚¬í•  ë•ŒëŠ” \nì„ ê·¸ëŒ€ë¡œ ìœ ì§€ (í´ë¦½ë³´ë“œ APIê°€ OSì— ë§ê²Œ ì²˜ë¦¬)
                     copyToClipboard(dialogueText).then(ok => ok && showMessage('ì„ íƒëœ ìºë¦­í„°ì˜ TTSìš© ëŒ€ì‚¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success'));
                } else {
                     showMessage('ë³µì‚¬í•  ëŒ€ì‚¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                }
            } catch (error) {
                console.error("TTS ëŒ€í™” ë³µì‚¬ ì˜¤ë¥˜:", error);
                showMessage('TTS ëŒ€ì‚¬ ë³µì‚¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
            }
        }


        // ìƒ· ìŒì•… íƒ­ ìƒì„±
        // ìƒ· ìŒì•… íƒ­ ìƒì„± (í”„ë¡œì íŠ¸ ì „ì²´ ìŒì•… ì •ë³´ + ìƒ·ë³„ ë©”ëª¨)
        function createShotMusicTab(shot) {
            console.log('ğŸµ createShotMusicTab ì‹œì‘ (í”„ë¡œì íŠ¸ ìŒì•… ì •ë³´ + ìƒ·ë³„ ë©”ëª¨)');
            try {
                // í”„ë¡œì íŠ¸ ë ˆë²¨ì˜ ìŒì•… ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const projectMusicPrompts = currentData.film_metadata?.project_music_prompts || {};
                const projectMusicUrls = currentData.film_metadata?.project_music_urls || {};

                // ìƒ· ë ˆë²¨ì˜ ìŒì•… ë©”ëª¨ ê°€ì ¸ì˜¤ê¸°
                const shotMusicMemo = shot.music_memo || '';

                const createProjectOstSection = (ostType, title, emoji) => {
                    const ostPromptData = projectMusicPrompts[ostType];
                    const ostUrl = projectMusicUrls[ostType] || '';

                    if (!ostPromptData) {
                        return `<div class="music-ost-section"><h4>${emoji} ${title} (í”„ë¡œì íŠ¸)</h4><div style="text-align:center;padding:20px;color:#999;">${title} í”„ë¡¬í”„íŠ¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. (film_metadata.project_music_prompts)</div></div>`;
                    }

                    const stylePrompt = ostPromptData.style_prompt || 'ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.';
                    const lyricsPrompt = ostPromptData.lyrics_structure_prompt || 'ê°€ì‚¬&êµ¬ì¡° í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.';
                    const stylePromptForCopy = stylePrompt.replace(/'/g, "&#39;").replace(/\n/g, "\\n");
                    const lyricsPromptForCopy = lyricsPrompt.replace(/'/g, "&#39;").replace(/\n/g, "\\n");

                    return `
                        <div class="music-ost-section">
                            <h4>${emoji} ${title} (í”„ë¡œì íŠ¸ ì „ì²´)</h4>
                            <div class="audio-player-area" style="margin-bottom:15px;">
                                ${ostUrl ? `<audio controls style="width: 100%;" src="${ostUrl}"></audio>` : `<div style="color: #999;">${title} URL ì…ë ¥ (í”„ë¡œì íŠ¸ ë ˆë²¨)</div>`}
                            </div>
                            <div class="form-group">
                                <label class="form-label">${title} URL (í”„ë¡œì íŠ¸ ì „ì²´)</label>
                                <input type="text" class="form-input" value="${ostUrl}" 
                                       placeholder="https://example.com/${ostType}.mp3" 
                                       onchange="updateProjectMusicUrl('${ostType}', this.value)">
                            </div>
                            <div class="ost-prompt-grid">
                                <div class="ost-prompt-item">
                                    <div class="prompt-title">ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸</div>
                                    <div class="prompt-text">${stylePrompt}</div>
                                    <button class="copy-btn btn-small" onclick="copyToClipboard('${stylePromptForCopy}').then(ok => ok && showMessage('${title} ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸ ë³µì‚¬ë¨.', 'success'))">ë³µì‚¬</button>
                                </div>
                                <div class="ost-prompt-item">
                                    <div class="prompt-title">ê°€ì‚¬ & êµ¬ì¡° í”„ë¡¬í”„íŠ¸</div>
                                    <div class="prompt-text">${lyricsPrompt}</div>
                                    <button class="copy-btn btn-small" onclick="copyToClipboard('${lyricsPromptForCopy}').then(ok => ok && showMessage('${title} ê°€ì‚¬/êµ¬ì¡° í”„ë¡¬í”„íŠ¸ ë³µì‚¬ë¨.', 'success'))">ë³µì‚¬</button>
                                </div>
                            </div>
                        </div>`;
                };

                const mainOstHtml = createProjectOstSection('main_ost', 'ë©”ì¸ OST', 'ğŸ¼');
                const subOst1Html = createProjectOstSection('sub_ost_1', 'ì„œë¸Œ OST 1', 'ğŸµ');
                const subOst2Html = createProjectOstSection('sub_ost_2', 'ì„œë¸Œ OST 2', 'ğŸ¶');
                
                const shotMusicMemoHtml = `
                    <div class="info-section">
                        <h3>ğŸ“ ì´ ìƒ·ì˜ ìŒì•… ê´€ë ¨ ë©”ëª¨</h3>
                         <div class="form-group">
                            <label class="form-label">ìƒ· ìŒì•… ì ìš© ë…¸íŠ¸ (ì˜ˆ: ì´ ìƒ·ë¶€í„° ë©”ì¸ í…Œë§ˆ ì‚¬ìš©):</label>
                            <textarea class="form-textarea" 
                                      style="min-height: 100px;"
                                      placeholder="ì´ ìƒ·ì— ì ìš©ë  ìŒì•…ì— ëŒ€í•œ êµ¬ì²´ì ì¸ ì§€ì‹œì‚¬í•­ì´ë‚˜ ì•„ì´ë””ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                                      onchange="updateShotMusicMemo('${shot.id}', this.value)">${shotMusicMemo}</textarea>
                            <small style="color:#777; font-size:0.85em;">ì´ ë©”ëª¨ëŠ” í˜„ì¬ ì„ íƒëœ ìƒ·(${shot.id})ì—ë§Œ í•´ë‹¹ë©ë‹ˆë‹¤.</small>
                        </div>
                    </div>`;

                return `${mainOstHtml}${subOst1Html}${subOst2Html}${shotMusicMemoHtml}`;
            } catch (error) {
                console.error('âŒ createShotMusicTab ì˜¤ë¥˜:', error);
                return `<div class="info-section"><h3>ìŒì•… íƒ­ ë¡œë“œ ì˜¤ë¥˜</h3><p>ì˜¤ë¥˜ ë©”ì‹œì§€: ${error.message}</p></div>`;
            }
        }

        // í”„ë¡œì íŠ¸ ë ˆë²¨ ìŒì•… URL ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateProjectMusicUrl(ostType, newUrl) {
            try {
                if (!currentData.film_metadata) currentData.film_metadata = {};
                if (!currentData.film_metadata.project_music_urls) currentData.film_metadata.project_music_urls = {};
                
                currentData.film_metadata.project_music_urls[ostType] = newUrl;
                saveDataToLocalStorage();
                
                // í˜„ì¬ íƒ­ì´ ìŒì•… íƒ­ì´ë¼ë©´ UI ì¦‰ì‹œ ê°±ì‹  (í”Œë ˆì´ì–´ ë¶€ë¶„)
                const activeTabId = document.querySelector('.tab-button.active')?.getAttribute('onclick').match(/'([^']+)'/)[1];
                if (activeTabId === 'music' && selectedType === 'shot' && selectedId) {
                    showShotContent(selectedId); // í˜„ì¬ ìƒ· ì½˜í…ì¸ ë¥¼ ë‹¤ì‹œ ê·¸ë ¤ì„œ ìŒì•… íƒ­ ì—…ë°ì´íŠ¸
                    setTimeout(() => switchTab('music', selectedId), 0); // ìŒì•… íƒ­ í™œì„±í™” ìœ ì§€
                }
                showMessage(`í”„ë¡œì íŠ¸ ${ostType} URLì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            } catch (error) {
                console.error("í”„ë¡œì íŠ¸ ìŒì•… URL ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", error);
                showMessage('í”„ë¡œì íŠ¸ ìŒì•… URL ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
            }
        }

        // ìƒ·ë³„ ìŒì•… ë©”ëª¨ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateShotMusicMemo(shotId, memo) {
            try {
                const shot = currentData.breakdown_data.shots.find(s => s.id === shotId);
                if (!shot) return showMessage('ìƒ· ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                
                shot.music_memo = memo;
                saveDataToLocalStorage();
                showMessage(`ìƒ· ${shotId}ì˜ ìŒì•… ë©”ëª¨ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            } catch (error) {
                console.error("ìƒ· ìŒì•… ë©”ëª¨ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", error);
                showMessage('ìƒ· ìŒì•… ë©”ëª¨ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
            }
        }
        
        // ë©”ëª¨ ê´€ë¦¬ í•¨ìˆ˜ë“¤
        function getShotMemo(shotId){try{return JSON.parse(localStorage.getItem('shotMemos')||'{}')[shotId]||''}catch(e){return''}}
        function updateShotMemo(shotId,memo){try{const m=JSON.parse(localStorage.getItem('shotMemos')||'{}');m[shotId]=memo;localStorage.setItem('shotMemos',JSON.stringify(m))}catch(e){showMessage('ë©”ëª¨ ì €ì¥ ì‹¤íŒ¨','error')}}
        
        // ì˜¤ë””ì˜¤ URL ì—…ë°ì´íŠ¸
        function updateAudioUrl(shotId,audioType,newUrl){try{const s=currentData.breakdown_data.shots.find(sh=>sh.id===shotId);if(!s)return;if(!s.content)s.content={};if(!s.content.audio_urls)s.content.audio_urls={};s.content.audio_urls[audioType]=newUrl;saveDataToLocalStorage();const tab=document.querySelector('.tab-button.active')?.getAttribute('onclick').match(/'([^']+)'/)[1];showShotContent(shotId);if(tab)setTimeout(()=>switchTab(tab,shotId),0);showMessage(`${audioType} ì˜¤ë””ì˜¤ URL ì—…ë°ì´íŠ¸`,'success')}catch(e){showMessage('ì˜¤ë””ì˜¤ URL ì—…ë°ì´íŠ¸ ì‹¤íŒ¨','error')}}
        function updateCurrentMusicDescription(shotId,description){try{const s=currentData.breakdown_data.shots.find(sh=>sh.id===shotId);if(!s)return;if(!s.content)s.content={music:''};s.content.music=description;saveDataToLocalStorage();showMessage('ìŒì•… ì„¤ëª… ì—…ë°ì´íŠ¸','success')}catch(e){showMessage('ìŒì•… ì„¤ëª… ì—…ë°ì´íŠ¸ ì‹¤íŒ¨','error')}}

        // ì»¨ì…‰ì•„íŠ¸ ë³´ê¸°
        function openConceptArt(){try{window.open(`${getProjectName().replace(/ /g,'')}_ConceptArt.html`,'_blank')}catch(e){showMessage('ì»¨ì…‰ì•„íŠ¸ ì—´ê¸° ì‹¤íŒ¨','warning')}}

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            document.getElementById('import-btn')?.addEventListener('click', importData);
            document.getElementById('export-btn')?.addEventListener('click', exportData);
            document.getElementById('concept-art-btn')?.addEventListener('click', openConceptArt);
            document.getElementById('expand-all-btn')?.addEventListener('click', expandAll);
            document.getElementById('collapse-all-btn')?.addEventListener('click', collapseAll);
            document.getElementById('search-input')?.addEventListener('input', searchNavigation);
            document.getElementById('file-input')?.addEventListener('change', handleFileSelect);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ¬ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ, ì´ˆê¸°í™” ì‹œì‘...');
            try {
                setupEventListeners();
                await loadData(); 
                updateUI();       
                console.log('âœ… ì´ˆê¸°í™” ì™„ë£Œ');
            } catch (error) { console.error('âŒ ì´ˆê¸°í™” ì˜¤ë¥˜:', error); showMessage(`ì´ˆê¸°í™” ì˜¤ë¥˜: ${error.message}`, 'error'); }
        });
        
        console.log('âœ… JavaScript ë¡œë”© ì™„ë£Œ');
    </script>
</body>
</html>
